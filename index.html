<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="description" content="TRAci - Clinical Innovation Platform for Pneumology">
    <title>TRAci | Clinical Innovation Platform</title>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* ===== VARIABLES ===== */
        :root {
            /* Professional Color Palette */
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            
            --secondary-50: #f8fafc;
            --secondary-100: #f1f5f9;
            --secondary-200: #e2e8f0;
            --secondary-300: #cbd5e1;
            --secondary-400: #94a3b8;
            --secondary-500: #64748b;
            --secondary-600: #475569;
            --secondary-700: #334155;
            --secondary-800: #1e293b;
            --secondary-900: #0f172a;
            
            --success-50: #f0fdf4;
            --success-100: #dcfce7;
            --success-200: #bbf7d0;
            --success-300: #86efac;
            --success-400: #4ade80;
            --success-500: #22c55e;
            --success-600: #16a34a;
            --success-700: #15803d;
            --success-800: #166534;
            --success-900: #14532d;
            
            --warning-50: #fffbeb;
            --warning-100: #fef3c7;
            --warning-200: #fde68a;
            --warning-300: #fcd34d;
            --warning-400: #fbbf24;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --warning-700: #b45309;
            --warning-800: #92400e;
            --warning-900: #78350f;
            
            --danger-50: #fef2f2;
            --danger-100: #fee2e2;
            --danger-200: #fecaca;
            --danger-300: #fca5a5;
            --danger-400: #f87171;
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            --danger-700: #b91c1c;
            --danger-800: #991b1b;
            --danger-900: #7f1d1d;
            
            --surface-0: #ffffff;
            --surface-50: #f8fafc;
            --surface-100: #f1f5f9;
            --surface-200: #e2e8f0;
            --surface-300: #cbd5e1;
            --surface-400: #94a3b8;
            
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            
            --border-light: #e2e8f0;
            --border: #cbd5e1;
            --border-dark: #94a3b8;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-12: 3rem;
            --space-16: 4rem;
        }

        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            position: relative;
        }

        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .visually-hidden { 
            position: absolute !important;
            height: 1px; width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
        }
        
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: var(--space-1); }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        .gap-6 { gap: var(--space-6); }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        .p-3 { padding: var(--space-3); }
        .p-4 { padding: var(--space-4); }
        .p-6 { padding: var(--space-6); }
        .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
        .py-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
        .py-3 { padding-top: var(--space-3); padding-bottom: var(--space-3); }
        .py-4 { padding-top: var(--space-4); padding-bottom: var(--space-4); }
        
        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-6 { margin-top: var(--space-6); }
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }
        
        .rounded { border-radius: var(--radius); }
        .rounded-md { border-radius: var(--radius-md); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-full { border-radius: 9999px; }
        
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow { box-shadow: var(--shadow); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        
        .border { border: 1px solid var(--border); }
        .border-t { border-top: 1px solid var(--border); }
        .border-b { border-bottom: 1px solid var(--border); }
        
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-tertiary { color: var(--text-tertiary); }
        .text-success { color: var(--success-600); }
        .text-warning { color: var(--warning-600); }
        .text-danger { color: var(--danger-600); }
        .text-primary-600 { color: var(--primary-600); }
        
        .bg-surface { background: var(--surface-0); }
        .bg-surface-50 { background: var(--surface-50); }
        .bg-surface-100 { background: var(--surface-100); }
        .bg-primary-50 { background: var(--primary-50); }
        .bg-primary-100 { background: var(--primary-100); }
        .bg-success-50 { background: var(--success-50); }
        .bg-warning-50 { background: var(--warning-50); }
        .bg-danger-50 { background: var(--danger-50); }
        
        /* ===== LAYOUT ===== */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-4);
        }
        
        @media (min-width: 640px) {
            .container {
                padding: 0 var(--space-6);
            }
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            font-family: var(--font-sans);
            font-size: 0.875rem;
            font-weight: 600;
            line-height: 1;
            border-radius: var(--radius);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            white-space: nowrap;
            user-select: none;
            touch-action: manipulation;
            min-height: 2.75rem;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-700);
            border-color: var(--primary-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .btn-secondary {
            background: var(--surface-100);
            color: var(--text-secondary);
            border-color: var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--surface-200);
            border-color: var(--border-dark);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--text-secondary);
            border-color: var(--border);
        }
        
        .btn-outline:hover:not(:disabled) {
            background: var(--surface-50);
            border-color: var(--border-dark);
        }
        
        .btn-success {
            background: var(--success-600);
            color: white;
            border-color: var(--success-600);
        }
        
        .btn-danger {
            background: var(--danger-600);
            color: white;
            border-color: var(--danger-600);
        }
        
        .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: 0.8125rem;
            min-height: 2.25rem;
        }
        
        .btn-lg {
            padding: var(--space-4) var(--space-6);
            font-size: 1rem;
            min-height: 3rem;
        }
        
        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: var(--space-2);
        }
        
        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: var(--space-4);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .form-control {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-family: var(--font-sans);
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--text-primary);
            background: var(--surface-0);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .form-control.is-invalid {
            border-color: var(--danger-500);
        }
        
        .form-control.is-invalid:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        .form-text {
            display: block;
            margin-top: var(--space-1);
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        
        .form-text.is-invalid {
            color: var(--danger-600);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            cursor: pointer;
        }
        
        /* ===== ALERTS ===== */
        .alert {
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius);
            border: 1px solid transparent;
            margin-bottom: var(--space-4);
        }
        
        .alert-success {
            background: var(--success-50);
            border-color: var(--success-200);
            color: var(--success-700);
        }
        
        .alert-warning {
            background: var(--warning-50);
            border-color: var(--warning-200);
            color: var(--warning-700);
        }
        
        .alert-danger {
            background: var(--danger-50);
            border-color: var(--danger-200);
            color: var(--danger-700);
        }
        
        .alert-info {
            background: var(--primary-50);
            border-color: var(--primary-200);
            color: var(--primary-700);
        }
        
        /* ===== BADGES ===== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            border-radius: var(--radius-full);
            border: 1px solid transparent;
        }
        
        .badge-primary {
            background: var(--primary-100);
            border-color: var(--primary-200);
            color: var(--primary-700);
        }
        
        .badge-success {
            background: var(--success-100);
            border-color: var(--success-200);
            color: var(--success-700);
        }
        
        .badge-warning {
            background: var(--warning-100);
            border-color: var(--warning-200);
            color: var(--warning-700);
        }
        
        .badge-danger {
            background: var(--danger-100);
            border-color: var(--danger-200);
            color: var(--danger-700);
        }
        
        .badge-secondary {
            background: var(--surface-200);
            border-color: var(--surface-300);
            color: var(--text-secondary);
        }
        
        /* ===== CARD ===== */
        .card {
            background: var(--surface-0);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border);
            background: var(--surface-50);
        }
        
        .card-body {
            padding: var(--space-4);
        }
        
        .card-footer {
            padding: var(--space-4);
            border-top: 1px solid var(--border);
            background: var(--surface-50);
        }
        
        /* ===== NAVBAR ===== */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--surface-0);
            border-bottom: 1px solid var(--border);
            padding: var(--space-3) 0;
        }
        
        .navbar-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            text-decoration: none;
            color: var(--text-primary);
        }
        
        .navbar-logo {
            width: 2.5rem;
            height: 2.5rem;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .navbar-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-700);
        }
        
        .navbar-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 16rem;
            background: var(--surface-0);
            border-right: 1px solid var(--border);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border);
        }
        
        .sidebar-nav {
            padding: var(--space-4);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            margin-bottom: var(--space-1);
        }
        
        .nav-item:hover {
            background: var(--surface-50);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--primary-50);
            color: var(--primary-700);
            font-weight: 500;
        }
        
        .nav-item .badge {
            margin-left: auto;
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            min-height: calc(100vh - 4.5rem);
            padding: var(--space-6) 0;
        }
        
        .page-header {
            margin-bottom: var(--space-6);
        }
        
        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }
        
        .page-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        
        /* ===== STATS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        
        .stat-card {
            background: var(--surface-0);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: var(--space-4);
        }
        
        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-3);
            font-size: 1.5rem;
        }
        
        .stat-icon-primary {
            background: var(--primary-50);
            color: var(--primary-600);
        }
        
        .stat-icon-success {
            background: var(--success-50);
            color: var(--success-600);
        }
        
        .stat-icon-warning {
            background: var(--warning-50);
            color: var(--warning-600);
        }
        
        .stat-icon-secondary {
            background: var(--surface-100);
            color: var(--text-secondary);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: var(--space-1);
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* ===== TABLE ===== */
        .table-container {
            background: var(--surface-0);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--surface-50);
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .table td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tr:hover {
            background: var(--surface-50);
        }
        
        /* ===== MODAL ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: var(--space-4);
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: var(--surface-0);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 28rem;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { 
                transform: translateY(1rem);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius);
            transition: background-color 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--surface-100);
        }
        
        .modal-body {
            padding: var(--space-4);
        }
        
        .modal-footer {
            padding: var(--space-4);
            border-top: 1px solid var(--border);
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
        }
        
        /* ===== LOADING ===== */
        .loading {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }
        
        .loading-spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--border);
            border-top-color: var(--primary-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== OFFLINE BANNER ===== */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--warning-600);
            color: white;
            text-align: center;
            padding: var(--space-3);
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .offline-banner.active {
            transform: translateY(0);
        }
        
        /* ===== SESSION TIMEOUT ===== */
        .session-timeout-modal .modal-content {
            max-width: 24rem;
        }
        
        .session-timeout-countdown {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: var(--danger-600);
            margin: var(--space-4) 0;
        }
        
        /* ===== LOGIN PAGE ===== */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%);
            padding: var(--space-4);
        }
        
        .login-card {
            background: var(--surface-0);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 28rem;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }
        
        .login-header {
            padding: var(--space-8) var(--space-6) var(--space-6);
            text-align: center;
            background: linear-gradient(to bottom, var(--primary-50), transparent);
        }
        
        .login-logo {
            width: 4rem;
            height: 4rem;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 auto var(--space-4);
        }
        
        .login-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }
        
        .login-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .login-body {
            padding: var(--space-6);
        }
        
        .login-footer {
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--border);
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-tertiary);
        }
        
        /* ===== DASHBOARD ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-4);
        }
        
        /* ===== MOBILE MENU TOGGLE ===== */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            padding: var(--space-2);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius);
        }
        
        .mobile-menu-toggle:hover {
            background: var(--surface-100);
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .navbar-actions {
                display: none;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .table {
                display: block;
                overflow-x: auto;
            }
            
            .modal-content {
                max-height: 100vh;
                border-radius: 0;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
        }
        
        @media (min-width: 769px) {
            .sidebar-overlay {
                display: none;
            }
        }
        
        /* ===== SIDEBAR OVERLAY ===== */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        /* ===== ACTIVITY TIMELINE ===== */
        .activity-timeline {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        
        .activity-item {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--surface-0);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .activity-time {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            white-space: nowrap;
            margin-top: var(--space-1);
        }
        
        /* ===== GRID VIEW ===== */
        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-4);
        }
        
        /* ===== PASSWORD STRENGTH ===== */
        .password-strength {
            margin-top: var(--space-2);
        }
        
        .strength-meter {
            height: 4px;
            background: var(--surface-200);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: var(--space-2);
        }
        
        .strength-fill {
            height: 100%;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        
        .strength-text {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        
        /* ===== TOAST ===== */
        .toast-container {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .toast {
            padding: var(--space-3) var(--space-4);
            background: var(--surface-0);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            animation: slideIn 0.3s ease;
            max-width: 24rem;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-icon {
            font-size: 1.25rem;
        }
        
        .toast-success .toast-icon {
            color: var(--success-600);
        }
        
        .toast-warning .toast-icon {
            color: var(--warning-600);
        }
        
        .toast-danger .toast-icon {
            color: var(--danger-600);
        }
        
        .toast-info .toast-icon {
            color: var(--primary-600);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius);
        }
        
        .toast-close:hover {
            background: var(--surface-100);
        }
    </style>
</head>
<body>
    <!-- Offline Banner -->
    <div id="offlineBanner" class="offline-banner">
        <i class="mdi mdi-wifi-off"></i>
        You are currently offline. Some features may be limited.
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">T</div>
                <h1 class="login-title">TRAci Platform</h1>
                <p class="login-subtitle">Clinical Innovation Dashboard</p>
            </div>
            
            <div class="login-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe">
                            Remember me
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-full">
                        <span>Sign In</span>
                    </button>
                    
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-outline btn-sm" id="forgotPasswordBtn">
                            Forgot Password?
                        </button>
                    </div>
                </form>
                
                <div id="loginError" class="alert alert-danger hidden mt-4"></div>
            </div>
            
            <div class="login-footer">
                <p>For assistance, contact your system administrator</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="container navbar-container">
                <div class="flex items-center gap-3">
                    <button id="mobileMenuToggle" class="mobile-menu-toggle">
                        <i class="mdi mdi-menu text-xl"></i>
                    </button>
                    
                    <a href="#" class="navbar-brand">
                        <div class="navbar-logo">T</div>
                        <span class="navbar-title">TRAci</span>
                    </a>
                </div>
                
                <div class="navbar-actions">
                    <button id="notificationsBtn" class="btn btn-icon btn-outline">
                        <i class="mdi mdi-bell"></i>
                    </button>
                    <div id="userMenu"></div>
                </div>
            </div>
        </nav>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-md bg-primary-600 flex items-center justify-center text-white font-semibold" id="sidebarAvatar">
                        U
                    </div>
                    <div>
                        <div class="font-semibold" id="sidebarUserName">User Name</div>
                        <div class="text-sm text-tertiary" id="sidebarUserRole">Role</div>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <i class="mdi mdi-view-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                
                <a href="#" class="nav-item" data-page="projects">
                    <i class="mdi mdi-flask"></i>
                    <span>Projects</span>
                    <span class="badge badge-primary" id="projectsCount">0</span>
                </a>
                
                <a href="#" class="nav-item" data-page="tools">
                    <i class="mdi mdi-tools"></i>
                    <span>Tools</span>
                    <span class="badge badge-secondary" id="toolsCount">0</span>
                </a>
                
                <div id="adminMenu" class="hidden">
                    <div class="text-xs font-semibold text-tertiary uppercase tracking-wider mt-6 mb-2 px-4">Administration</div>
                    
                    <a href="#" class="nav-item" data-page="users">
                        <i class="mdi mdi-account-multiple"></i>
                        <span>User Management</span>
                    </a>
                    
                    <a href="#" class="nav-item" data-page="activity">
                        <i class="mdi mdi-history"></i>
                        <span>Activity Log</span>
                    </a>
                    
                    <a href="#" class="nav-item" data-page="settings">
                        <i class="mdi mdi-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
                
                <div class="mt-6 px-4">
                    <button id="logoutBtn" class="btn btn-outline w-full">
                        <i class="mdi mdi-logout"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </nav>
        </div>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="page">
                    <div class="page-header">
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Welcome back, <span id="welcomeUserName">User</span></p>
                    </div>
                    
                    <!-- Stats -->
                    <div class="stats-grid" id="statsGrid">
                        <!-- Stats loaded dynamically -->
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="font-semibold">Recent Activity</h2>
                        </div>
                        <div class="card-body">
                            <div class="activity-timeline" id="recentActivity">
                                <!-- Activity loaded dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="grid-view">
                        <div class="card">
                            <div class="card-body">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="stat-icon stat-icon-primary">
                                        <i class="mdi mdi-plus-circle"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold">New Project</h3>
                                        <p class="text-sm text-tertiary">Start a new clinical project</p>
                                    </div>
                                </div>
                                <button class="btn btn-primary w-full" id="newProjectBtn">
                                    Create Project
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="stat-icon stat-icon-success">
                                        <i class="mdi mdi-tools"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold">Add Tool</h3>
                                        <p class="text-sm text-tertiary">Register a new clinical tool</p>
                                    </div>
                                </div>
                                <button class="btn btn-outline w-full" id="newToolBtn">
                                    Add Tool
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="stat-icon stat-icon-warning">
                                        <i class="mdi mdi-sync"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold">Sync</h3>
                                        <p class="text-sm text-tertiary">Sync with ThoraxLab</p>
                                    </div>
                                </div>
                                <button class="btn btn-outline w-full" id="syncBtn">
                                    Start Sync
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Projects Page -->
                <div id="projectsPage" class="page hidden">
                    <div class="page-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="page-title">Projects</h1>
                                <p class="page-subtitle">Clinical research and innovation projects</p>
                            </div>
                            <button class="btn btn-primary" id="addProjectBtn">
                                <i class="mdi mdi-plus"></i>
                                <span>New Project</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div id="projectsTable">
                                <!-- Projects loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tools Page -->
                <div id="toolsPage" class="page hidden">
                    <div class="page-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="page-title">Clinical Tools</h1>
                                <p class="page-subtitle">Tools and resources for clinical work</p>
                            </div>
                            <button class="btn btn-primary" id="addToolBtn">
                                <i class="mdi mdi-plus"></i>
                                <span>New Tool</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid-view" id="toolsGrid">
                        <!-- Tools loaded dynamically -->
                    </div>
                </div>

                <!-- Users Page -->
                <div id="usersPage" class="page hidden">
                    <div class="page-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="page-title">User Management</h1>
                                <p class="page-subtitle">Manage user accounts and permissions</p>
                            </div>
                            <button class="btn btn-primary" id="addUserBtn">
                                <i class="mdi mdi-plus"></i>
                                <span>Add User</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div id="usersTable">
                                <!-- Users loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Page -->
                <div id="activityPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">Activity Log</h1>
                        <p class="page-subtitle">System activity and user actions</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div id="activityTable">
                                <!-- Activity loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settingsPage" class="page hidden">
                    <div class="page-header">
                        <h1 class="page-title">Settings</h1>
                        <p class="page-subtitle">System configuration and preferences</p>
                    </div>
                    
                    <div class="grid-view">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="font-semibold">Notifications</h2>
                            </div>
                            <div class="card-body">
                                <!-- Notification settings -->
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="font-semibold">Security</h2>
                            </div>
                            <div class="card-body">
                                <!-- Security settings -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Sign In</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="modalLoginForm">
                    <div class="form-group">
                        <label class="form-label" for="modalLoginEmail">Email</label>
                        <input type="email" id="modalLoginEmail" class="form-control" placeholder="email@example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="modalLoginPassword">Password</label>
                        <input type="password" id="modalLoginPassword" class="form-control" placeholder="Enter password" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="modalRememberMe">
                            Remember me
                        </label>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="forgotPasswordModalBtn">
                            Forgot Password?
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Sign In
                        </button>
                    </div>
                </form>
                
                <div id="modalLoginError" class="alert alert-danger hidden mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Reset Password</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="forgotPasswordForm">
                    <div class="form-group">
                        <label class="form-label" for="resetEmail">Email Address</label>
                        <input type="email" id="resetEmail" class="form-control" placeholder="Enter your email" required>
                        <div class="form-text">We'll send a password reset link to your email</div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Reset Link</button>
                    </div>
                </form>
                
                <div id="forgotPasswordSuccess" class="alert alert-success hidden mt-4"></div>
                <div id="forgotPasswordError" class="alert alert-danger hidden mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Set New Password</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="resetPasswordForm">
                    <input type="hidden" id="resetToken">
                    
                    <div class="form-group">
                        <label class="form-label" for="newPassword">New Password</label>
                        <input type="password" id="newPassword" class="form-control" placeholder="Enter new password" required>
                        <div class="password-strength">
                            <div class="strength-meter">
                                <div class="strength-fill" id="passwordStrength"></div>
                            </div>
                            <div class="strength-text" id="passwordStrengthText"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password" required>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Reset Password</button>
                    </div>
                </form>
                
                <div id="resetPasswordSuccess" class="alert alert-success hidden mt-4"></div>
                <div id="resetPasswordError" class="alert alert-danger hidden mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Session Timeout Modal -->
    <div id="sessionTimeoutModal" class="modal session-timeout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Session Timeout</h2>
            </div>
            <div class="modal-body">
                <p class="text-center mb-4">Your session is about to expire due to inactivity.</p>
                <div class="session-timeout-countdown" id="sessionCountdown">5:00</div>
                <p class="text-center text-sm text-tertiary">You will be logged out automatically</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-full" id="extendSessionBtn">
                    Continue Session
                </button>
            </div>
        </div>
    </div>

    <!-- Locked Out Modal -->
    <div id="lockedOutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Account Locked</h2>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="mdi mdi-lock-alert"></i>
                    Your account has been locked due to multiple failed login attempts.
                </div>
                <p class="text-sm text-tertiary mt-4">
                    For security reasons, your account has been temporarily disabled. 
                    Please contact your system administrator to regain access.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline w-full modal-close">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">New Project</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <div class="form-group">
                        <label class="form-label" for="projectName">Project Name</label>
                        <input type="text" id="projectName" class="form-control" placeholder="Enter project name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="projectDescription">Description</label>
                        <textarea id="projectDescription" class="form-control" rows="3" placeholder="Project description"></textarea>
                    </div>
                    
                    <div class="grid-view" style="grid-template-columns: 1fr 1fr; gap: var(--space-3);">
                        <div class="form-group">
                            <label class="form-label" for="projectStatus">Status</label>
                            <select id="projectStatus" class="form-control">
                                <option value="planning">Planning</option>
                                <option value="development">Development</option>
                                <option value="testing">Testing</option>
                                <option value="production">Production</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="projectProgress">Progress</label>
                            <input type="number" id="projectProgress" class="form-control" min="0" max="100" value="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="projectNeedsReview">
                            Needs Clinical Review
                        </label>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Project</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Tool Modal -->
    <div id="addToolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">New Tool</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="toolForm">
                    <div class="form-group">
                        <label class="form-label" for="toolName">Tool Name</label>
                        <input type="text" id="toolName" class="form-control" placeholder="Enter tool name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="toolDescription">Description</label>
                        <textarea id="toolDescription" class="form-control" rows="2" placeholder="Tool description"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="toolUrl">URL</label>
                        <input type="url" id="toolUrl" class="form-control" placeholder="https://example.com" required>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Tool</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add User</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label class="form-label" for="userFullName">Full Name</label>
                        <input type="text" id="userFullName" class="form-control" placeholder="Enter full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="userEmail">Email Address</label>
                        <input type="email" id="userEmail" class="form-control" placeholder="email@hospital.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="userRole">Role</label>
                        <select id="userRole" class="form-control">
                            <option value="doctor">Doctor/Clinician</option>
                            <option value="researcher">Researcher</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sendWelcomeEmail">
                            Send welcome email with login instructions
                        </label>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Notifications</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="notificationsList">
                    <!-- Notifications loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
        
        // Create manifest
        const manifest = {
            "name": "TRAci Platform",
            "short_name": "TRAci",
            "description": "Clinical Innovation Dashboard",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#f8fafc",
            "theme_color": "#0ea5e9",
            "icons": [
                {
                    "src": "/icon-192.png",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "/icon-512.png",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };
    </script>

    <!-- JavaScript Application -->
    <script>
        // ===== CONFIGURATION =====
        const SUPABASE_URL = 'https://bledpouekiytppuhxeqq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_zdlIM8UbOrRIFpmYLJOmWQ_4QqNi_5C';
        
        // Session timeout in minutes
        const SESSION_TIMEOUT = 30;
        const SESSION_WARNING = 5; // Show warning 5 minutes before timeout
        
        // ===== STATE =====
        let currentUser = null;
        let sessionTimer = null;
        let sessionWarningTimer = null;
        let lastActivity = Date.now();
        let failedLoginAttempts = {};
        
        // ===== SUPABASE CLIENT =====
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ===== PASSWORD STRENGTH CHECKER =====
        function checkPasswordStrength(password) {
            let strength = 0;
            let feedback = '';
            
            if (password.length >= 8) strength += 1;
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[a-z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^A-Za-z0-9]/.test(password)) strength += 1;
            
            const strengthMap = [
                { level: 0, text: 'Very Weak', color: '#ef4444', width: '20%' },
                { level: 1, text: 'Weak', color: '#f97316', width: '40%' },
                { level: 2, text: 'Fair', color: '#eab308', width: '60%' },
                { level: 3, text: 'Good', color: '#84cc16', width: '80%' },
                { level: 4, text: 'Strong', color: '#22c55e', width: '100%' },
                { level: 5, text: 'Very Strong', color: '#16a34a', width: '100%' }
            ];
            
            const result = strengthMap[Math.min(strength, 5)];
            return result;
        }
        
        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    ${type === 'success' ? '<i class="mdi mdi-check-circle"></i>' :
                      type === 'warning' ? '<i class="mdi mdi-alert-circle"></i>' :
                      type === 'danger' ? '<i class="mdi mdi-close-circle"></i>' :
                      '<i class="mdi mdi-information"></i>'}
                </div>
                <div class="toast-content">${message}</div>
                <button class="toast-close">
                    <i class="mdi mdi-close"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
            
            // Close button
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.remove();
            });
        }
        
        // ===== OFFLINE DETECTION =====
        function updateOnlineStatus() {
            const banner = document.getElementById('offlineBanner');
            if (!navigator.onLine) {
                banner.classList.add('active');
                showToast('You are offline. Some features may be limited.', 'warning');
            } else {
                banner.classList.remove('active');
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();
        
        // ===== SESSION MANAGEMENT =====
        function resetSessionTimer() {
            lastActivity = Date.now();
            
            if (sessionTimer) {
                clearTimeout(sessionTimer);
            }
            
            if (sessionWarningTimer) {
                clearTimeout(sessionWarningTimer);
            }
            
            // Set warning timer (5 minutes before timeout)
            sessionWarningTimer = setTimeout(() => {
                showSessionWarning();
            }, (SESSION_TIMEOUT - SESSION_WARNING) * 60 * 1000);
            
            // Set logout timer
            sessionTimer = setTimeout(() => {
                logoutDueToInactivity();
            }, SESSION_TIMEOUT * 60 * 1000);
        }
        
        function showSessionWarning() {
            const modal = document.getElementById('sessionTimeoutModal');
            const countdown = document.getElementById('sessionCountdown');
            let timeLeft = SESSION_WARNING * 60;
            
            modal.classList.add('active');
            
            const countdownInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                countdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            document.getElementById('extendSessionBtn').onclick = () => {
                clearInterval(countdownInterval);
                modal.classList.remove('active');
                resetSessionTimer();
                showToast('Session extended', 'success');
            };
        }
        
        function logoutDueToInactivity() {
            showToast('Session expired due to inactivity', 'warning');
            logout();
        }
        
        // Track user activity
        document.addEventListener('mousemove', resetSessionTimer);
        document.addEventListener('keypress', resetSessionTimer);
        document.addEventListener('click', resetSessionTimer);
        document.addEventListener('scroll', resetSessionTimer);
        
        // ===== PASSWORD HASHING =====
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // ===== AUTHENTICATION =====
        async function login(email, password, rememberMe = false) {
            const emailKey = email.toLowerCase().trim();
            
            // Check if account is locked
            if (failedLoginAttempts[emailKey] && failedLoginAttempts[emailKey].count >= 3) {
                const lockTime = failedLoginAttempts[emailKey].timestamp;
                const lockDuration = 30 * 60 * 1000; // 30 minutes
                
                if (Date.now() - lockTime < lockDuration) {
                    showToast('Account locked. Too many failed attempts. Please contact administrator.', 'danger');
                    
                    // Deactivate account in database
                    await deactivateAccount(emailKey);
                    
                    document.getElementById('lockedOutModal').classList.add('active');
                    return false;
                } else {
                    // Reset after lock duration
                    delete failedLoginAttempts[emailKey];
                }
            }
            
            try {
                const hashedPassword = await hashPassword(password);
                
                // Fetch user from database
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', emailKey)
                    .eq('status', 'active')
                    .single();
                
                if (error || !user) {
                    recordFailedAttempt(emailKey);
                    showToast('Invalid email or password', 'danger');
                    return false;
                }
                
                // Verify password
                if (user.encrypted_password !== hashedPassword) {
                    recordFailedAttempt(emailKey);
                    showToast('Invalid email or password', 'danger');
                    return false;
                }
                
                // Successful login
                currentUser = {
                    id: user.id,
                    email: user.email,
                    full_name: user.full_name,
                    role: user.role,
                    department: user.department
                };
                
                // Reset failed attempts
                delete failedLoginAttempts[emailKey];
                
                // Store session
                const sessionData = {
                    user: currentUser,
                    timestamp: Date.now()
                };
                
                if (rememberMe) {
                    localStorage.setItem('traci_session', JSON.stringify(sessionData));
                } else {
                    sessionStorage.setItem('traci_session', JSON.stringify(sessionData));
                }
                
                // Log login activity
                await logActivity('login', 'User logged in', currentUser.id);
                
                // Send login notification email
                await sendEmailNotification(
                    user.email,
                    'Successful Login - TRAci Platform',
                    `You have successfully logged into the TRAci Platform at ${new Date().toLocaleString()}.`
                );
                
                return true;
                
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed. Please try again.', 'danger');
                return false;
            }
        }
        
        function recordFailedAttempt(email) {
            if (!failedLoginAttempts[email]) {
                failedLoginAttempts[email] = {
                    count: 0,
                    timestamp: Date.now()
                };
            }
            
            failedLoginAttempts[email].count++;
            failedLoginAttempts[email].timestamp = Date.now();
            
            // Send alert email on 3rd failed attempt
            if (failedLoginAttempts[email].count === 3) {
                sendSecurityAlertEmail(email);
            }
        }
        
        async function deactivateAccount(email) {
            try {
                await supabase
                    .from('users')
                    .update({ status: 'locked' })
                    .eq('email', email);
                
                await logActivity('security', `Account locked: ${email}`);
                
            } catch (error) {
                console.error('Error deactivating account:', error);
            }
        }
        
        async function sendSecurityAlertEmail(email) {
            // In a real app, this would send an email
            console.log(`Security alert: Account ${email} locked due to failed login attempts`);
            
            // Log for admin review
            await logActivity('security', `Account locked due to failed attempts: ${email}`);
        }
        
        async function sendEmailNotification(to, subject, body) {
            // In a real app, integrate with email service
            console.log(`Email to ${to}: ${subject} - ${body}`);
            
            // Store notification in database
            await supabase
                .from('notifications')
                .insert({
                    user_id: currentUser.id,
                    type: 'email',
                    title: subject,
                    content: body,
                    created_at: new Date().toISOString()
                });
        }
        
        async function logout() {
            if (currentUser) {
                await logActivity('logout', 'User logged out', currentUser.id);
            }
            
            currentUser = null;
            localStorage.removeItem('traci_session');
            sessionStorage.removeItem('traci_session');
            
            if (sessionTimer) {
                clearTimeout(sessionTimer);
            }
            
            if (sessionWarningTimer) {
                clearTimeout(sessionWarningTimer);
            }
            
            showLoginPage();
        }
        
        function checkStoredSession() {
            let sessionData = sessionStorage.getItem('traci_session') || 
                             localStorage.getItem('traci_session');
            
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    const sessionAge = Date.now() - session.timestamp;
                    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
                    
                    if (sessionAge < maxAge) {
                        currentUser = session.user;
                        showMainApp();
                        return true;
                    }
                } catch (e) {
                    console.error('Error parsing session:', e);
                }
            }
            
            return false;
        }
        
        // ===== PASSWORD RESET =====
        async function requestPasswordReset(email) {
            try {
                // Check if user exists
                const { data: user } = await supabase
                    .from('users')
                    .select('id, email, full_name')
                    .eq('email', email.toLowerCase().trim())
                    .eq('status', 'active')
                    .single();
                
                if (!user) {
                    // Don't reveal if user exists
                    return { success: true };
                }
                
                // Generate reset token
                const resetToken = generateResetToken();
                const expiresAt = new Date(Date.now() + 1 * 60 * 60 * 1000); // 1 hour
                
                // Store reset token in database
                await supabase
                    .from('password_resets')
                    .insert({
                        user_id: user.id,
                        token: resetToken,
                        expires_at: expiresAt.toISOString(),
                        created_at: new Date().toISOString()
                    });
                
                // Send reset email (in real app)
                const resetLink = `${window.location.origin}/reset-password?token=${resetToken}`;
                console.log(`Password reset link for ${email}: ${resetLink}`);
                
                await logActivity('password_reset', `Password reset requested: ${email}`, user.id);
                
                return { success: true };
                
            } catch (error) {
                console.error('Password reset error:', error);
                return { success: false, error: 'Failed to process request' };
            }
        }
        
        async function resetPassword(token, newPassword) {
            try {
                // Verify token
                const { data: resetRecord } = await supabase
                    .from('password_resets')
                    .select('*')
                    .eq('token', token)
                    .eq('used', false)
                    .gt('expires_at', new Date().toISOString())
                    .single();
                
                if (!resetRecord) {
                    return { success: false, error: 'Invalid or expired reset token' };
                }
                
                // Hash new password
                const hashedPassword = await hashPassword(newPassword);
                
                // Update user password
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ 
                        encrypted_password: hashedPassword,
                        last_password_change: new Date().toISOString()
                    })
                    .eq('id', resetRecord.user_id);
                
                if (updateError) throw updateError;
                
                // Mark token as used
                await supabase
                    .from('password_resets')
                    .update({ used: true })
                    .eq('id', resetRecord.id);
                
                // Log activity
                await logActivity('password_reset', 'Password changed via reset', resetRecord.user_id);
                
                // Send confirmation email
                const { data: user } = await supabase
                    .from('users')
                    .select('email')
                    .eq('id', resetRecord.user_id)
                    .single();
                
                if (user) {
                    await sendEmailNotification(
                        user.email,
                        'Password Changed - TRAci Platform',
                        'Your password has been successfully changed.'
                    );
                }
                
                return { success: true };
                
            } catch (error) {
                console.error('Reset password error:', error);
                return { success: false, error: 'Failed to reset password' };
            }
        }
        
        function generateResetToken() {
            return Array.from(crypto.getRandomValues(new Uint8Array(32)))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }
        
        // ===== ACTIVITY LOGGING =====
        async function logActivity(action, details, userId = null) {
            try {
                await supabase
                    .from('activity_logs')
                    .insert({
                        user_id: userId || currentUser?.id,
                        user_name: currentUser?.full_name || 'System',
                        action: action,
                        details: details,
                        ip_address: await getClientIP(),
                        user_agent: navigator.userAgent,
                        created_at: new Date().toISOString()
                    });
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }
        
        async function getClientIP() {
            try {
                // In a real app, get IP from your backend
                return '127.0.0.1';
            } catch (error) {
                return 'unknown';
            }
        }
        
        // ===== UI MANAGEMENT =====
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
        
        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateUserUI();
            resetSessionTimer();
            loadDashboard();
        }
        
        function updateUserUI() {
            if (!currentUser) return;
            
            // Update sidebar
            document.getElementById('sidebarAvatar').textContent = 
                currentUser.full_name ? currentUser.full_name.charAt(0).toUpperCase() : 'U';
            document.getElementById('sidebarUserName').textContent = currentUser.full_name || 'User';
            document.getElementById('sidebarUserRole').textContent = currentUser.role;
            
            // Update welcome message
            document.getElementById('welcomeUserName').textContent = currentUser.full_name || 'User';
            
            // Show/hide admin menu
            if (currentUser.role === 'admin') {
                document.getElementById('adminMenu').classList.remove('hidden');
            } else {
                document.getElementById('adminMenu').classList.add('hidden');
            }
            
            // Update user menu in navbar
            const userMenu = document.getElementById('userMenu');
            userMenu.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="text-right hidden sm:block">
                        <div class="text-sm font-medium">${currentUser.full_name}</div>
                        <div class="text-xs text-tertiary">${currentUser.role}</div>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-primary-100 flex items-center justify-center">
                        <span class="text-sm font-semibold text-primary-700">
                            ${currentUser.full_name ? currentUser.full_name.charAt(0).toUpperCase() : 'U'}
                        </span>
                    </div>
                </div>
            `;
        }
        
        // ===== PAGE NAVIGATION =====
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.remove('hidden');
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === pageId.replace('Page', '')) {
                    item.classList.add('active');
                }
            });
        }
        
        // ===== MODAL MANAGEMENT =====
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }
        
        // ===== DATA LOADING =====
        async function loadDashboard() {
            if (!currentUser) return;
            
            try {
                // Load stats
                const [projects, tools, users, activity] = await Promise.all([
                    supabase.from('projects').select('*'),
                    supabase.from('tools').select('*'),
                    supabase.from('users').select('*'),
                    supabase.from('activity_logs').select('*').order('created_at', { ascending: false }).limit(10)
                ]);
                
                // Update counts
                document.getElementById('projectsCount').textContent = projects.data?.length || 0;
                document.getElementById('toolsCount').textContent = tools.data?.length || 0;
                
                // Update stats grid
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-primary">
                            <i class="mdi mdi-flask"></i>
                        </div>
                        <div class="stat-value">${projects.data?.length || 0}</div>
                        <div class="stat-label">Active Projects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-success">
                            <i class="mdi mdi-tools"></i>
                        </div>
                        <div class="stat-value">${tools.data?.length || 0}</div>
                        <div class="stat-label">Clinical Tools</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-warning">
                            <i class="mdi mdi-account-multiple"></i>
                        </div>
                        <div class="stat-value">${users.data?.filter(u => u.status === 'active').length || 0}</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-secondary">
                            <i class="mdi mdi-history"></i>
                        </div>
                        <div class="stat-value">${activity.data?.length || 0}</div>
                        <div class="stat-label">Recent Activities</div>
                    </div>
                `;
                
                // Update recent activity
                const recentActivity = document.getElementById('recentActivity');
                if (activity.data && activity.data.length > 0) {
                    recentActivity.innerHTML = activity.data.map(item => `
                        <div class="activity-item">
                            <div class="flex-1">
                                <div class="font-medium">${item.user_name}</div>
                                <div class="text-sm text-secondary">${item.details}</div>
                                <div class="activity-time">
                                    ${new Date(item.created_at).toLocaleString()}
                                </div>
                            </div>
                            <div class="badge ${item.action === 'login' ? 'badge-success' : 
                                               item.action === 'logout' ? 'badge-warning' : 
                                               'badge-secondary'}">
                                ${item.action}
                            </div>
                        </div>
                    `).join('');
                } else {
                    recentActivity.innerHTML = `
                        <div class="text-center py-8 text-tertiary">
                            <i class="mdi mdi-history text-3xl mb-2"></i>
                            <p>No recent activity</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Failed to load dashboard data', 'danger');
            }
        }
        
        async function loadProjects() {
            try {
                const { data: projects } = await supabase
                    .from('projects')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                const container = document.getElementById('projectsTable');
                if (!projects || projects.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="mdi mdi-flask-outline text-4xl text-tertiary mb-4"></i>
                            <h3 class="font-semibold mb-2">No Projects</h3>
                            <p class="text-tertiary mb-4">Get started by creating your first project</p>
                            <button class="btn btn-primary" id="createFirstProjectBtn">
                                <i class="mdi mdi-plus"></i>
                                Create Project
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Status</th>
                                    <th>Progress</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${projects.map(project => `
                                    <tr>
                                        <td>
                                            <div class="font-medium">${project.name}</div>
                                            <div class="text-sm text-tertiary">${project.description?.substring(0, 50) || 'No description'}...</div>
                                        </td>
                                        <td>
                                            <span class="badge ${project.status === 'production' ? 'badge-success' :
                                                              project.status === 'development' ? 'badge-primary' :
                                                              project.status === 'testing' ? 'badge-warning' :
                                                              'badge-secondary'}">
                                                ${project.status}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="flex items-center gap-2">
                                                <div class="flex-1 bg-surface-200 rounded-full h-2">
                                                    <div class="bg-primary-600 rounded-full h-2" style="width: ${project.progress || 0}%"></div>
                                                </div>
                                                <span class="text-sm font-medium">${project.progress || 0}%</span>
                                            </div>
                                        </td>
                                        <td class="text-sm text-tertiary">
                                            ${new Date(project.updated_at || project.created_at).toLocaleDateString()}
                                        </td>
                                        <td>
                                            <div class="flex gap-1">
                                                <button class="btn btn-sm btn-outline" onclick="editProject('${project.id}')">
                                                    <i class="mdi mdi-pencil"></i>
                                                </button>
                                                ${currentUser?.role === 'admin' ? `
                                                <button class="btn btn-sm btn-outline" onclick="deleteProject('${project.id}')">
                                                    <i class="mdi mdi-delete"></i>
                                                </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading projects:', error);
                showToast('Failed to load projects', 'danger');
            }
        }
        
        async function loadTools() {
            try {
                const { data: tools } = await supabase
                    .from('tools')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                const container = document.getElementById('toolsGrid');
                if (!tools || tools.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="mdi mdi-tools text-4xl text-tertiary mb-4"></i>
                            <h3 class="font-semibold mb-2">No Tools</h3>
                            <p class="text-tertiary">No clinical tools available</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = tools.map(tool => `
                    <div class="card">
                        <div class="card-body">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-md bg-primary-50 flex items-center justify-center text-primary-600">
                                    <i class="mdi ${tool.icon || 'mdi-tools'}"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold">${tool.name}</h3>
                                    <div class="text-sm text-tertiary">${tool.category || 'General'}</div>
                                </div>
                            </div>
                            <p class="text-sm text-secondary mb-4">${tool.description || 'No description available'}</p>
                            <div class="flex gap-2">
                                <a href="${tool.url}" target="_blank" class="btn btn-primary flex-1">
                                    <i class="mdi mdi-open-in-new"></i>
                                    <span>Open</span>
                                </a>
                                ${currentUser?.role === 'admin' ? `
                                <button class="btn btn-outline btn-icon" onclick="editTool('${tool.id}')">
                                    <i class="mdi mdi-pencil"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading tools:', error);
                showToast('Failed to load tools', 'danger');
            }
        }
        
        async function loadUsers() {
            if (currentUser?.role !== 'admin') return;
            
            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                const container = document.getElementById('usersTable');
                if (!users || users.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="mdi mdi-account-multiple text-4xl text-tertiary mb-4"></i>
                            <h3 class="font-semibold mb-2">No Users</h3>
                            <p class="text-tertiary">No users found in the system</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td>
                                            <div class="font-medium">${user.full_name}</div>
                                            <div class="text-sm text-tertiary">${user.email}</div>
                                        </td>
                                        <td>
                                            <span class="badge ${user.role === 'admin' ? 'badge-danger' :
                                                              user.role === 'doctor' ? 'badge-primary' :
                                                              'badge-secondary'}">
                                                ${user.role}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge ${user.status === 'active' ? 'badge-success' :
                                                              user.status === 'locked' ? 'badge-danger' :
                                                              'badge-warning'}">
                                                ${user.status}
                                            </span>
                                        </td>
                                        <td class="text-sm text-tertiary">
                                            ${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}
                                        </td>
                                        <td>
                                            <div class="flex gap-1">
                                                <button class="btn btn-sm btn-outline" onclick="editUser('${user.id}')">
                                                    <i class="mdi mdi-pencil"></i>
                                                </button>
                                                ${user.status === 'locked' ? `
                                                <button class="btn btn-sm btn-success" onclick="unlockUser('${user.id}')">
                                                    <i class="mdi mdi-lock-open"></i>
                                                </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Failed to load users', 'danger');
            }
        }
        
        async function loadActivity() {
            if (currentUser?.role !== 'admin') return;
            
            try {
                const { data: activity } = await supabase
                    .from('activity_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                const container = document.getElementById('activityTable');
                if (!activity || activity.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="mdi mdi-history text-4xl text-tertiary mb-4"></i>
                            <h3 class="font-semibold mb-2">No Activity</h3>
                            <p class="text-tertiary">No activity logs found</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${activity.map(item => {
                                    const timeAgo = getTimeAgo(new Date(item.created_at));
                                    return `
                                        <tr>
                                            <td>
                                                <div class="text-sm font-medium">${timeAgo}</div>
                                                <div class="text-xs text-tertiary">${new Date(item.created_at).toLocaleString()}</div>
                                            </td>
                                            <td>
                                                <div class="font-medium">${item.user_name}</div>
                                                <div class="text-xs text-tertiary">${item.user_id || 'System'}</div>
                                            </td>
                                            <td>
                                                <span class="badge ${item.action === 'login' ? 'badge-success' :
                                                                  item.action === 'logout' ? 'badge-warning' :
                                                                  item.action === 'security' ? 'badge-danger' :
                                                                  'badge-secondary'}">
                                                    ${item.action}
                                                </span>
                                            </td>
                                            <td class="text-sm">${item.details}</td>
                                            <td class="text-sm text-tertiary">${item.ip_address}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading activity:', error);
                showToast('Failed to load activity log', 'danger');
            }
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval >= 1) return interval + " year" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return interval + " month" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return interval + " day" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + " hour" + (interval === 1 ? "" : "s") + " ago";
            
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + " minute" + (interval === 1 ? "" : "s") + " ago";
            
            return "just now";
        }
        
        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            // Check for stored session
            if (checkStoredSession()) {
                showMainApp();
            } else {
                showLoginPage();
            }
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                const button = this.querySelector('button[type="submit"]');
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="loading"><span class="loading-spinner"></span> Signing In...</span>';
                button.disabled = true;
                
                const success = await login(email, password, rememberMe);
                
                button.innerHTML = originalText;
                button.disabled = false;
                
                if (success) {
                    showMainApp();
                }
            });
            
            // Forgot password
            document.getElementById('forgotPasswordBtn').addEventListener('click', function() {
                showModal('forgotPasswordModal');
            });
            
            // Forgot password form
            document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('resetEmail').value;
                const button = this.querySelector('button[type="submit"]');
                const originalText = button.innerHTML;
                
                button.innerHTML = '<span class="loading"><span class="loading-spinner"></span> Sending...</span>';
                button.disabled = true;
                
                const result = await requestPasswordReset(email);
                
                button.innerHTML = originalText;
                button.disabled = false;
                
                if (result.success) {
                    document.getElementById('forgotPasswordSuccess').textContent = 
                        'If an account exists with this email, you will receive a password reset link.';
                    document.getElementById('forgotPasswordSuccess').classList.remove('hidden');
                    document.getElementById('forgotPasswordError').classList.add('hidden');
                    
                    setTimeout(() => {
                        hideModal('forgotPasswordModal');
                    }, 3000);
                } else {
                    document.getElementById('forgotPasswordError').textContent = result.error;
                    document.getElementById('forgotPasswordError').classList.remove('hidden');
                    document.getElementById('forgotPasswordSuccess').classList.add('hidden');
                }
            });
            
            // Check for reset token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('token');
            if (resetToken) {
                document.getElementById('resetToken').value = resetToken;
                showModal('resetPasswordModal');
            }
            
            // Reset password form
            document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const token = document.getElementById('resetToken').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    document.getElementById('resetPasswordError').textContent = 'Passwords do not match';
                    document.getElementById('resetPasswordError').classList.remove('hidden');
                    return;
                }
                
                const button = this.querySelector('button[type="submit"]');
                const originalText = button.innerHTML;
                
                button.innerHTML = '<span class="loading"><span class="loading-spinner"></span> Resetting...</span>';
                button.disabled = true;
                
                const result = await resetPassword(token, newPassword);
                
                button.innerHTML = originalText;
                button.disabled = false;
                
                if (result.success) {
                    document.getElementById('resetPasswordSuccess').textContent = 
                        'Password reset successfully! You can now login with your new password.';
                    document.getElementById('resetPasswordSuccess').classList.remove('hidden');
                    document.getElementById('resetPasswordError').classList.add('hidden');
                    
                    setTimeout(() => {
                        hideModal('resetPasswordModal');
                        // Remove token from URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 3000);
                } else {
                    document.getElementById('resetPasswordError').textContent = result.error;
                    document.getElementById('resetPasswordError').classList.remove('hidden');
                    document.getElementById('resetPasswordSuccess').classList.add('hidden');
                }
            });
            
            // Password strength indicator
            document.getElementById('newPassword')?.addEventListener('input', function() {
                const password = this.value;
                const result = checkPasswordStrength(password);
                
                const strengthBar = document.getElementById('passwordStrength');
                const strengthText = document.getElementById('passwordStrengthText');
                
                strengthBar.style.width = result.width;
                strengthBar.style.backgroundColor = result.color;
                strengthText.textContent = result.text;
                strengthText.style.color = result.color;
            });
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page + 'Page';
                    showPage(page);
                    
                    // Load page data
                    switch(page) {
                        case 'projectsPage':
                            loadProjects();
                            break;
                        case 'toolsPage':
                            loadTools();
                            break;
                        case 'usersPage':
                            loadUsers();
                            break;
                        case 'activityPage':
                            loadActivity();
                            break;
                    }
                    
                    // Close sidebar on mobile
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('sidebarOverlay').classList.remove('active');
                });
            });
            
            // Mobile menu
            document.getElementById('mobileMenuToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.add('active');
                document.getElementById('sidebarOverlay').classList.add('active');
            });
            
            document.getElementById('sidebarOverlay').addEventListener('click', function() {
                document.getElementById('sidebar').classList.remove('active');
                this.classList.remove('active');
            });
            
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    modal.classList.remove('active');
                });
            });
            
            // Close modal on overlay click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Quick actions
            document.getElementById('newProjectBtn').addEventListener('click', function() {
                showModal('addProjectModal');
            });
            
            document.getElementById('newToolBtn').addEventListener('click', function() {
                showModal('addToolModal');
            });
            
            document.getElementById('syncBtn').addEventListener('click', function() {
                showToast('Sync feature coming soon', 'info');
            });
            
            // Header buttons
            document.getElementById('addProjectBtn')?.addEventListener('click', function() {
                showModal('addProjectModal');
            });
            
            document.getElementById('addToolBtn')?.addEventListener('click', function() {
                showModal('addToolModal');
            });
            
            document.getElementById('addUserBtn')?.addEventListener('click', function() {
                showModal('addUserModal');
            });
            
            document.getElementById('notificationsBtn').addEventListener('click', function() {
                showModal('notificationsModal');
            });
            
            // Project form
            document.getElementById('projectForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const projectData = {
                    name: document.getElementById('projectName').value,
                    description: document.getElementById('projectDescription').value,
                    status: document.getElementById('projectStatus').value,
                    progress: parseInt(document.getElementById('projectProgress').value) || 0,
                    needs_review: document.getElementById('projectNeedsReview').checked,
                    created_by: currentUser.id,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                try {
                    const { error } = await supabase
                        .from('projects')
                        .insert([projectData]);
                    
                    if (error) throw error;
                    
                    showToast('Project created successfully', 'success');
                    hideModal('addProjectModal');
                    loadProjects();
                    loadDashboard();
                    
                    // Clear form
                    this.reset();
                    
                } catch (error) {
                    console.error('Error creating project:', error);
                    showToast('Failed to create project', 'danger');
                }
            });
            
            // Tool form
            document.getElementById('toolForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const toolData = {
                    name: document.getElementById('toolName').value,
                    description: document.getElementById('toolDescription').value,
                    url: document.getElementById('toolUrl').value,
                    category: 'clinical',
                    created_by: currentUser.id,
                    created_at: new Date().toISOString()
                };
                
                try {
                    const { error } = await supabase
                        .from('tools')
                        .insert([toolData]);
                    
                    if (error) throw error;
                    
                    showToast('Tool added successfully', 'success');
                    hideModal('addToolModal');
                    loadTools();
                    loadDashboard();
                    
                    // Clear form
                    this.reset();
                    
                } catch (error) {
                    console.error('Error adding tool:', error);
                    showToast('Failed to add tool', 'danger');
                }
            });
            
            // User form
            document.getElementById('userForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (currentUser?.role !== 'admin') {
                    showToast('Only administrators can create users', 'danger');
                    return;
                }
                
                const userData = {
                    full_name: document.getElementById('userFullName').value,
                    email: document.getElementById('userEmail').value.toLowerCase(),
                    role: document.getElementById('userRole').value,
                    status: 'active',
                    created_at: new Date().toISOString()
                };
                
                try {
                    const { error } = await supabase
                        .from('users')
                        .insert([userData]);
                    
                    if (error) throw error;
                    
                    showToast('User created successfully', 'success');
                    hideModal('addUserModal');
                    loadUsers();
                    loadDashboard();
                    
                    // Clear form
                    this.reset();
                    
                } catch (error) {
                    console.error('Error creating user:', error);
                    showToast('Failed to create user', 'danger');
                }
            });
        });
        
        // ===== GLOBAL FUNCTIONS =====
        window.editProject = async function(projectId) {
            showToast('Edit project feature coming soon', 'info');
        };
        
        window.deleteProject = async function(projectId) {
            if (!confirm('Are you sure you want to delete this project?')) return;
            
            try {
                const { error } = await supabase
                    .from('projects')
                    .delete()
                    .eq('id', projectId);
                
                if (error) throw error;
                
                showToast('Project deleted successfully', 'success');
                loadProjects();
                loadDashboard();
                
            } catch (error) {
                console.error('Error deleting project:', error);
                showToast('Failed to delete project', 'danger');
            }
        };
        
        window.editTool = async function(toolId) {
            showToast('Edit tool feature coming soon', 'info');
        };
        
        window.editUser = async function(userId) {
            showToast('Edit user feature coming soon', 'info');
        };
        
        window.unlockUser = async function(userId) {
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ status: 'active' })
                    .eq('id', userId);
                
                if (error) throw error;
                
                showToast('User unlocked successfully', 'success');
                loadUsers();
                
                await logActivity('security', `User unlocked: ${userId}`);
                
            } catch (error) {
                console.error('Error unlocking user:', error);
                showToast('Failed to unlock user', 'danger');
            }
        };
    </script>
</body>
</html>
