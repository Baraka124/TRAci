<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRAci | Pneumology Innovation Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="app">
        <!-- Everything rendered dynamically via JavaScript -->
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const CONFIG = {
            SUPABASE_URL: 'https://bledpouekiytppuhxeqq.supabase.co',
            SUPABASE_ANON_KEY: 'sb_publishable_zdlIM8UbOrRIFpmYLJOmWQ_4QqNi_5C',
            APP_NAME: 'TRAci',
            DEPARTMENT: 'Pneumology Innovation',
            COLORS: {
                primary: '#2563eb',
                primaryDark: '#1e40af',
                primaryLight: '#dbeafe',
                secondary: '#7c3aed',
                accent: '#0d9488',
                success: '#059669',
                warning: '#d97706',
                danger: '#dc2626',
                info: '#0ea5e9',
                dark: '#1e293b',
                light: '#f8fafc',
                gray: '#64748b'
            },
            ICONS: {
                logo: 'fas fa-chart-network',
                tools: {
                    default: 'fas fa-tools',
                    analysis: 'fas fa-chart-bar',
                    medical: 'fas fa-stethoscope',
                    research: 'fas fa-microscope',
                    data: 'fas fa-database',
                    imaging: 'fas fa-x-ray',
                    lab: 'fas fa-vial'
                },
                projects: {
                    default: 'fas fa-project-diagram',
                    development: 'fas fa-code',
                    testing: 'fas fa-flask',
                    production: 'fas fa-server',
                    planning: 'fas fa-tasks'
                },
                status: {
                    operational: 'fas fa-check-circle',
                    warning: 'fas fa-exclamation-triangle',
                    maintenance: 'fas fa-tools'
                }
            }
        };

        // ========== APPLICATION STATE ==========
        class AppState {
            constructor() {
                this.currentUser = null;
                this.authToken = localStorage.getItem('traci_auth_token');
                this.data = {
                    projects: [],
                    tools: [],
                    updates: [],
                    lastUpdated: new Date()
                };
                this.supabase = null;
                this.isLoading = false;
                this.init();
            }

            async init() {
                this.supabase = window.supabase.createClient(
                    CONFIG.SUPABASE_URL,
                    CONFIG.SUPABASE_ANON_KEY
                );
                this.loadStoredUser();
                this.render();
            }

            loadStoredUser() {
                if (this.authToken) {
                    try {
                        this.currentUser = JSON.parse(atob(this.authToken));
                    } catch (e) {
                        localStorage.removeItem('traci_auth_token');
                        this.authToken = null;
                    }
                }
            }

            async login(username, password) {
                try {
                    const { data, error } = await this.supabase
                        .from('dashboard_users')
                        .select('username, role, password_hash')
                        .eq('username', username)
                        .single();

                    if (error || !data || data.password_hash !== password) {
                        throw new Error('Invalid credentials');
                    }

                    this.currentUser = {
                        username: data.username,
                        role: data.role
                    };

                    this.authToken = btoa(JSON.stringify(this.currentUser));
                    localStorage.setItem('traci_auth_token', this.authToken);

                    this.render();
                    return true;

                } catch (error) {
                    console.error('Login failed:', error);
                    return false;
                }
            }

            logout() {
                this.currentUser = null;
                this.authToken = null;
                localStorage.removeItem('traci_auth_token');
                this.render();
            }

            async fetchData() {
                this.isLoading = true;
                this.render();

                try {
                    const [projects, tools, updates] = await Promise.all([
                        this.fetchProjects(),
                        this.fetchTools(),
                        this.fetchUpdates()
                    ]);

                    this.data.projects = projects;
                    this.data.tools = tools;
                    this.data.updates = updates;
                    this.data.lastUpdated = new Date();

                } catch (error) {
                    console.error('Failed to fetch data:', error);
                } finally {
                    this.isLoading = false;
                    this.render();
                }
            }

            async fetchProjects() {
                const { data, error } = await this.supabase
                    .from('projects')
                    .select('*')
                    .order('needs_feedback', { ascending: false })
                    .order('status', { ascending: true });

                return error ? [] : data || [];
            }

            async fetchTools() {
                const { data, error } = await this.supabase
                    .from('tools')
                    .select('*')
                    .order('created_at', { ascending: false });

                return error ? [] : data || [];
            }

            async fetchUpdates() {
                const { data, error } = await this.supabase
                    .from('updates')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                return error ? [] : data || [];
            }

            async addProject(projectData) {
                try {
                    const { data, error } = await this.supabase
                        .from('projects')
                        .insert([{
                            ...projectData,
                            last_updated: new Date().toISOString()
                        }])
                        .select();

                    if (error) throw error;
                    await this.fetchData();
                    return { success: true, data };

                } catch (error) {
                    console.error('Add project failed:', error);
                    return { success: false, error: error.message };
                }
            }

            async updateProject(id, projectData) {
                try {
                    const { data, error } = await this.supabase
                        .from('projects')
                        .update({
                            ...projectData,
                            last_updated: new Date().toISOString()
                        })
                        .eq('id', id)
                        .select();

                    if (error) throw error;
                    await this.fetchData();
                    return { success: true, data };

                } catch (error) {
                    console.error('Update project failed:', error);
                    return { success: false, error: error.message };
                }
            }

            async deleteProject(id) {
                try {
                    const { error } = await this.supabase
                        .from('projects')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    await this.fetchData();
                    return { success: true };

                } catch (error) {
                    console.error('Delete project failed:', error);
                    return { success: false, error: error.message };
                }
            }

            render() {
                const app = document.getElementById('app');
                app.innerHTML = this.generateHTML();
                this.attachEventListeners();
            }

            generateHTML() {
                if (this.isLoading) {
                    return this.renderLoadingScreen();
                }

                if (!this.currentUser) {
                    return this.renderLoginScreen();
                }

                return `
                    ${this.renderStyles()}
                    <div class="container">
                        ${this.renderHeader()}
                        ${this.currentUser.role !== 'viewer' ? this.renderDashboard() : this.renderViewerScreen()}
                        ${this.renderFooter()}
                    </div>
                    ${this.renderModals()}
                `;
            }

            renderStyles() {
                return `
                    <style>
                        /* ==== CSS VARIABLES ==== */
                        :root {
                            --primary: ${CONFIG.COLORS.primary};
                            --primary-dark: ${CONFIG.COLORS.primaryDark};
                            --primary-light: ${CONFIG.COLORS.primaryLight};
                            --secondary: ${CONFIG.COLORS.secondary};
                            --accent: ${CONFIG.COLORS.accent};
                            --success: ${CONFIG.COLORS.success};
                            --warning: ${CONFIG.COLORS.warning};
                            --danger: ${CONFIG.COLORS.danger};
                            --info: ${CONFIG.COLORS.info};
                            --dark: ${CONFIG.COLORS.dark};
                            --light: ${CONFIG.COLORS.light};
                            --gray: ${CONFIG.COLORS.gray};
                            --border: #e2e8f0;
                            --card-bg: #ffffff;
                            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
                            --shadow: 0 1px 3px rgba(0,0,0,0.1);
                            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
                            --radius: 12px;
                            --transition: 200ms ease;
                        }

                        /* ==== BASE STYLES ==== */
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }

                        body {
                            font-family: 'Inter', sans-serif;
                            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                            color: var(--dark);
                            min-height: 100vh;
                            padding: 20px;
                            -webkit-font-smoothing: antialiased;
                        }

                        .container {
                            max-width: 1400px;
                            margin: 0 auto;
                        }

                        /* ==== HEADER ==== */
                        .header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 20px 0;
                            margin-bottom: 30px;
                            border-bottom: 2px solid var(--border);
                        }

                        .logo-section {
                            display: flex;
                            align-items: center;
                            gap: 15px;
                        }

                        .logo {
                            width: 60px;
                            height: 60px;
                            background: linear-gradient(135deg, var(--primary), var(--accent));
                            border-radius: var(--radius);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 24px;
                            box-shadow: var(--shadow);
                        }

                        .title h1 {
                            font-family: 'Space Grotesk', sans-serif;
                            font-size: 28px;
                            font-weight: 700;
                            background: linear-gradient(135deg, var(--primary), var(--accent));
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            margin-bottom: 4px;
                        }

                        .title .subtitle {
                            font-size: 14px;
                            color: var(--gray);
                            font-weight: 500;
                        }

                        .department {
                            color: var(--primary);
                            font-size: 12px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            margin-top: 2px;
                        }

                        .header-right {
                            display: flex;
                            align-items: center;
                            gap: 20px;
                        }

                        .last-updated {
                            background: var(--card-bg);
                            padding: 10px 20px;
                            border-radius: 10px;
                            border: 1px solid var(--border);
                            font-size: 14px;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }

                        .live-indicator {
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            color: var(--success);
                            font-size: 12px;
                            font-weight: 600;
                        }

                        .live-dot {
                            width: 8px;
                            height: 8px;
                            background: var(--success);
                            border-radius: 50%;
                            animation: pulse 2s infinite;
                        }

                        @keyframes pulse {
                            0%, 100% { opacity: 1; }
                            50% { opacity: 0.5; }
                        }

                        /* ==== AUTH ==== */
                        .auth-btn {
                            padding: 10px 20px;
                            background: linear-gradient(135deg, var(--primary), var(--accent));
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: transform var(--transition);
                        }

                        .auth-btn:hover {
                            transform: translateY(-2px);
                        }

                        .user-profile {
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            background: var(--card-bg);
                            padding: 8px 16px;
                            border-radius: 25px;
                            border: 1px solid var(--border);
                        }

                        .user-avatar {
                            width: 36px;
                            height: 36px;
                            background: linear-gradient(135deg, var(--primary), var(--accent));
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                        }

                        /* ==== STATS ==== */
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                            gap: 20px;
                            margin-bottom: 30px;
                        }

                        .stat-card {
                            background: var(--card-bg);
                            border-radius: var(--radius);
                            padding: 20px;
                            border: 1px solid var(--border);
                            display: flex;
                            align-items: center;
                            gap: 15px;
                            transition: all var(--transition);
                        }

                        .stat-card:hover {
                            transform: translateY(-4px);
                            box-shadow: var(--shadow-lg);
                        }

                        .stat-icon {
                            width: 50px;
                            height: 50px;
                            border-radius: 10px;
                            background: linear-gradient(135deg, var(--primary), var(--accent));
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 20px;
                        }

                        .stat-content h3 {
                            font-size: 12px;
                            color: var(--gray);
                            text-transform: uppercase;
                            letter-spacing: 1px;
                        }

                        .stat-number {
                            font-size: 32px;
                            font-weight: 700;
                            font-family: 'Space Grotesk', sans-serif;
                        }

                        /* ==== CONTENT GRID ==== */
                        .content-grid {
                            display: grid;
                            grid-template-columns: 1fr;
                            gap: 30px;
                            margin-bottom: 40px;
                        }

                        @media (min-width: 1024px) {
                            .content-grid {
                                grid-template-columns: 1fr 1fr;
                            }
                        }

                        /* ==== SECTION ==== */
                        .section {
                            background: var(--card-bg);
                            border-radius: var(--radius);
                            border: 1px solid var(--border);
                            overflow: hidden;
                        }

                        .section-header {
                            padding: 20px;
                            border-bottom: 1px solid var(--border);
                            background: linear-gradient(90deg, var(--primary-light), transparent);
                        }

                        .section-header h2 {
                            font-family: 'Space Grotesk', sans-serif;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }

                        .section-content {
                            padding: 20px;
                        }

                        /* ==== TOOLS ==== */
                        .tools-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                            gap: 20px;
                        }

                        .tool-card {
                            border: 1px solid var(--border);
                            border-radius: 10px;
                            padding: 20px;
                            transition: all var(--transition);
                        }

                        .tool-card:hover {
                            transform: translateY(-2px);
                            box-shadow: var(--shadow-lg);
                        }

                        .tool-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 15px;
                        }

                        .tool-title {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            font-weight: 600;
                        }

                        .tool-icon {
                            width: 40px;
                            height: 40px;
                            background: linear-gradient(135deg, var(--primary), var(--accent));
                            border-radius: 8px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                        }

                        /* ==== PROJECTS ==== */
                        .projects-list {
                            display: flex;
                            flex-direction: column;
                            gap: 20px;
                        }

                        .project-card {
                            border: 1px solid var(--border);
                            border-radius: 10px;
                            padding: 20px;
                            transition: all var(--transition);
                        }

                        .project-card.needs-feedback {
                            border-color: var(--warning);
                            background: linear-gradient(135deg, #fffbeb, #fef3c7);
                        }

                        .project-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 15px;
                        }

                        .project-title {
                            font-weight: 600;
                            font-size: 18px;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        }

                        .project-status {
                            font-size: 12px;
                            padding: 6px 12px;
                            border-radius: 20px;
                            font-weight: 600;
                        }

                        .status-development { background: #dbeafe; color: var(--primary); }
                        .status-testing { background: #e0f2fe; color: var(--info); }
                        .status-production { background: #d1fae5; color: var(--success); }

                        .progress-bar {
                            height: 8px;
                            background: var(--border);
                            border-radius: 4px;
                            overflow: hidden;
                            margin: 10px 0;
                        }

                        .progress-fill {
                            height: 100%;
                            background: linear-gradient(90deg, var(--primary), var(--accent));
                            border-radius: 4px;
                        }

                        /* ==== MODALS ==== */
                        .modal-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0,0,0,0.5);
                            display: none;
                            align-items: center;
                            justify-content: center;
                            z-index: 1000;
                        }

                        .modal-content {
                            background: var(--card-bg);
                            border-radius: var(--radius);
                            width: 90%;
                            max-width: 500px;
                            padding: 30px;
                            box-shadow: var(--shadow-lg);
                        }

                        .modal-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 20px;
                        }

                        .form-group {
                            margin-bottom: 20px;
                        }

                        .form-group label {
                            display: block;
                            margin-bottom: 8px;
                            font-weight: 500;
                        }

                        .form-group input,
                        .form-group select,
                        .form-group textarea {
                            width: 100%;
                            padding: 12px;
                            border: 1px solid var(--border);
                            border-radius: 8px;
                            font-family: inherit;
                        }

                        .btn-primary {
                            width: 100%;
                            padding: 12px;
                            background: linear-gradient(135deg, var(--primary), var(--accent));
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: opacity var(--transition);
                        }

                        .btn-primary:hover {
                            opacity: 0.9;
                        }

                        /* ==== FOOTER ==== */
                        .footer {
                            text-align: center;
                            padding: 30px 0;
                            color: var(--gray);
                            border-top: 1px solid var(--border);
                        }

                        /* ==== UTILITY ==== */
                        .loading {
                            text-align: center;
                            padding: 60px;
                        }

                        .empty-state {
                            text-align: center;
                            padding: 40px;
                            color: var(--gray);
                        }

                        .hidden {
                            display: none !important;
                        }
                    </style>
                `;
            }

            renderHeader() {
                return `
                    <header class="header">
                        <div class="logo-section">
                            <div class="logo">
                                <i class="${CONFIG.ICONS.logo}"></i>
                            </div>
                            <div class="title">
                                <h1>${CONFIG.APP_NAME}</h1>
                                <div class="subtitle">Innovation Dashboard</div>
                                <div class="department">${CONFIG.DEPARTMENT}</div>
                            </div>
                        </div>
                        <div class="header-right">
                            <div class="last-updated">
                                <i class="fas fa-sync-alt"></i>
                                <span>Last: ${this.formatTime(this.data.lastUpdated)}</span>
                                <span class="live-indicator">
                                    <span class="live-dot"></span> LIVE
                                </span>
                            </div>
                            ${this.currentUser ? this.renderUserProfile() : this.renderLoginButton()}
                        </div>
                    </header>
                `;
            }

            renderLoginButton() {
                return `
                    <button class="auth-btn" id="showLoginBtn">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                `;
            }

            renderUserProfile() {
                return `
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600;">${this.currentUser.username}</div>
                            <div style="font-size: 12px; color: var(--gray);">${this.currentUser.role}</div>
                        </div>
                        <button class="auth-btn" id="logoutBtn" style="padding: 8px; background: var(--gray);">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                `;
            }

            renderDashboard() {
                return `
                    ${this.currentUser.role === 'admin' ? this.renderAdminControls() : ''}
                    ${this.renderStats()}
                    ${this.renderFilterControls()}
                    ${this.renderContentGrid()}
                    ${this.renderUpdatesSection()}
                `;
            }

            renderAdminControls() {
                return `
                    <div class="admin-controls" style="margin-bottom: 30px;">
                        <button class="auth-btn" id="addProjectBtn">
                            <i class="fas fa-plus-circle"></i> Add Project
                        </button>
                        <button class="auth-btn" id="addToolBtn">
                            <i class="fas fa-tools"></i> Add Tool
                        </button>
                    </div>
                `;
            }

            renderStats() {
                const stats = this.calculateStats();
                return `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="${CONFIG.ICONS.tools.medical}"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Active Tools</h3>
                                <div class="stat-number">${stats.tools}</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="${CONFIG.ICONS.projects.default}"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Projects</h3>
                                <div class="stat-number">${stats.projects}</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-comment-medical"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Feedback Needed</h3>
                                <div class="stat-number">${stats.feedback}</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-rocket"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Active Development</h3>
                                <div class="stat-number">${stats.active}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderFilterControls() {
                return `
                    <div class="filter-controls" style="margin-bottom: 30px;">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="development">Development</button>
                        <button class="filter-btn" data-filter="testing">Testing</button>
                        <button class="filter-btn" data-filter="production">Production</button>
                    </div>
                `;
            }

            renderContentGrid() {
                return `
                    <div class="content-grid">
                        <div class="section">
                            <div class="section-header">
                                <h2><i class="fas fa-tools"></i> Tools & Resources</h2>
                            </div>
                            <div class="section-content">
                                ${this.renderTools()}
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-header">
                                <h2><i class="fas fa-project-diagram"></i> Active Projects</h2>
                            </div>
                            <div class="section-content">
                                ${this.renderProjects()}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderTools() {
                if (this.data.tools.length === 0) {
                    return `
                        <div class="empty-state">
                            <i class="fas fa-tools" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>No tools available</p>
                        </div>
                    `;
                }

                return `
                    <div class="tools-grid">
                        ${this.data.tools.map(tool => `
                            <div class="tool-card">
                                <div class="tool-header">
                                    <div class="tool-title">
                                        <div class="tool-icon">
                                            <i class="${this.getToolIcon(tool)}"></i>
                                        </div>
                                        <span>${tool.name}</span>
                                    </div>
                                    <span class="tool-status ${tool.status}">
                                        ${tool.status === 'operational' ? '✓' : '⚠'}
                                    </span>
                                </div>
                                <p style="color: var(--gray); margin: 15px 0;">${tool.description || 'No description'}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <small style="color: var(--gray);">Updated: ${this.formatTime(tool.last_checked)}</small>
                                    <a href="${tool.url}" target="_blank" style="color: var(--primary); font-weight: 500;">
                                        Access <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderProjects() {
                if (this.data.projects.length === 0) {
                    return `
                        <div class="empty-state">
                            <i class="fas fa-project-diagram" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>No projects available</p>
                        </div>
                    `;
                }

                return `
                    <div class="projects-list">
                        ${this.data.projects.map(project => `
                            <div class="project-card ${project.needs_feedback ? 'needs-feedback' : ''}">
                                <div class="project-header">
                                    <div class="project-title">
                                        <i class="${this.getProjectIcon(project)}"></i>
                                        ${project.name}
                                    </div>
                                    <span class="project-status status-${project.status}">
                                        ${project.status}
                                    </span>
                                </div>
                                <p style="color: var(--gray); margin-bottom: 15px;">${project.description || 'No description'}</p>
                                
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; margin: 20px 0;">
                                    ${project.github_url ? `
                                        <a href="${project.github_url}" target="_blank" style="display: flex; align-items: center; gap: 5px; color: var(--primary);">
                                            <i class="fab fa-github"></i> GitHub
                                        </a>
                                    ` : ''}
                                    ${project.live_url ? `
                                        <a href="${project.live_url}" target="_blank" style="display: flex; align-items: center; gap: 5px; color: var(--primary);">
                                            <i class="fas fa-external-link-alt"></i> Live
                                        </a>
                                    ` : ''}
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; color: var(--gray); font-size: 14px;">
                                    <span>Updated: ${this.formatTime(project.last_updated)}</span>
                                    ${project.needs_feedback ? `
                                        <span style="color: var(--warning); font-weight: 600;">
                                            <i class="fas fa-comment-exclamation"></i> Needs Feedback
                                        </span>
                                    ` : ''}
                                </div>
                                
                                ${this.currentUser.role === 'admin' ? `
                                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                                        <button class="edit-project-btn" data-id="${project.id}" style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px;">
                                            Edit
                                        </button>
                                        <button class="delete-project-btn" data-id="${project.id}" style="padding: 8px 16px; background: var(--danger); color: white; border: none; border-radius: 6px;">
                                            Delete
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderUpdatesSection() {
                if (this.data.updates.length === 0) return '';

                return `
                    <div class="section">
                        <div class="section-header">
                            <h2><i class="fas fa-history"></i> Recent Updates</h2>
                        </div>
                        <div class="section-content">
                            ${this.data.updates.map(update => `
                                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <h3 style="font-size: 16px;">${update.title}</h3>
                                        <small style="color: var(--gray);">${this.formatTime(update.created_at)}</small>
                                    </div>
                                    <p style="color: var(--gray);">${update.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            renderLoginScreen() {
                return `
                    ${this.renderStyles()}
                    <div class="container" style="max-width: 500px; margin-top: 100px;">
                        <div class="section">
                            <div style="text-align: center; padding: 60px 40px;">
                                <div style="font-size: 72px; color: var(--primary-light); margin-bottom: 30px;">
                                    <i class="fas fa-lock"></i>
                                </div>
                                <h1 style="font-family: 'Space Grotesk', sans-serif; margin-bottom: 15px;">
                                    ${CONFIG.APP_NAME} Dashboard
                                </h1>
                                <p style="color: var(--gray); margin-bottom: 30px;">
                                    ${CONFIG.DEPARTMENT}<br>
                                    Secure access to innovation tools and projects
                                </p>
                                <button class="auth-btn" id="showLoginBtn" style="margin: 0 auto;">
                                    <i class="fas fa-sign-in-alt"></i> Login to Continue
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderViewerScreen() {
                return `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-eye" style="font-size: 48px; color: var(--gray); margin-bottom: 20px;"></i>
                        <h2>Viewer Access</h2>
                        <p style="color: var(--gray); max-width: 500px; margin: 0 auto;">
                            You have view-only access. Contact an administrator for edit permissions.
                        </p>
                    </div>
                `;
            }

            renderLoadingScreen() {
                return `
                    ${this.renderStyles()}
                    <div class="container" style="text-align: center; padding: 100px 20px;">
                        <div class="loading-spinner" style="border: 4px solid var(--border); border-top: 4px solid var(--primary); border-radius: 50%; width: 60px; height: 60px; margin: 0 auto 30px; animation: spin 1s linear infinite;"></div>
                        <h2>Loading Dashboard...</h2>
                        <p style="color: var(--gray);">Fetching latest data from the server</p>
                    </div>
                `;
            }

            renderModals() {
                return `
                    ${this.renderLoginModal()}
                    ${this.renderAddProjectModal()}
                    ${this.renderAddToolModal()}
                `;
            }

            renderLoginModal() {
                return `
                    <div class="modal-overlay" id="loginModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2><i class="fas fa-lock"></i> Login</h2>
                                <button class="modal-close">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" id="loginUsername" placeholder="Enter username">
                                </div>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" id="loginPassword" placeholder="Enter password">
                                </div>
                                <button class="btn-primary" id="submitLogin">
                                    <i class="fas fa-sign-in-alt"></i> Sign In
                                </button>
                                <div id="loginError" style="color: var(--danger); margin-top: 15px; display: none;"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAddProjectModal() {
                return `
                    <div class="modal-overlay" id="addProjectModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2><i class="fas fa-plus-circle"></i> Add Project</h2>
                                <button class="modal-close">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label>Project Name</label>
                                    <input type="text" id="projectName">
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea id="projectDescription" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Status</label>
                                    <select id="projectStatus">
                                        <option value="planning">Planning</option>
                                        <option value="development">Development</option>
                                        <option value="testing">Testing</option>
                                        <option value="production">Production</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Progress (%)</label>
                                    <input type="number" id="projectProgress" min="0" max="100" value="0">
                                </div>
                                <button class="btn-primary" id="saveProjectBtn">
                                    <i class="fas fa-save"></i> Save Project
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAddToolModal() {
                return `
                    <div class="modal-overlay" id="addToolModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2><i class="fas fa-tools"></i> Add Tool</h2>
                                <button class="modal-close">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label>Tool Name</label>
                                    <input type="text" id="toolName">
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea id="toolDescription" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>URL</label>
                                    <input type="url" id="toolUrl">
                                </div>
                                <button class="btn-primary" id="saveToolBtn">
                                    <i class="fas fa-save"></i> Save Tool
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderFooter() {
                return `
                    <footer class="footer">
                        <p>${CONFIG.APP_NAME} • ${CONFIG.DEPARTMENT} • ${new Date().getFullYear()}</p>
                        <p style="margin-top: 10px; font-size: 14px; color: var(--gray);">
                            <button id="refreshData" style="background: none; border: none; color: var(--primary); cursor: pointer;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            • Auto-refresh: 5 min
                        </p>
                    </footer>
                `;
            }

            // ========== HELPER METHODS ==========
            calculateStats() {
                return {
                    tools: this.data.tools.length,
                    projects: this.data.projects.length,
                    feedback: this.data.projects.filter(p => p.needs_feedback).length,
                    active: this.data.projects.filter(p => p.status === 'development' || p.status === 'testing').length
                };
            }

            getToolIcon(tool) {
                const category = (tool.category || '').toLowerCase();
                if (category.includes('medical')) return CONFIG.ICONS.tools.medical;
                if (category.includes('research')) return CONFIG.ICONS.tools.research;
                if (category.includes('data')) return CONFIG.ICONS.tools.data;
                return CONFIG.ICONS.tools.default;
            }

            getProjectIcon(project) {
                return CONFIG.ICONS.projects[project.status] || CONFIG.ICONS.projects.default;
            }

            formatTime(dateString) {
                if (!dateString) return 'Never';
                const date = new Date(dateString);
                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
            }

            showModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            }

            hideModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            attachEventListeners() {
                // Auth buttons
                if (document.getElementById('showLoginBtn')) {
                    document.getElementById('showLoginBtn').addEventListener('click', () => {
                        this.showModal('loginModal');
                    });
                }

                if (document.getElementById('logoutBtn')) {
                    document.getElementById('logoutBtn').addEventListener('click', () => {
                        this.logout();
                    });
                }

                // Login form
                if (document.getElementById('submitLogin')) {
                    document.getElementById('submitLogin').addEventListener('click', async () => {
                        const username = document.getElementById('loginUsername').value;
                        const password = document.getElementById('loginPassword').value;
                        
                        if (!username || !password) {
                            this.showError('loginError', 'Please enter both username and password');
                            return;
                        }

                        const success = await this.login(username, password);
                        if (success) {
                            this.hideModal('loginModal');
                            await this.fetchData();
                        } else {
                            this.showError('loginError', 'Invalid credentials');
                        }
                    });
                }

                // Admin controls
                if (document.getElementById('addProjectBtn')) {
                    document.getElementById('addProjectBtn').addEventListener('click', () => {
                        this.showModal('addProjectModal');
                    });
                }

                if (document.getElementById('addToolBtn')) {
                    document.getElementById('addToolBtn').addEventListener('click', () => {
                        this.showModal('addToolModal');
                    });
                }

                // Save project
                if (document.getElementById('saveProjectBtn')) {
                    document.getElementById('saveProjectBtn').addEventListener('click', async () => {
                        const projectData = {
                            name: document.getElementById('projectName').value,
                            description: document.getElementById('projectDescription').value,
                            status: document.getElementById('projectStatus').value,
                            progress: parseInt(document.getElementById('projectProgress').value),
                            needs_feedback: false,
                            last_updated: new Date().toISOString()
                        };

                        if (!projectData.name) {
                            alert('Project name is required');
                            return;
                        }

                        const result = await this.addProject(projectData);
                        if (result.success) {
                            this.hideModal('addProjectModal');
                            alert('Project added successfully!');
                        } else {
                            alert('Failed to add project: ' + result.error);
                        }
                    });
                }

                // Save tool
                if (document.getElementById('saveToolBtn')) {
                    document.getElementById('saveToolBtn').addEventListener('click', async () => {
                        const toolData = {
                            name: document.getElementById('toolName').value,
                            description: document.getElementById('toolDescription').value,
                            url: document.getElementById('toolUrl').value,
                            status: 'operational',
                            last_checked: new Date().toISOString()
                        };

                        if (!toolData.name || !toolData.url) {
                            alert('Tool name and URL are required');
                            return;
                        }

                        // In a real app, you'd have an addTool method
                        alert('Add tool functionality would be implemented here');
                        this.hideModal('addToolModal');
                    });
                }

                // Refresh data
                if (document.getElementById('refreshData')) {
                    document.getElementById('refreshData').addEventListener('click', async () => {
                        await this.fetchData();
                    });
                }

                // Modal close buttons
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.hideModal(e.target.closest('.modal-overlay').id);
                    });
                });

                // Close modal on overlay click
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.hideModal(modal.id);
                        }
                    });
                });

                // Edit/Delete project buttons
                document.querySelectorAll('.edit-project-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const projectId = e.target.dataset.id;
                        alert(`Edit project ${projectId} - Implement edit modal`);
                    });
                });

                document.querySelectorAll('.delete-project-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const projectId = e.target.dataset.id;
                        if (confirm('Are you sure you want to delete this project?')) {
                            const result = await this.deleteProject(projectId);
                            if (result.success) {
                                alert('Project deleted successfully');
                            } else {
                                alert('Failed to delete project');
                            }
                        }
                    });
                });

                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Implement filtering logic
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                    });
                });
            }

            showError(elementId, message) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.style.display = 'block';
                }
            }
        }

        // ========== INITIALIZE APP ==========
        const app = new AppState();

        // Auto-refresh every 5 minutes if logged in
        setInterval(() => {
            if (app.currentUser && app.currentUser.role !== 'viewer') {
                app.fetchData();
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
