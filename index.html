<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>TRAci | Pneumology Innovation Dashboard</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== ALL STYLES FROM ORIGINAL WORKING CODE ===== */
        :root {
            --primary-50: #f0f9ff; --primary-100: #e0f2fe; --primary-200: #bae6fd;
            --primary-300: #7dd3fc; --primary-400: #38bdf8; --primary-500: #0ea5e9;
            --primary-600: #0284c7; --primary-700: #0369a1; --primary-800: #075985;
            --primary-900: #0c4a6e;
            --medical-teal: #0d9488; --medical-green: #059669; --medical-purple: #7c3aed;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
            --white: #ffffff; --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-300: #d1d5db; --gray-400: #9ca3af; --gray-500: #6b7280; --gray-600: #4b5563;
            --gray-700: #374151; --gray-800: #1f2937; --gray-900: #111827;
            --bg-primary: #f8fafc; --bg-card: #ffffff; --border: #cbd5e1;
            --font-sans: 'Inter', sans-serif; --font-heading: 'Space Grotesk', sans-serif;
            --radius: 0.375rem; --radius-lg: 0.75rem; --radius-full: 9999px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1); --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1); --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #0f172a; --bg-card: #1e293b; --white: #f1f5f9;
                --gray-50: #1e293b; --gray-100: #334155; --gray-200: #475569;
                --border: #475569;
            }
        }

        /* Reset and Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; -webkit-font-smoothing: antialiased; }
        body { font-family: var(--font-sans); background: var(--bg-primary); color: var(--gray-700); line-height: 1.6; padding: 1rem; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--gray-500); }

        /* IMPROVED MICROSOFT-STYLE LOGO */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 0; margin-bottom: 2rem; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 1rem; }
        .logo-section { display: flex; align-items: center; gap: 1rem; min-width: 0; flex: 1; }
        .logo { 
            width: 56px; 
            height: 56px; 
            border-radius: var(--radius-lg); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, var(--primary-600), var(--medical-teal)); 
            box-shadow: var(--shadow-md); 
            position: relative; 
            overflow: hidden; 
        }
        .windows-grid { 
            width: 32px; 
            height: 32px; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1fr 1fr; 
            gap: 3px; 
        }
        .window-pane { 
            border-radius: 2px; 
            transition: transform 0.3s ease; 
        }
        .pane1 { background: linear-gradient(135deg, #60a5fa, #3b82f6); } /* Soft blue */
        .pane2 { background: linear-gradient(135deg, #34d399, #10b981); } /* Teal green */
        .pane3 { background: linear-gradient(135deg, #a78bfa, #8b5cf6); } /* Soft purple */
        .pane4 { background: linear-gradient(135deg, #f472b6, #ec4899); } /* Soft pink */
        .logo:hover .window-pane { transform: scale(1.05); }
        .logo:hover .pane1 { transform: translate(-1px, -1px) scale(1.05); }
        .logo:hover .pane2 { transform: translate(1px, -1px) scale(1.05); }
        .logo:hover .pane3 { transform: translate(-1px, 1px) scale(1.05); }
        .logo:hover .pane4 { transform: translate(1px, 1px) scale(1.05); }
        
        .logo-text {
            position: absolute;
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 0.7rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .logo:hover .logo-text { opacity: 1; }

        .platform-info { display: flex; flex-direction: column; gap: 0.25rem; min-width: 0; }
        .platform-name { font-family: var(--font-heading); font-size: 1.75rem; font-weight: 700; color: var(--primary-700); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .department-name { font-size: 0.8125rem; color: var(--gray-600); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase; }
        
        .header-right { display: flex; align-items: center; gap: 1.5rem; flex-shrink: 0; }
        .status-panel { display: flex; align-items: center; gap: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-full); padding: 0.5rem 1rem; box-shadow: var(--shadow); white-space: nowrap; }
        .live-indicator { display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; font-weight: 600; color: var(--success); }
        .live-dot { width: 6px; height: 6px; background-color: var(--success); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ===== GUEST WELCOME SECTION ===== */
        .guest-welcome { 
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.05) 0%, rgba(13, 148, 136, 0.05) 100%); 
            border: 1px solid rgba(14, 165, 233, 0.2); 
            border-radius: var(--radius-lg); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
            position: relative; 
            overflow: hidden; 
        }
        .guest-welcome-content { display: flex; align-items: flex-start; gap: 1.5rem; }
        .guest-welcome-icon { flex-shrink: 0; font-size: 2.5rem; color: var(--primary-400); }
        .guest-welcome-text h3 { font-family: var(--font-heading); color: var(--primary-700); margin-bottom: 0.5rem; }
        .guest-welcome-text p { color: var(--gray-600); margin-bottom: 1rem; line-height: 1.6; }
        .guest-welcome-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .welcome-btn { padding: 0.5rem 1rem; border-radius: var(--radius); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: var(--transition); border: none; font-size: 0.875rem; }
        .welcome-btn.primary { background: var(--primary-600); color: white; }
        .welcome-btn.secondary { background: transparent; color: var(--primary-600); border: 1px solid var(--primary-400); }

        /* ===== GUEST COMMENT SECTION ===== */
        .comment-section { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: var(--radius-lg); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
            box-shadow: var(--shadow-sm); 
        }
        .comment-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
        .comment-icon { font-size: 1.5rem; color: var(--primary-500); }
        .comment-header h3 { font-family: var(--font-heading); color: var(--gray-800); font-size: 1.125rem; }
        .comment-textarea { 
            width: 100%; 
            padding: 0.75rem; 
            border: 2px solid var(--border); 
            border-radius: var(--radius); 
            font-family: var(--font-sans); 
            resize: vertical; 
            min-height: 100px; 
            font-size: 0.9375rem; 
            line-height: 1.5;
        }
        .comment-textarea:focus { 
            outline: none; 
            border-color: var(--primary-500); 
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); 
        }
        .comment-meta { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 0.5rem; 
            font-size: 0.8125rem; 
        }
        .comment-actions { display: flex; gap: 0.75rem; margin-top: 1rem; }
        .comment-btn { 
            padding: 0.75rem 1.5rem; 
            border-radius: var(--radius); 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            transition: var(--transition); 
            border: none; 
            font-size: 0.875rem;
        }
        .comment-btn.primary { background: linear-gradient(135deg, var(--primary-600), var(--primary-700)); color: white; }
        .comment-btn.secondary { background: var(--gray-100); color: var(--gray-700); border: 1px solid var(--border); }
        .comment-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
        .comment-success { 
            background: #d1fae5; 
            color: #065f46; 
            padding: 1rem; 
            border-radius: var(--radius); 
            margin-top: 1rem; 
            border-left: 4px solid #10b981; 
            display: none; 
            align-items: center;
            gap: 0.5rem;
        }

        /* ===== ORIGINAL STYLES CONTINUED ===== */
        /* Admin Controls */
        .admin-controls { display: flex; gap: 0.75rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .admin-btn { padding: 0.75rem 1.25rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); color: var(--gray-700); font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }
        .admin-btn:hover { border-color: var(--primary-500); color: var(--primary-600); transform: translateY(-2px); box-shadow: var(--shadow); }

        /* Stats */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; display: flex; align-items: center; gap: 1.25rem; transition: var(--transition); min-height: 120px; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--primary-200); }
        .stat-icon { width: 56px; height: 56px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--white); box-shadow: var(--shadow-md); }
        .stat-icon.tools { background: linear-gradient(135deg, var(--primary-500), var(--primary-600)); }
        .stat-icon.projects { background: linear-gradient(135deg, var(--medical-teal), #0891b2); }
        .stat-icon.feedback { background: linear-gradient(135deg, var(--warning), #f59e0b); }
        .stat-icon.comments { background: linear-gradient(135deg, var(--medical-purple), #8b5cf6); }
        .stat-info h3 { font-size: 0.8125rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem; }
        .stat-number { font-size: 2rem; font-weight: 700; color: var(--gray-900); font-family: var(--font-heading); line-height: 1; }

        /* Filters */
        .filter-controls { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; background: var(--bg-card); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid var(--border); }
        .filter-btn { padding: 0.5rem 1rem; background: var(--gray-50); border: 1px solid var(--border); border-radius: var(--radius-full); color: var(--gray-600); font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: var(--transition); white-space: nowrap; }
        .filter-btn:hover { background: var(--primary-50); color: var(--primary-600); border-color: var(--primary-300); }
        .filter-btn.active { background: var(--primary-600); color: var(--white); border-color: var(--primary-600); box-shadow: var(--shadow); }

        /* Content Grid */
        .content-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        @media (min-width: 1024px) { .content-grid { grid-template-columns: 1fr 1fr; } }

        /* Sections */
        .section { background: var(--bg-card); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow); transition: var(--transition); }
        .section:hover { box-shadow: var(--shadow-md); }
        .section-header { padding: 1.25rem 1.5rem; background: linear-gradient(90deg, var(--primary-50) 0%, transparent 100%); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .section-header h2 { font-family: var(--font-heading); font-size: 1.25rem; font-weight: 600; color: var(--gray-900); display: flex; align-items: center; gap: 0.75rem; white-space: nowrap; }
        .section-content { padding: 1.5rem; }

        /* Tools Grid */
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .tool-card { border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem; transition: var(--transition); min-height: 180px; display: flex; flex-direction: column; }
        .tool-card:hover { border-color: var(--primary-300); box-shadow: var(--shadow); transform: translateY(-2px); }
        .tool-card.operational { border-left: 4px solid var(--success); }
        .tool-card.warning { border-left: 4px solid var(--warning); }
        .tool-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem; }
        .tool-name { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; font-size: 1rem; color: var(--gray-900); min-width: 0; }
        .tool-icon { width: 40px; height: 40px; border-radius: var(--radius); background: linear-gradient(135deg, var(--primary-500), var(--medical-teal)); color: var(--white); display: flex; align-items: center; justify-content: center; font-size: 1.125rem; }
        .tool-status { font-size: 0.75rem; padding: 3px 8px; border-radius: var(--radius-full); font-weight: 600; white-space: nowrap; }
        .status-operational { background: #d1fae5; color: #065f46; }
        .status-warning { background: #fef3c7; color: #92400e; }
        .tool-description { color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem; line-height: 1.5; flex-grow: 1; }
        .tool-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.8125rem; flex-wrap: wrap; gap: 0.5rem; }
        .tool-link { color: var(--primary-600); text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 0.25rem; transition: var(--transition); }
        .tool-link:hover { color: var(--primary-700); }

        /* Projects List */
        .projects-list { display: flex; flex-direction: column; gap: 1rem; }
        .project-card { border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem; transition: var(--transition); position: relative; }
        .project-card:hover { border-color: var(--primary-300); box-shadow: var(--shadow); }
        .project-card.needs-feedback { border: 2px solid var(--warning); background: linear-gradient(to right, #fef3c7 0%, transparent 100%); }
        .visibility-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: var(--radius-full); font-weight: 600; margin-left: 8px; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; }
        .visibility-badge.private { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .visibility-badge.public { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .doctor-badge { display: inline-flex; align-items: center; gap: 6px; background: #dbeafe; color: #1d4ed8; padding: 4px 10px; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 600; margin-bottom: 0.75rem; white-space: nowrap; }
        .project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem; }
        .project-title { font-weight: 600; font-size: 1.125rem; color: var(--gray-900); display: flex; align-items: center; gap: 0.5rem; min-width: 0; }
        .project-status { font-size: 0.75rem; padding: 4px 10px; border-radius: var(--radius-full); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap; }
        .status-planning { background: #f3f4f6; color: #4b5563; }
        .status-development { background: #dbeafe; color: #1d4ed8; }
        .status-testing { background: #e0f2fe; color: #0369a1; }
        .status-production { background: #d1fae5; color: #065f46; }
        .project-description { color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem; line-height: 1.5; }
        .project-progress { margin-bottom: 1rem; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--gray-600); flex-wrap: wrap; gap: 0.5rem; }
        .progress-bar { height: 6px; background-color: var(--gray-200); border-radius: var(--radius-full); overflow: hidden; width: 100%; }
        .progress-fill { height: 100%; border-radius: var(--radius-full); background: linear-gradient(90deg, var(--primary-500), var(--medical-teal)); transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .project-links { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .project-link { display: flex; align-items: center; gap: 0.5rem; color: var(--primary-600); text-decoration: none; font-size: 0.8125rem; font-weight: 500; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); transition: var(--transition); white-space: nowrap; }
        .project-link:hover { background-color: var(--primary-50); color: var(--primary-700); border-color: var(--primary-300); }
        .feedback-section { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); flex-wrap: wrap; }
        .feedback-badge { background: linear-gradient(135deg, var(--warning), #f59e0b); color: var(--white); font-size: 0.75rem; padding: 4px 10px; border-radius: var(--radius-full); font-weight: 700; letter-spacing: 0.3px; box-shadow: var(--shadow); white-space: nowrap; }
        .feedback-channels { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .channel-btn { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--white); text-decoration: none; font-size: 0.875rem; transition: var(--transition); box-shadow: var(--shadow); flex-shrink: 0; }
        .channel-btn:hover { transform: scale(1.1); box-shadow: var(--shadow-md); }
        .channel-btn.whatsapp { background-color: #25D366; }
        .channel-btn.email { background-color: var(--primary-600); }
        .channel-btn.github { background-color: var(--gray-800); }
        .channel-btn.slack { background-color: #4A154B; }
        .project-actions { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .action-btn { padding: 6px 12px; border-radius: var(--radius); border: 1px solid; font-family: var(--font-sans); font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .edit-btn { background: var(--primary-50); color: var(--primary-700); border-color: var(--primary-200); }
        .edit-btn:hover { background: var(--primary-100); border-color: var(--primary-300); transform: translateY(-2px); }
        .delete-btn { background: #fee2e2; color: #dc2626; border-color: #fee2e2; }
        .delete-btn:hover { background: #dc2626; color: white; border-color: #dc2626; transform: translateY(-2px); }
        .recommend-btn { background: #fef3c7; color: #92400e; border-color: #fef3c7; }
        .recommend-btn:hover { background: #f59e0b; color: white; border-color: #f59e0b; transform: translateY(-2px); }
        .recommend-btn.recommended { background: #f59e0b; color: white; border-color: #f59e0b; }

        /* ===== AUTH SECTION ===== */
        .auth-section { display: flex; align-items: center; }
        .auth-btn { padding: 0.75rem 1.5rem; background: linear-gradient(135deg, var(--primary-600), var(--primary-700)); color: var(--white); border: none; border-radius: var(--radius); font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-full); padding: 0.5rem 0.75rem; box-shadow: var(--shadow); max-width: 300px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-500), var(--medical-teal)); color: var(--white); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem; }
        .user-info { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
        .user-name { font-weight: 600; font-size: 0.875rem; color: var(--gray-800); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: var(--radius-full); width: fit-content; }
        .user-role.admin { background: #fee2e2; color: #dc2626; }
        .user-role.doctor { background: #dbeafe; color: #1d4ed8; }
        .user-role.guest { background: #f3f4f6; color: #4b5563; }
        .logout-btn { background: transparent; border: none; color: var(--gray-500); cursor: pointer; padding: 0.5rem; border-radius: var(--radius); transition: var(--transition); }
        .logout-btn:hover { background: var(--gray-100); color: var(--danger); }

        /* ===== MODALS ===== */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; overflow-y: auto; }
        .modal-content { background: var(--bg-card); border-radius: 1rem; width: 100%; max-width: 500px; box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1); max-height: 90vh; overflow-y: auto; margin: auto; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg-card); z-index: 1; }
        .modal-header h3 { font-family: var(--font-heading); font-size: 1.25rem; font-weight: 600; color: var(--gray-900); display: flex; align-items: center; gap: 0.75rem; }
        .modal-close { background: transparent; border: none; font-size: 1.5rem; color: var(--gray-500); cursor: pointer; padding: 0.25rem; border-radius: var(--radius); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: var(--gray-100); color: var(--gray-700); }
        .modal-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-control { width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.9375rem; transition: var(--transition); font-family: var(--font-sans); background: var(--bg-card); color: var(--gray-900); }
        .form-control:focus { outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
        .btn-primary { width: 100%; padding: 0.875rem; background: linear-gradient(135deg, var(--primary-600), var(--primary-700)); color: var(--white); border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 1rem; }
        .btn-primary:hover { background: linear-gradient(135deg, var(--primary-700), var(--primary-800)); transform: translateY(-2px); box-shadow: var(--shadow); }
        .error-message { background: #fee2e2; color: #dc2626; padding: 1rem; border-radius: var(--radius); margin-top: 1rem; border-left: 4px solid #dc2626; display: none; }
        .success-message { background: #d1fae5; color: #065f46; padding: 1rem; border-radius: var(--radius); margin-top: 1rem; border-left: 4px solid #10b981; display: none; }

        /* ===== CODE MANAGEMENT ===== */
        .codes-table-container { max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 1rem; }
        .codes-table { width: 100%; border-collapse: collapse; }
        .codes-table th { background: var(--gray-50); position: sticky; top: 0; padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem; color: var(--gray-700); border-bottom: 2px solid var(--border); }
        .codes-table td { padding: 0.75rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .codes-table tr:hover { background: var(--gray-50); }
        .code-display { font-family: monospace; font-size: 1.1rem; letter-spacing: 2px; background: var(--primary-50); padding: 6px 10px; border-radius: var(--radius); display: inline-block; }
        .qr-container { text-align: center; padding: 1rem; background: var(--gray-50); border-radius: var(--radius); margin: 1rem 0; border: 1px solid var(--border); }
        .qr-code { width: 200px; height: 200px; margin: 0 auto 0.75rem; padding: 0.75rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow); }

        /* ===== COMMENTS MODAL ===== */
        .comments-list { max-height: 400px; overflow-y: auto; margin-bottom: 1rem; }
        .comment-item { background: var(--gray-50); border-radius: var(--radius); padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid var(--primary-500); }
        .comment-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .comment-author { font-weight: 600; color: var(--gray-800); }
        .comment-date { color: var(--gray-500); }
        .comment-text { color: var(--gray-700); line-height: 1.5; }
        .comment-status { font-size: 0.75rem; padding: 2px 8px; border-radius: var(--radius-full); margin-left: 0.5rem; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-approved { background: #d1fae5; color: #065f46; }

        /* ===== FOOTER ===== */
        .footer { text-align: center; padding: 2rem 0; color: var(--gray-500); font-size: 0.875rem; border-top: 1px solid var(--border); margin-top: 2rem; }
        .footer a { color: var(--primary-600); text-decoration: none; font-weight: 500; transition: var(--transition); }
        .footer a:hover { color: var(--primary-700); text-decoration: underline; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            .header { flex-direction: column; align-items: stretch; gap: 1rem; }
            .header-right { flex-direction: column; gap: 1rem; width: 100%; }
            .status-panel, .user-profile { width: 100%; justify-content: center; }
            .stats-container { grid-template-columns: 1fr; }
            .admin-controls { justify-content: center; }
            .filter-controls { justify-content: center; }
            .tools-grid { grid-template-columns: 1fr; }
            .modal-content { max-width: 95%; margin: 0.5rem; }
            .guest-welcome-content { flex-direction: column; }
            .guest-welcome-icon { align-self: center; }
            .content-grid { gap: 1rem; }
        }

        @media (max-width: 480px) {
            .platform-name { font-size: 1.25rem; }
            .logo { width: 48px; height: 48px; }
            .windows-grid { width: 28px; height: 28px; }
            .auth-btn { width: 100%; justify-content: center; }
            .user-profile { flex-direction: column; text-align: center; }
            .guest-welcome-actions { flex-direction: column; }
            .welcome-btn { width: 100%; justify-content: center; }
            .comment-actions { flex-direction: column; }
            .comment-btn { width: 100%; justify-content: center; }
            .project-actions { flex-direction: column; }
            .action-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with IMPROVED Microsoft-style logo -->
        <header class="header">
            <div class="logo-section">
                <div class="logo">
                    <div class="windows-grid">
                        <div class="window-pane pane1"></div>
                        <div class="window-pane pane2"></div>
                        <div class="window-pane pane3"></div>
                        <div class="window-pane pane4"></div>
                    </div>
                    <div class="logo-text">TRAci</div>
                </div>
                <div class="platform-info">
                    <h1 class="platform-name">TRAci Innovation Dashboard</h1>
                    <p class="department-name">Pneumology Innovation Department</p>
                </div>
            </div>
            
            <div class="header-right">
                <div class="status-panel">
                    <span>Updated: <strong id="lastUpdatedTime">Loading...</strong></span>
                    <span class="live-indicator">
                        <span class="live-dot"></span> LIVE
                    </span>
                </div>
                
                <!-- Authentication Section -->
                <div class="auth-section" id="authSection">
                    <!-- Guest View -->
                    <div id="guestView">
                        <button id="loginBtn" class="auth-btn">
                            <i class="mdi mdi-login"></i>
                            <span>Login</span>
                        </button>
                    </div>
                    
                    <!-- User View -->
                    <div id="userView" class="hidden">
                        <div class="user-profile">
                            <div class="user-avatar" id="userAvatar"></div>
                            <div class="user-info">
                                <span class="user-name" id="currentUsername"></span>
                                <span class="user-role" id="currentUserRole"></span>
                            </div>
                            <button class="logout-btn" id="logoutBtn" title="Logout">
                                <i class="mdi mdi-logout"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- GUEST WELCOME SECTION (NEW IMPROVEMENT) -->
        <div id="guestWelcome" class="hidden guest-welcome">
            <div class="guest-welcome-content">
                <div class="guest-welcome-icon">
                    <i class="mdi mdi-hand-wave"></i>
                </div>
                <div class="guest-welcome-text">
                    <h3>Welcome, Guest!</h3>
                    <p>
                        You're viewing our public innovation portfolio. Some projects are private/internal. 
                        For collaboration inquiries‚Äîespecially regarding <strong>Pulmonology patient care</strong> 
                        and <strong>clinical assistive technologies</strong>‚Äîplease contact our department directly.
                    </p>
                    <div class="guest-welcome-actions">
                        <button id="contactBtn" class="welcome-btn primary">
                            <i class="mdi mdi-email-send"></i>
                            Contact Department
                        </button>
                        <button id="viewPublicCommentsBtn" class="welcome-btn secondary">
                            <i class="mdi mdi-comment-multiple"></i>
                            View Public Comments
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GUEST COMMENT SECTION (NEW IMPROVEMENT) -->
        <div id="guestCommentSection" class="hidden comment-section">
            <div class="comment-header">
                <div class="comment-icon">
                    <i class="mdi mdi-comment-text-multiple"></i>
                </div>
                <h3>Share Your Thoughts</h3>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--gray-700); font-weight: 500;">
                    <i class="mdi mdi-message-text"></i>
                    Comment (max 150 words)
                </label>
                <textarea id="guestComment" class="comment-textarea" placeholder="Share your feedback, questions, or collaboration ideas..."></textarea>
                <div class="comment-meta">
                    <small class="text-muted">
                        <i class="mdi mdi-shield-check"></i>
                        Comments are moderated before appearing
                    </small>
                    <span id="wordCount" style="font-size: 0.875rem; color: var(--gray-500);">0/150 words</span>
                </div>
            </div>
            
            <div class="comment-actions">
                <button id="submitCommentBtn" class="comment-btn primary">
                    <i class="mdi mdi-send"></i>
                    Submit Comment
                </button>
                <button id="viewCommentsBtn" class="comment-btn secondary">
                    <i class="mdi mdi-eye"></i>
                    View Public Comments
                </button>
            </div>
            
            <div id="commentSuccess" class="comment-success">
                <i class="mdi mdi-check-circle"></i>
                <span>Comment submitted for moderation. Thank you!</span>
            </div>
        </div>

        <!-- Admin Controls -->
        <div class="admin-controls hidden" id="adminControls">
            <button class="admin-btn" id="addProjectBtn">
                <i class="mdi mdi-plus-circle"></i>
                <span>Add Project</span>
            </button>
            <button class="admin-btn" id="addToolBtn">
                <i class="mdi mdi-toolbox"></i>
                <span>Add Tool</span>
            </button>
            <button class="admin-btn" id="viewCodesBtn">
                <i class="mdi mdi-key-chain"></i>
                <span>View Codes</span>
            </button>
            <button class="admin-btn" id="resetCodeBtn">
                <i class="mdi mdi-key-change"></i>
                <span>Reset Code</span>
            </button>
            <!-- NEW: Manage Comments Button -->
            <button class="admin-btn" id="manageCommentsBtn">
                <i class="mdi mdi-comment-processing"></i>
                <span>Manage Comments</span>
            </button>
        </div>

        <!-- Stats Overview -->
        <div class="stats-container hidden" id="statsContainer">
            <div class="stat-card">
                <div class="stat-icon tools">
                    <i class="mdi mdi-toolbox"></i>
                </div>
                <div class="stat-info">
                    <h3>Active Tools</h3>
                    <div class="stat-number" id="toolsCount">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon projects">
                    <i class="mdi mdi-flask-outline"></i>
                </div>
                <div class="stat-info">
                    <h3>Research Projects</h3>
                    <div class="stat-number" id="projectsCount">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon feedback">
                    <i class="mdi mdi-message-text-outline"></i>
                </div>
                <div class="stat-info">
                    <h3>Awaiting Review</h3>
                    <div class="stat-number" id="feedbackCount">0</div>
                </div>
            </div>
            <!-- NEW: Comments Stat -->
            <div class="stat-card">
                <div class="stat-icon comments">
                    <i class="mdi mdi-comment-text-multiple"></i>
                </div>
                <div class="stat-info">
                    <h3>Guest Comments</h3>
                    <div class="stat-number" id="commentsCount">0</div>
                </div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls hidden" id="filterControls">
            <button class="filter-btn active" data-filter="all">
                <i class="mdi mdi-view-grid"></i>
                <span>All Projects</span>
            </button>
            <button class="filter-btn" data-filter="needs_feedback">
                <i class="mdi mdi-alert-circle"></i>
                <span>Needs Review</span>
            </button>
            <button class="filter-btn" data-filter="private">
                <i class="mdi mdi-lock"></i>
                <span>Private</span>
            </button>
            <button class="filter-btn" data-filter="public">
                <i class="mdi mdi-earth"></i>
                <span>Public</span>
            </button>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid" id="contentGrid">
            <!-- Tools Section -->
            <div class="section">
                <div class="section-header">
                    <h2>
                        <i class="mdi mdi-toolbox"></i>
                        <span>Tools & Resources</span>
                    </h2>
                </div>
                <div class="section-content">
                    <div class="tools-grid" id="toolsGrid">
                        <!-- Tools loaded dynamically -->
                    </div>
                </div>
            </div>

            <!-- Projects Section -->
            <div class="section">
                <div class="section-header">
                    <h2>
                        <i class="mdi mdi-flask"></i>
                        <span>Research Projects</span>
                    </h2>
                    <div class="feedback-badge hidden" id="feedbackBadge">
                        <!-- Feedback count loaded dynamically -->
                    </div>
                </div>
                <div class="section-content">
                    <div class="projects-list" id="projectsList">
                        <!-- Projects loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Required Section -->
        <div class="section hidden" id="loginRequiredSection">
            <div class="section-content text-center" style="padding: 4rem 1.5rem;">
                <div style="font-size: 4rem; color: var(--primary-300); margin-bottom: 1.5rem;">
                    <i class="mdi mdi-lock-outline"></i>
                </div>
                <h2 style="font-family: var(--font-heading); margin-bottom: 1rem;">
                    Secure Innovation Dashboard
                </h2>
                <p class="text-muted" style="max-width: 500px; margin: 0 auto 2rem;">
                    Access to the Pneumology Innovation Dashboard is restricted to authorized personnel only. 
                    Please login with your credentials to continue.
                </p>
                <button id="loginRequiredBtn" class="auth-btn">
                    <i class="mdi mdi-login"></i>
                    <span>Login to Continue</span>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>
                <strong>TRAci</strong> | Pneumology Innovation Dashboard ‚Ä¢ 
                <a href="#" id="refreshLink">
                    <i class="mdi mdi-refresh"></i>
                    <span>Refresh Data</span>
                </a>
            </p>
            <p style="margin-top: 0.5rem; font-size: 0.8125rem;">
                <i class="mdi mdi-shield-check"></i>
                <span>Secure Platform ‚Ä¢ </span>
                <i class="mdi mdi-sync"></i>
                <span>Auto-sync: </span>
                <span id="syncTime">Offline</span>
            </p>
        </footer>
    </div>

    <!-- ===== ALL MODALS ===== -->

    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="mdi mdi-shield-lock-outline"></i>
                    <span>Secure Login</span>
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" class="form-control" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter password">
                </div>
                <button id="submitLogin" class="btn-primary">
                    <i class="mdi mdi-login"></i>
                    <span>Sign In</span>
                </button>
                <div class="form-footer" style="margin-top: 1.25rem; text-align: center; color: var(--gray-500);">
                    <p class="hint">
                        <i class="mdi mdi-information"></i>
                        <span>Authorized personnel only</span>
                    </p>
                </div>
                <div id="loginError" class="error-message"></div>
            </div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="mdi mdi-plus-circle"></i>
                    <span>Add New Project</span>
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="projectName">Project Name *</label>
                    <input type="text" id="projectName" class="form-control" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label for="projectDescription">Description</label>
                    <textarea id="projectDescription" class="form-control" placeholder="Project description" rows="3"></textarea>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label for="projectStatus">Status</label>
                        <select id="projectStatus" class="form-control">
                            <option value="planning">Planning</option>
                            <option value="development" selected>Development</option>
                            <option value="testing">Testing</option>
                            <option value="production">Production</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="projectProgress">Progress (%)</label>
                        <input type="number" id="projectProgress" class="form-control" min="0" max="100" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="projectNeedsFeedback">
                        <i class="mdi mdi-alert-circle"></i>
                        <span>Needs Feedback/Review</span>
                    </label>
                </div>
                <button id="saveProjectBtn" class="btn-primary">
                    <i class="mdi mdi-content-save"></i>
                    <span>Save Project</span>
                </button>
                <div id="projectError" class="error-message"></div>
                <div id="projectSuccess" class="success-message"></div>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="mdi mdi-pencil"></i>
                    <span>Edit Project</span>
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProjectId">
                <!-- Edit Code Section (for doctors) -->
                <div id="editCodeSection" class="hidden">
                    <div class="form-group">
                        <label for="editCodeVerification">Edit Verification Code *</label>
                        <input type="password" id="editCodeVerification" class="form-control edit-code-input" placeholder="Enter 5-digit code" maxlength="5" pattern="\d{5}" style="font-family: monospace; font-size: 1.25rem; letter-spacing: 8px; text-align: center; padding: 12px;">
                        <small class="text-muted">5-digit code required for doctor edits</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editProjectName">Project Name *</label>
                    <input type="text" id="editProjectName" class="form-control" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label for="editProjectDescription">Description</label>
                    <textarea id="editProjectDescription" class="form-control" placeholder="Project description" rows="3"></textarea>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label for="editProjectStatus">Status</label>
                        <select id="editProjectStatus" class="form-control">
                            <option value="planning">Planning</option>
                            <option value="development">Development</option>
                            <option value="testing">Testing</option>
                            <option value="production">Production</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editProjectProgress">Progress (%)</label>
                        <input type="number" id="editProjectProgress" class="form-control" min="0" max="100" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="editProjectNeedsFeedback">
                        <i class="mdi mdi-alert-circle"></i>
                        <span>Needs Feedback/Review</span>
                    </label>
                </div>
                <!-- Visibility Control (admin only) -->
                <div id="visibilityControl" class="hidden">
                    <div class="form-group">
                        <label for="editProjectVisibility">Visibility</label>
                        <select id="editProjectVisibility" class="form-control">
                            <option value="public">üåç Public (All users)</option>
                            <option value="private">üîí Private (Doctors & Admin only)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <button id="updateProjectBtn" class="btn-primary">
                        <i class="mdi mdi-content-save"></i>
                        <span>Update Project</span>
                    </button>
                    <button id="deleteProjectBtn" class="btn-primary" style="background: linear-gradient(135deg, #dc2626, #b91c1c);">
                        <i class="mdi mdi-delete"></i>
                        <span>Delete Project</span>
                    </button>
                </div>
                <div id="editProjectError" class="error-message"></div>
                <div id="editProjectSuccess" class="success-message"></div>
            </div>
        </div>
    </div>

    <!-- Add Tool Modal -->
    <div id="addToolModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="mdi mdi-toolbox"></i>
                    <span>Add New Tool</span>
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="toolName">Tool Name *</label>
                    <input type="text" id="toolName" class="form-control" placeholder="Enter tool name">
                </div>
                <div class="form-group">
                    <label for="toolDescription">Description</label>
                    <textarea id="toolDescription" class="form-control" placeholder="Tool description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="toolUrl">URL *</label>
                    <input type="url" id="toolUrl" class="form-control" placeholder="https://tool.example.com">
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label for="toolStatus">Status</label>
                        <select id="toolStatus" class="form-control">
                            <option value="operational" selected>Operational</option>
                            <option value="warning">Needs Attention</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="toolIcon">Icon Class</label>
                        <input type="text" id="toolIcon" class="form-control" placeholder="mdi mdi-toolbox" value="mdi mdi-toolbox">
                    </div>
                </div>
                <button id="saveToolBtn" class="btn-primary">
                    <i class="mdi mdi-content-save"></i>
                    <span>Save Tool</span>
                </button>
                <div id="toolError" class="error-message"></div>
                <div id="toolSuccess" class="success-message"></div>
            </div>
        </div>
    </div>

    <!-- View Edit Codes Modal -->
    <div id="viewCodesModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>
                    <i class="mdi mdi-key-chain"></i>
                    <span>Project Edit Codes</span>
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="codeSearch" class="form-control" placeholder="Search projects by name...">
                </div>
                <div class="codes-table-container">
                    <table class="codes-table">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Edit Code</th>
                                <th>Visibility</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="codesTableBody">
                            <!-- Codes loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="form-footer" style="margin-top: 1.25rem; text-align: center; color: var(--gray-500);">
                    <p class="hint">
                        <i class="mdi mdi-information"></i>
                        <span>Doctors need these 5-digit codes to edit projects</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Code Modal -->
    <div id="resetCodeModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h3>
                    <i class="mdi mdi-key-change"></i>
                    <span>Reset Project Code</span>
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="resetProjectSelect">Select Project</label>
                    <select id="resetProjectSelect" class="form-control">
                        <option value="">-- Choose a project --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Current Code</label>
                    <div id="currentCodeDisplay" class="form-control code-display" style="text-align: center; padding: 15px;">-----</div>
                </div>
                <div class="form-group">
                    <label for="newCodeOption">New Code Options</label>
                    <select id="newCodeOption" class="form-control">
                        <option value="random">Generate Random Code</option>
                        <option value="custom">Enter Custom Code</option>
                    </select>
                </div>
                <div id="customCodeSection" class="form-group hidden">
                    <label for="customCode">Custom 5-digit Code</label>
                    <input type="text" id="customCode" class="form-control edit-code-input" maxlength="5" pattern="\d{5}" placeholder="12345" style="font-family: monospace; font-size: 1.25rem; letter-spacing: 8px; text-align: center; padding: 12px;">
                    <small class="text-muted">Must be exactly 5 digits (0-9)</small>
                </div>
                <button id="generateCodeBtn" class="btn-primary">
                    <i class="mdi mdi-refresh"></i>
                    <span>Generate New Code</span>
                </button>
                <div id="qrCodeSection" class="hidden">
                    <div class="qr-container">
                        <h4 style="margin-bottom: 0.75rem; color: var(--gray-700);">
                            <i class="mdi mdi-qrcode"></i>
                            Scan to Share
                        </h4>
                        <div id="qrCode" class="qr-code"></div>
                        <p class="text-muted" style="font-size: 0.875rem;">
                            Doctor can scan this QR code to get the edit code
                        </p>
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 1rem;">
                    <button id="copyCodeBtn" class="btn-primary" style="background: var(--medical-teal);">
                        <i class="mdi mdi-content-copy"></i>
                        <span>Copy Code</span>
                    </button>
                    <button id="showQRBtn" class="btn-primary" style="background: var(--medical-purple);">
                        <i class="mdi mdi-qrcode"></i>
                        <span>Show QR</span>
                    </button>
                    <button id="notifyDoctorBtn" class="btn-primary">
                        <i class="mdi mdi-email-send"></i>
                        <span>Email</span>
                    </button>
                </div>
                <div id="resetCodeError" class="error-message"></div>
                <div id="resetCodeSuccess" class="success-message"></div>
            </div>
        </div>
    </div>

    <!-- Comments Modal (NEW) -->
    <div id="commentsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>
                    <i class="mdi mdi-comment-multiple"></i>
                    <span>Public Comments</span>
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="commentsList" class="comments-list">
                    <!-- Comments loaded here -->
                </div>
                <div class="form-footer" style="margin-top: 1.25rem; text-align: center; color: var(--gray-500);">
                    <p class="hint">
                        <i class="mdi mdi-shield-star"></i>
                        <span>All comments are reviewed before publication</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Comments Modal (NEW) -->
    <div id="manageCommentsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>
                    <i class="mdi mdi-comment-processing"></i>
                    <span>Manage Comments</span>
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="commentSearch" class="form-control" placeholder="Search comments...">
                </div>
                <div class="codes-table-container">
                    <table class="codes-table">
                        <thead>
                            <tr>
                                <th>Comment</th>
                                <th>Author</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="commentsTableBody">
                            <!-- Comments loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="form-footer" style="margin-top: 1.25rem; text-align: center; color: var(--gray-500);">
                    <p class="hint">
                        <i class="mdi mdi-information"></i>
                        <span>Approve comments to make them publicly visible</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== COMPLETE JAVASCRIPT ===== -->
    <script>
        // ========== CONFIGURATION ==========
        const SUPABASE_URL = 'https://bledpouekiytppuhxeqq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_zdlIM8UbOrRIFpmYLJOmWQ_4QqNi_5C';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ========== STATE MANAGEMENT ==========
        let currentUser = null;
        let authToken = localStorage.getItem('traci_auth_token');
        let dashboardData = {
            projects: [],
            tools: [],
            filteredProjects: [],
            comments: [],
            lastUpdated: new Date()
        };

        // ========== PASSWORD HASHING ==========
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ========== AUTHENTICATION FUNCTIONS ==========
        async function loginUser(username, password) {
            const errorEl = document.getElementById('loginError');
            errorEl.style.display = 'none';
            
            try {
                const hashedPassword = await hashPassword(password);
                
                const { data, error } = await supabaseClient
                    .from('dashboard_users')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                if (error || !data) {
                    errorEl.textContent = 'Invalid username or password';
                    errorEl.style.display = 'block';
                    return false;
                }
                
                if (data.password !== hashedPassword) {
                    errorEl.textContent = 'Invalid username or password';
                    errorEl.style.display = 'block';
                    return false;
                }
                
                currentUser = {
                    id: data.id,
                    username: data.username,
                    full_name: data.full_name,
                    role: data.role,
                    department: data.department
                };
                
                authToken = btoa(JSON.stringify(currentUser));
                localStorage.setItem('traci_auth_token', authToken);
                return true;
                
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = 'Login failed. Please try again.';
                errorEl.style.display = 'block';
                return false;
            }
        }

        function logoutUser() {
            currentUser = null;
            authToken = null;
            localStorage.removeItem('traci_auth_token');
            updateAuthUI();
            showLoginRequired();
        }

        function loadStoredUser() {
            if (authToken) {
                try {
                    currentUser = JSON.parse(atob(authToken));
                } catch (e) {
                    console.error('Failed to parse auth token:', e);
                    localStorage.removeItem('traci_auth_token');
                }
            }
        }

        // ========== UI MANAGEMENT FUNCTIONS ==========
        function updateAuthUI() {
            const guestView = document.getElementById('guestView');
            const userView = document.getElementById('userView');
            const loginRequiredSection = document.getElementById('loginRequiredSection');
            const statsContainer = document.getElementById('statsContainer');
            const adminControls = document.getElementById('adminControls');
            const contentGrid = document.getElementById('contentGrid');
            const filterControls = document.getElementById('filterControls');
            const guestWelcome = document.getElementById('guestWelcome');
            const guestCommentSection = document.getElementById('guestCommentSection');
            
            if (currentUser) {
                guestView.classList.add('hidden');
                userView.classList.remove('hidden');
                loginRequiredSection.classList.add('hidden');
                
                // Set user avatar initials
                const avatar = document.getElementById('userAvatar');
                const name = currentUser.full_name || currentUser.username;
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                avatar.textContent = initials;
                
                // Set username
                document.getElementById('currentUsername').textContent = 
                    currentUser.full_name || currentUser.username;
                
                // Set role badge
               // Set role badge
const roleBadge = document.getElementById('currentUserRole');
roleBadge.textContent = currentUser.role;
roleBadge.className = `user-role ${currentUser.role}`;

// Show content based on role
statsContainer.classList.remove('hidden');
contentGrid.classList.remove('hidden');
await initDashboard();

if (currentUser.role === 'guest') {
    filterControls.classList.add('hidden');
    adminControls.classList.add('hidden');
    guestWelcome.classList.remove('hidden');
    guestCommentSection.classList.remove('hidden');
    
    // Initialize word counter for guest comment
    const commentTextarea = document.getElementById('guestComment');
    if (commentTextarea) {
        commentTextarea.addEventListener('input', function() {
            const text = this.value.trim();
            const words = text ? text.split(/\s+/).filter(word => word.length > 0).length : 0;
            document.getElementById('wordCount').textContent = `${words}/150 words`;
            
            if (words > 150) {
                const truncated = text.split(/\s+/).slice(0, 150).join(' ');
                this.value = truncated;
                document.getElementById('wordCount').textContent = '150/150 words';
            }
        });
    }
} else {
    filterControls.classList.remove('hidden');
    guestWelcome.classList.add('hidden');
    guestCommentSection.classList.add('hidden');
    
    if (currentUser.role === 'admin') {
        adminControls.classList.remove('hidden');
    } else {
        adminControls.classList.add('hidden');
    }
}

} else {
    guestView.classList.remove('hidden');
    userView.classList.add('hidden');
    adminControls.classList.add('hidden');
    guestWelcome.classList.add('hidden');
    guestCommentSection.classList.add('hidden');
    showLoginRequired();
}
}

function showLoginRequired() {
document.getElementById('loginRequiredSection').classList.remove('hidden');
document.getElementById('statsContainer').classList.add('hidden');
document.getElementById('adminControls').classList.add('hidden');
document.getElementById('filterControls').classList.add('hidden');
document.getElementById('contentGrid').classList.add('hidden');
}

// ========== MODAL MANAGEMENT ==========
const modals = {
login: document.getElementById('loginModal'),
addProject: document.getElementById('addProjectModal'),
editProject: document.getElementById('editProjectModal'),
addTool: document.getElementById('addToolModal'),
viewCodes: document.getElementById('viewCodesModal'),
resetCode: document.getElementById('resetCodeModal'),
comments: document.getElementById('commentsModal'),
manageComments: document.getElementById('manageCommentsModal')
};

function showModal(modalName) {
Object.values(modals).forEach(modal => {
    if (modal) modal.style.display = 'none';
});
if (modals[modalName]) {
    modals[modalName].style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Focus on first input
    setTimeout(() => {
        const firstInput = modals[modalName].querySelector('input, textarea, select');
        if (firstInput) firstInput.focus();
    }, 100);
}
}

function hideAllModals() {
Object.values(modals).forEach(modal => {
    if (modal) modal.style.display = 'none';
});
document.body.style.overflow = 'auto';
clearFormMessages();
}

function clearFormMessages() {
document.querySelectorAll('.error-message, .success-message').forEach(el => {
    el.style.display = 'none';
    el.textContent = '';
});
}

// ========== DASHBOARD FUNCTIONS ==========
async function initDashboard() {
showLoadingState();

try {
    await Promise.all([
        fetchProjects(),
        fetchTools(),
        fetchComments()
    ]);
    
    updateStats();
    renderDashboard();
    updateTimestamp();
    
} catch (error) {
    console.error('Error loading dashboard:', error);
    showErrorState();
}
}

async function fetchProjects() {
let query = supabaseClient
    .from('projects')
    .select(`
        *,
        feedback_channels (*)
    `);

// Apply visibility filter for guests
if (currentUser && currentUser.role === 'guest') {
    query = query.eq('visibility', 'public');
}

const { data, error } = await query
    .order('needs_feedback', { ascending: false })
    .order('created_at', { ascending: false });

if (error) {
    console.error('Error fetching projects:', error);
    dashboardData.projects = [];
    return;
}

dashboardData.projects = data || [];
dashboardData.filteredProjects = [...dashboardData.projects];
}

async function fetchTools() {
const { data, error } = await supabaseClient
    .from('tools')
    .select('*')
    .order('created_at', { ascending: false });

if (error) {
    console.error('Error fetching tools:', error);
    dashboardData.tools = [];
    return;
}

dashboardData.tools = data || [];
}

async function fetchComments() {
// Only fetch approved comments for public viewing
const { data, error } = await supabaseClient
    .from('guest_comments')
    .select('*')
    .eq('status', 'approved')
    .order('created_at', { ascending: false });

if (error) {
    console.error('Error fetching comments:', error);
    dashboardData.comments = [];
    return;
}

dashboardData.comments = data || [];
}

// ========== COMMENT SYSTEM ==========
async function submitGuestComment(commentText) {
if (!currentUser) {
    alert('Please login to submit comments');
    showModal('login');
    return { success: false, error: 'Not logged in' };
}

try {
    const { data, error } = await supabaseClient
        .from('guest_comments')
        .insert([{
            comment: commentText,
            status: 'pending',
            created_at: new Date().toISOString(),
            author_name: currentUser.full_name || currentUser.username,
            author_email: null
        }])
        .select()
        .single();
    
    if (error) throw error;
    
    document.getElementById('commentSuccess').style.display = 'flex';
    document.getElementById('guestComment').value = '';
    document.getElementById('wordCount').textContent = '0/150 words';
    
    setTimeout(() => {
        document.getElementById('commentSuccess').style.display = 'none';
    }, 3000);
    
    // Refresh comments count
    await fetchComments();
    updateStats();
    
    return { success: true, data };
    
} catch (error) {
    console.error('Error submitting comment:', error);
    alert('Failed to submit comment: ' + error.message);
    return { success: false, error: error.message };
}
}

async function loadPublicComments() {
try {
    const { data, error } = await supabaseClient
        .from('guest_comments')
        .select('*')
        .eq('status', 'approved')
        .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    const commentsList = document.getElementById('commentsList');
    
    if (!data || data.length === 0) {
        commentsList.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
                <i class="mdi mdi-comment-outline" style="font-size: 3rem; margin-bottom: 0.75rem;"></i>
                <p>No public comments yet. Be the first to share!</p>
            </div>
        `;
        return;
    }
    
    let commentsHTML = '';
    data.forEach(comment => {
        const date = new Date(comment.created_at);
        const dateStr = date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
        
        commentsHTML += `
            <div class="comment-item">
                <div class="comment-meta">
                    <span class="comment-author">${comment.author_name || 'Anonymous Guest'}</span>
                    <span class="comment-date">${dateStr}</span>
                </div>
                <div class="comment-text">${comment.comment}</div>
            </div>
        `;
    });
    
    commentsList.innerHTML = commentsHTML;
    
} catch (error) {
    console.error('Error loading comments:', error);
    document.getElementById('commentsList').innerHTML = `
        <div style="text-align: center; padding: 3rem; color: var(--danger);">
            <i class="mdi mdi-alert-circle" style="font-size: 3rem; margin-bottom: 0.75rem;"></i>
            <p>Failed to load comments</p>
        </div>
    `;
}
}

async function manageComments() {
try {
    const { data, error } = await supabaseClient
        .from('guest_comments')
        .select('*')
        .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    const tbody = document.getElementById('commentsTableBody');
    tbody.innerHTML = '';
    
    if (!data || data.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-500);">
                    No comments to manage
                </td>
            </tr>
        `;
        return;
    }
    
    data.forEach(comment => {
        const date = new Date(comment.created_at);
        const dateStr = date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric'
        });
        
        const statusBadge = comment.status === 'approved' 
            ? `<span class="comment-status status-approved">Approved</span>`
            : comment.status === 'rejected'
            ? `<span class="comment-status" style="background: #fee2e2; color: #dc2626;">Rejected</span>`
            : `<span class="comment-status status-pending">Pending</span>`;
        
        const actions = comment.status === 'pending' 
            ? `
                <button class="action-btn edit-btn" onclick="approveComment('${comment.id}')" style="font-size: 0.75rem;">
                    <i class="mdi mdi-check"></i> Approve
                </button>
                <button class="action-btn delete-btn" onclick="rejectComment('${comment.id}')" style="font-size: 0.75rem;">
                    <i class="mdi mdi-close"></i> Reject
                </button>
            `
            : `
                <button class="action-btn delete-btn" onclick="deleteComment('${comment.id}')" style="font-size: 0.75rem;">
                    <i class="mdi mdi-delete"></i> Delete
                </button>
            `;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="max-width: 300px; word-wrap: break-word;">
                ${comment.comment.substring(0, 100)}${comment.comment.length > 100 ? '...' : ''}
            </td>
            <td>${comment.author_name || 'Anonymous'}</td>
            <td>${dateStr}</td>
            <td>${statusBadge}</td>
            <td>${actions}</td>
        `;
        tbody.appendChild(row);
    });
    
} catch (error) {
    console.error('Error loading comments for management:', error);
    alert('Failed to load comments');
}
}

async function approveComment(commentId) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Only admins can approve comments');
    return;
}

try {
    const { error } = await supabaseClient
        .from('guest_comments')
        .update({
            status: 'approved',
            approved_by: currentUser.full_name || currentUser.username,
            approved_at: new Date().toISOString()
        })
        .eq('id', commentId);
    
    if (error) throw error;
    
    alert('Comment approved!');
    manageComments(); // Refresh the list
    initDashboard(); // Update stats
    
} catch (error) {
    console.error('Error approving comment:', error);
    alert('Failed to approve comment');
}
}

async function rejectComment(commentId) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Only admins can reject comments');
    return;
}

try {
    const { error } = await supabaseClient
        .from('guest_comments')
        .update({
            status: 'rejected',
            approved_by: currentUser.full_name || currentUser.username,
            approved_at: new Date().toISOString()
        })
        .eq('id', commentId);
    
    if (error) throw error;
    
    alert('Comment rejected');
    manageComments(); // Refresh the list
    
} catch (error) {
    console.error('Error rejecting comment:', error);
    alert('Failed to reject comment');
}
}

async function deleteComment(commentId) {
if (!currentUser || currentUser.role !== 'admin') {
    alert('Only admins can delete comments');
    return;
}

if (!confirm('Delete this comment permanently?')) return;

try {
    const { error } = await supabaseClient
        .from('guest_comments')
        .delete()
        .eq('id', commentId);
    
    if (error) throw error;
    
    alert('Comment deleted');
    manageComments(); // Refresh the list
    initDashboard(); // Update stats
    
} catch (error) {
    console.error('Error deleting comment:', error);
    alert('Failed to delete comment');
}
}

// ========== EDIT CODE MANAGEMENT ==========
async function loadEditCodes() {
try {
    const { data: projects, error } = await supabaseClient
        .from('projects')
        .select('id, name, edit_code, visibility, created_at')
        .order('name');
    
    if (error) throw error;
    
    const tbody = document.getElementById('codesTableBody');
    tbody.innerHTML = '';
    
    if (!projects || projects.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                    <i class="mdi mdi-information" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <p>No projects found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    projects.forEach(project => {
        const createdDate = new Date(project.created_at);
        const dateStr = createdDate.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: 'numeric'
        });
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div style="font-weight: 600;">${project.name}</div>
                <div style="font-size: 0.75rem; color: var(--gray-500);">
                    Created: ${dateStr}
                </div>
            </td>
            <td>
                <span class="code-display">${project.edit_code || 'Not set'}</span>
            </td>
            <td>
                ${project.visibility === 'private' 
                    ? '<span class="visibility-badge private"><i class="mdi mdi-lock"></i> Private</span>' 
                    : '<span class="visibility-badge public"><i class="mdi mdi-earth"></i> Public</span>'}
            </td>
            <td>
                <button class="action-btn edit-btn" onclick="resetSingleCode('${project.id}', '${project.name.replace(/'/g, "\\'")}')" style="font-size: 0.75rem;">
                    <i class="mdi mdi-refresh"></i>
                    Reset
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Setup search
    document.getElementById('codeSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const rows = tbody.querySelectorAll('tr');
        
        rows.forEach(row => {
            const projectName = row.querySelector('td:first-child').textContent.toLowerCase();
            row.style.display = projectName.includes(searchTerm) ? '' : 'none';
        });
    });
    
} catch (error) {
    console.error('Error loading edit codes:', error);
    alert('Failed to load edit codes');
}
}

async function resetSingleCode(projectId, projectName) {
if (!confirm(`Reset edit code for "${projectName}"?\n\nA new 5-digit code will be generated.`)) return;

try {
    const newCode = Math.floor(10000 + Math.random() * 90000).toString();
    
    const { error } = await supabaseClient
        .from('projects')
        .update({ 
            edit_code: newCode,
            last_updated: new Date().toISOString()
        })
        .eq('id', projectId);
    
    if (error) throw error;
    
    alert(`‚úÖ New code for "${projectName}": ${newCode}\n\nShare this code with doctors who need to edit this project.`);
    loadEditCodes(); // Refresh table
    
} catch (error) {
    console.error('Error resetting code:', error);
    alert('Failed to reset code');
}
}

// ========== PROJECT CRUD FUNCTIONS ==========
async function addProject(projectData) {
try {
    const editCode = Math.floor(10000 + Math.random() * 90000).toString();
    
    const { data, error } = await supabaseClient
        .from('projects')
        .insert([{
            ...projectData,
            edit_code: editCode,
            last_updated: new Date().toISOString(),
            visibility: 'public',
            created_at: new Date().toISOString()
        }])
        .select()
        .single();
    
    if (error) throw error;
    
    alert(`‚úÖ Project added successfully!\n\nüîê Doctor Edit Code: ${editCode}\n\nShare this code with doctors who need to edit this project.`);
    
    showSuccess('projectSuccess', 'Project added successfully!');
    setTimeout(() => {
        hideAllModals();
        initDashboard();
    }, 1500);
    
    return { success: true, data, code: editCode };
    
} catch (error) {
    console.error('Error adding project:', error);
    showError('projectError', 'Failed to add project: ' + error.message);
    return { success: false, error: error.message };
}
}

async function updateProject(projectId, projectData) {
try {
    if (currentUser && currentUser.role === 'doctor') {
        const enteredCode = document.getElementById('editCodeVerification').value;
        
        if (!enteredCode || !/^\d{5}$/.test(enteredCode)) {
            showError('editProjectError', 'Valid 5-digit edit code required');
            return { success: false, error: 'Invalid edit code format' };
        }
        
        const { data: project, error: fetchError } = await supabaseClient
            .from('projects')
            .select('edit_code')
            .eq('id', projectId)
            .single();
        
        if (fetchError || !project) {
            showError('editProjectError', 'Project not found');
            return { success: false, error: 'Project not found' };
        }
        
        if (enteredCode !== project.edit_code) {
            showError('editProjectError', 'Invalid edit code');
            return { success: false, error: 'Invalid edit code' };
        }
    }
    
    const { data, error } = await supabaseClient
        .from('projects')
        .update({
            ...projectData,
            last_updated: new Date().toISOString()
        })
        .eq('id', projectId)
        .select()
        .single();
    
    if (error) throw error;
    
    showSuccess('editProjectSuccess', 'Project updated successfully!');
    setTimeout(() => {
        hideAllModals();
        initDashboard();
    }, 1500);
    
    return { success: true, data };
    
} catch (error) {
    console.error('Error updating project:', error);
    showError('editProjectError', 'Failed to update project: ' + error.message);
    return { success: false, error: error.message };
}
}
async function deleteProject(projectId) {
    if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
        return { success: false, error: 'Cancelled by user' };
    }
    
    try {
        const { error } = await supabaseClient
            .from('projects')
            .delete()
            .eq('id', projectId);
        
        if (error) throw error;
        
        alert('Project deleted successfully!');
        hideAllModals();
        await initDashboard();
        return { success: true };
        
    } catch (error) {
        console.error('Error deleting project:', error);
        alert('Failed to delete project: ' + error.message);
        return { success: false, error: error.message };
    }
}

async function recommendProject(projectId) {
    try {
        const { data: project, error: fetchError } = await supabaseClient
            .from('projects')
            .select('name')
            .eq('id', projectId)
            .single();
        
        if (fetchError || !project) {
            alert('Project not found');
            return { success: false, error: 'Project not found' };
        }
        
        const { error } = await supabaseClient
            .from('projects')
            .update({
                recommended_by: currentUser.full_name || currentUser.username,
                needs_feedback: true,
                visibility: 'private',
                last_updated: new Date().toISOString()
            })
            .eq('id', projectId);
        
        if (error) throw error;
        
        alert('Project recommended for review!');
        await initDashboard();
        return { success: true };
        
    } catch (error) {
        console.error('Error recommending project:', error);
        alert('Failed to recommend project: ' + error.message);
        return { success: false, error: error.message };
    }
}

function loadProjectForEdit(project) {
    document.getElementById('editProjectId').value = project.id;
    document.getElementById('editProjectName').value = project.name || '';
    document.getElementById('editProjectDescription').value = project.description || '';
    document.getElementById('editProjectStatus').value = project.status || 'development';
    document.getElementById('editProjectProgress').value = project.progress || 0;
    document.getElementById('editProjectNeedsFeedback').checked = project.needs_feedback || false;
    
    const editCodeSection = document.getElementById('editCodeSection');
    const visibilityControl = document.getElementById('visibilityControl');
    
    if (currentUser && currentUser.role === 'doctor') {
        editCodeSection.classList.remove('hidden');
        visibilityControl.classList.add('hidden');
        document.getElementById('editCodeVerification').value = '';
    } else if (currentUser && currentUser.role === 'admin') {
        editCodeSection.classList.add('hidden');
        visibilityControl.classList.remove('hidden');
        document.getElementById('editProjectVisibility').value = project.visibility || 'public';
    } else {
        editCodeSection.classList.add('hidden');
        visibilityControl.classList.add('hidden');
    }
}

// ========== TOOL CRUD FUNCTIONS ==========
async function addTool(toolData) {
    try {
        const { data, error } = await supabaseClient
            .from('tools')
            .insert([{
                ...toolData,
                last_checked: new Date().toISOString(),
                created_at: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        showSuccess('toolSuccess', 'Tool added successfully!');
        setTimeout(() => {
            hideAllModals();
            initDashboard();
        }, 1500);
        
        return { success: true, data };
        
    } catch (error) {
        console.error('Error adding tool:', error);
        showError('toolError', 'Failed to add tool: ' + error.message);
        return { success: false, error: error.message };
    }
}

// ========== RESET CODE FUNCTIONS ==========
async function loadProjectsForReset() {
    try {
        const { data: projects, error } = await supabaseClient
            .from('projects')
            .select('id, name')
            .order('name');
        
        if (error) throw error;
        
        const select = document.getElementById('resetProjectSelect');
        select.innerHTML = '<option value="">-- Choose a project --</option>';
        
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading projects:', error);
    }
}

async function getProjectCode(projectId) {
    try {
        const { data, error } = await supabaseClient
            .from('projects')
            .select('edit_code, name')
            .eq('id', projectId)
            .single();
        
        if (error) throw error;
        
        return { success: true, code: data.edit_code, name: data.name };
        
    } catch (error) {
        console.error('Error getting project code:', error);
        return { success: false, error: error.message };
    }
}

async function resetProjectCode(projectId, newCode = null) {
    try {
        const editCode = newCode || Math.floor(10000 + Math.random() * 90000).toString();
        
        const { error } = await supabaseClient
            .from('projects')
            .update({ 
                edit_code: editCode,
                last_updated: new Date().toISOString()
            })
            .eq('id', projectId);
        
        if (error) throw error;
        
        return { success: true, code: editCode };
        
    } catch (error) {
        console.error('Error resetting code:', error);
        return { success: false, error: error.message };
    }
}

function generateQRCode(projectName, editCode) {
    const qrContainer = document.getElementById('qrCode');
    if (!qrContainer) return;
    
    qrContainer.innerHTML = '';
    
    const qrData = `TRAci Edit Code\n\nProject: ${projectName}\nCode: ${editCode}\n\nScan this code or enter manually`;
    
    QRCode.toCanvas(qrContainer, qrData, {
        width: 200,
        height: 200,
        margin: 1,
        color: {
            dark: '#0c4a6e',
            light: '#ffffff'
        }
    }, function(error) {
        if (error) {
            console.error('QR Code generation error:', error);
            qrContainer.innerHTML = '<p style="color: var(--danger);">Failed to generate QR code</p>';
        }
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Code copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy code');
    });
}

function notifyDoctor(projectName, editCode) {
    const subject = `TRAci Edit Code for ${projectName}`;
    const body = `Hello Doctor,\n\nYour edit code for project "${projectName}" is:\n\nüîê **${editCode}**\n\nUse this code to edit the project in the TRAci Innovation Dashboard.\n\nBest regards,\nPneumology Innovation Department`;
    
    window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
    return true;
}

// ========== RENDER FUNCTIONS ==========
function updateStats() {
    const toolsCount = dashboardData.tools.length;
    const projectsCount = dashboardData.projects.length;
    const feedbackCount = dashboardData.projects.filter(p => p.needs_feedback).length;
    const commentsCount = dashboardData.comments.length;

    document.getElementById('toolsCount').textContent = toolsCount;
    document.getElementById('projectsCount').textContent = projectsCount;
    document.getElementById('feedbackCount').textContent = feedbackCount;
    document.getElementById('commentsCount').textContent = commentsCount;

    const feedbackBadge = document.getElementById('feedbackBadge');
    if (feedbackCount > 0) {
        feedbackBadge.textContent = `${feedbackCount} need${feedbackCount > 1 ? '' : 's'} review`;
        feedbackBadge.classList.remove('hidden');
    } else {
        feedbackBadge.classList.add('hidden');
    }
}

function renderDashboard() {
    renderTools();
    renderProjects();
}

function renderTools() {
    const toolsGrid = document.getElementById('toolsGrid');
    
    if (dashboardData.tools.length === 0) {
        toolsGrid.innerHTML = `
            <div class="empty-state">
                <i class="mdi mdi-toolbox-outline" style="font-size: 3rem;"></i>
                <p>No tools found. ${currentUser && currentUser.role === 'admin' ? 'Click "Add Tool" to create one.' : 'Contact admin to add tools.'}</p>
            </div>
        `;
        return;
    }
    
    let toolsHTML = '';
    dashboardData.tools.forEach(tool => {
        const statusClass = tool.status === 'operational' ? 'status-operational' : 'status-warning';
        const statusText = tool.status === 'operational' ? 'Operational' : 'Needs Attention';
        
        const lastChecked = tool.last_checked ? 
            new Date(tool.last_checked).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric'
            }) : 'Never';
        
        toolsHTML += `
            <div class="tool-card ${tool.status}">
                <div class="tool-header">
                    <div class="tool-name">
                        <div class="tool-icon">
                            <i class="${tool.icon || 'mdi mdi-toolbox'}"></i>
                        </div>
                        <span>${tool.name}</span>
                    </div>
                    <span class="tool-status ${statusClass}">${statusText}</span>
                </div>
                <p class="tool-description">${tool.description || 'No description available'}</p>
                <div class="tool-footer">
                    <span class="tool-updated">
                        <i class="mdi mdi-clock-outline"></i>
                        Last checked: ${lastChecked}
                    </span>
                    <a href="${tool.url}" target="_blank" class="tool-link">
                        <i class="mdi mdi-open-in-new"></i>
                        Access
                    </a>
                </div>
            </div>
        `;
    });
    
    toolsGrid.innerHTML = toolsHTML;
}

function renderProjects() {
    const projectsList = document.getElementById('projectsList');
    const projectsToRender = dashboardData.filteredProjects.length > 0 
        ? dashboardData.filteredProjects 
        : dashboardData.projects;
    
    if (projectsToRender.length === 0) {
        projectsList.innerHTML = `
            <div class="empty-state">
                <i class="mdi mdi-flask-outline" style="font-size: 3rem;"></i>
                <p>No projects found. ${currentUser && currentUser.role === 'admin' ? 'Click "Add Project" to create one.' : 'Contact admin to add public projects.'}</p>
            </div>
        `;
        return;
    }
    
    let projectsHTML = '';
    projectsToRender.forEach(project => {
        const statusClass = `status-${project.status}`;
        const statusText = project.status.charAt(0).toUpperCase() + project.status.slice(1);
        
        const visibilityBadge = project.visibility === 'private' 
            ? `<span class="visibility-badge private" title="Visible to doctors and admin only">
                 <i class="mdi mdi-lock"></i> Private
               </span>`
            : `<span class="visibility-badge public" title="Visible to everyone">
                 <i class="mdi mdi-earth"></i> Public
               </span>`;
        
        let actionButtons = '';
        if (currentUser && currentUser.role !== 'guest') {
            if (currentUser.role === 'admin') {
                actionButtons = `
                    <div class="project-actions">
                        <button class="action-btn edit-btn" data-project-id="${project.id}">
                            <i class="mdi mdi-pencil"></i>
                            Edit
                        </button>
                        <button class="action-btn delete-btn" data-project-id="${project.id}">
                            <i class="mdi mdi-delete"></i>
                            Delete
                        </button>
                    </div>
                `;
            } else if (currentUser.role === 'doctor') {
                const isRecommended = project.recommended_by === (currentUser.full_name || currentUser.username);
                actionButtons = `
                    <div class="project-actions">
                        <button class="action-btn recommend-btn ${isRecommended ? 'recommended' : ''}" 
                                data-project-id="${project.id}">
                            <i class="mdi mdi-star${isRecommended ? '' : '-outline'}"></i>
                            ${isRecommended ? 'Recommended' : 'Recommend'}
                        </button>
                        <button class="action-btn edit-btn" data-project-id="${project.id}">
                            <i class="mdi mdi-pencil"></i>
                            Edit (with code)
                        </button>
                    </div>
                `;
            }
        }
        
        projectsHTML += `
            <div class="project-card ${project.needs_feedback ? 'needs-feedback' : ''}">
                <div class="project-header">
                    <div class="project-title">
                        <i class="mdi mdi-flask"></i>
                        ${project.name}
                        ${visibilityBadge}
                    </div>
                    <span class="project-status ${statusClass}">${statusText}</span>
                </div>
                
                <p class="project-description">${project.description || 'No description available'}</p>
                
                <div class="project-progress">
                    <div class="progress-label">
                        <span>Progress</span>
                        <span>${project.progress || 0}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                    </div>
                </div>
                
                ${actionButtons}
            </div>
        `;
    });
    
    projectsList.innerHTML = projectsHTML;
    
    // Add event listeners for action buttons
    if (currentUser && currentUser.role !== 'guest') {
        // Edit buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const projectId = this.dataset.projectId;
                const project = dashboardData.projects.find(p => p.id === projectId);
                if (project) {
                    loadProjectForEdit(project);
                    showModal('editProject');
                }
            });
        });
        
        // Delete buttons (admin only)
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const projectId = this.dataset.projectId;
                deleteProject(projectId);
            });
        });
        
        // Recommend buttons (doctors only)
        document.querySelectorAll('.recommend-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const projectId = this.dataset.projectId;
                recommendProject(projectId);
            });
        });
    }
}

// ========== FILTER FUNCTIONS ==========
function filterProjects(filterType) {
    // Update active filter button
    document.querySelectorAll('#filterControls .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filterType);
    });
    
    if (filterType === 'all') {
        dashboardData.filteredProjects = [...dashboardData.projects];
    } else if (filterType === 'needs_feedback') {
        dashboardData.filteredProjects = dashboardData.projects.filter(p => p.needs_feedback);
    } else if (filterType === 'private') {
        dashboardData.filteredProjects = dashboardData.projects.filter(p => p.visibility === 'private');
    } else if (filterType === 'public') {
        dashboardData.filteredProjects = dashboardData.projects.filter(p => p.visibility === 'public');
    }
    
    renderProjects();
}

// ========== HELPER FUNCTIONS ==========
function updateTimestamp() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
    });
    const dateString = now.toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric'
    });
    
    document.getElementById('lastUpdatedTime').textContent = `${dateString} at ${timeString}`;
    document.getElementById('syncTime').textContent = timeString;
    
    dashboardData.lastUpdated = now;
}

function showLoadingState() {
    document.getElementById('lastUpdatedTime').textContent = 'Loading...';
}

function showErrorState() {
    document.getElementById('lastUpdatedTime').textContent = 'Error loading data';
}

function showError(elementId, message) {
    const el = document.getElementById(elementId);
    if (el) {
        el.textContent = message;
        el.style.display = 'block';
    }
}

function showSuccess(elementId, message) {
    const el = document.getElementById(elementId);
    if (el) {
        el.textContent = message;
        el.style.display = 'block';
        setTimeout(() => {
            el.style.display = 'none';
        }, 3000);
    }
}

// ========== EVENT LISTENERS ==========
document.addEventListener('DOMContentLoaded', function() {
    // Initialize
    loadStoredUser();
    updateAuthUI();
    
    // Login button events
    document.getElementById('loginBtn').addEventListener('click', () => showModal('login'));
    document.getElementById('loginRequiredBtn').addEventListener('click', () => showModal('login'));
    
    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', logoutUser);
    
    // Modal close buttons
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', hideAllModals);
    });
    
    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) hideAllModals();
        });
    });
    
    // Login form submission
    document.getElementById('submitLogin').addEventListener('click', async function() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        
        if (!username || !password) {
            showError('loginError', 'Please enter both username and password');
            return;
        }
        
        this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Signing In...';
        this.disabled = true;
        
        const success = await loginUser(username, password);
        
        this.innerHTML = '<i class="mdi mdi-login"></i> Sign In';
        this.disabled = false;
        
        if (success) {
            hideAllModals();
            updateAuthUI();
        }
    });
    
    // Allow Enter key in login form
    document.getElementById('loginPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('submitLogin').click();
        }
    });
    
    // Admin buttons
    document.getElementById('addProjectBtn').addEventListener('click', () => {
        // Reset form
        document.getElementById('projectName').value = '';
        document.getElementById('projectDescription').value = '';
        document.getElementById('projectStatus').value = 'development';
        document.getElementById('projectProgress').value = '0';
        document.getElementById('projectNeedsFeedback').checked = false;
        showModal('addProject');
    });
    
    document.getElementById('addToolBtn').addEventListener('click', () => {
        // Reset form
        document.getElementById('toolName').value = '';
        document.getElementById('toolDescription').value = '';
        document.getElementById('toolUrl').value = '';
        document.getElementById('toolStatus').value = 'operational';
        document.getElementById('toolIcon').value = 'mdi mdi-toolbox';
        showModal('addTool');
    });
    
    // Edit Code Management buttons
    document.getElementById('viewCodesBtn').addEventListener('click', () => {
        loadEditCodes();
        showModal('viewCodes');
    });
    
    document.getElementById('resetCodeBtn').addEventListener('click', () => {
        loadProjectsForReset();
        document.getElementById('qrCodeSection').classList.add('hidden');
        showModal('resetCode');
    });
    
    document.getElementById('manageCommentsBtn').addEventListener('click', () => {
        manageComments();
        showModal('manageComments');
    });
    
    // Guest buttons
    document.getElementById('contactBtn').addEventListener('click', () => {
        window.open('mailto:pneumology-innovation@hospital.com?subject=Collaboration Inquiry');
    });
    
    document.getElementById('viewPublicCommentsBtn').addEventListener('click', () => {
        loadPublicComments();
        showModal('comments');
    });
    
    document.getElementById('viewCommentsBtn').addEventListener('click', () => {
        loadPublicComments();
        showModal('comments');
    });
    
    // Comment system - Submit button
    document.getElementById('submitCommentBtn').addEventListener('click', async function() {
        const commentText = document.getElementById('guestComment').value.trim();
        
        if (!commentText) {
            alert('Please enter a comment');
            return;
        }
        
        const words = commentText.split(/\s+/).filter(word => word.length > 0).length;
        if (words > 150) {
            alert('Comment must be 150 words or less');
            return;
        }
        
        this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Submitting...';
        this.disabled = true;
        
        await submitGuestComment(commentText);
        
        this.innerHTML = '<i class="mdi mdi-send"></i> Submit Comment';
        this.disabled = false;
    });
    
    // Save project
    document.getElementById('saveProjectBtn').addEventListener('click', async function() {
        const projectData = {
            name: document.getElementById('projectName').value.trim(),
            description: document.getElementById('projectDescription').value.trim(),
            status: document.getElementById('projectStatus').value,
            progress: parseInt(document.getElementById('projectProgress').value) || 0,
            needs_feedback: document.getElementById('projectNeedsFeedback').checked,
            github_url: null,
            live_url: null
        };
        
        if (!projectData.name) {
            showError('projectError', 'Project name is required');
            return;
        }
        
        this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Saving...';
        this.disabled = true;
        
        await addProject(projectData);
        
        this.innerHTML = '<i class="mdi mdi-content-save"></i> Save Project';
        this.disabled = false;
    });
    
    // Update project
    document.getElementById('updateProjectBtn').addEventListener('click', async function() {
        const projectId = document.getElementById('editProjectId').value;
        const projectData = {
            name: document.getElementById('editProjectName').value.trim(),
            description: document.getElementById('editProjectDescription').value.trim(),
            status: document.getElementById('editProjectStatus').value,
            progress: parseInt(document.getElementById('editProjectProgress').value) || 0,
            needs_feedback: document.getElementById('editProjectNeedsFeedback').checked,
            github_url: null,
            live_url: null
        };
        
        // Add visibility if admin
        if (currentUser && currentUser.role === 'admin') {
            projectData.visibility = document.getElementById('editProjectVisibility').value;
        }
        
        if (!projectData.name) {
            showError('editProjectError', 'Project name is required');
            return;
        }
        
        this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Updating...';
        this.disabled = true;
        
        await updateProject(projectId, projectData);
        
        this.innerHTML = '<i class="mdi mdi-content-save"></i> Update Project';
        this.disabled = false;
    });
    
    // Delete project
    document.getElementById('deleteProjectBtn').addEventListener('click', async function() {
        const projectId = document.getElementById('editProjectId').value;
        await deleteProject(projectId);
    });
    
    // Save tool
    document.getElementById('saveToolBtn').addEventListener('click', async function() {
        const toolData = {
            name: document.getElementById('toolName').value.trim(),
            description: document.getElementById('toolDescription').value.trim(),
            url: document.getElementById('toolUrl').value.trim(),
            status: document.getElementById('toolStatus').value,
            icon: document.getElementById('toolIcon').value.trim() || 'mdi mdi-toolbox'
        };
        
        if (!toolData.name || !toolData.url) {
            showError('toolError', 'Tool name and URL are required');
            return;
        }
        
        this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Saving...';
        this.disabled = true;
        
        await addTool(toolData);
        
        this.innerHTML = '<i class="mdi mdi-content-save"></i> Save Tool';
        this.disabled = false;
    });
    
    // Dashboard refresh
    document.getElementById('refreshLink').addEventListener('click', async function(e) {
        e.preventDefault();
        
        if (!currentUser) return;
        
        const lastUpdated = document.getElementById('lastUpdatedTime');
        lastUpdated.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Refreshing...';
        
        await initDashboard();
        
        lastUpdated.innerHTML = '<i class="mdi mdi-check-circle" style="color: var(--success);"></i> Updated just now';
        setTimeout(() => updateTimestamp(), 2000);
    });

    // Filter buttons
    document.querySelectorAll('#filterControls .filter-btn').forEach(btn => {
        btn.addEventListener('click', () => filterProjects(btn.dataset.filter));
    });

    // Reset Code Modal Events
    document.getElementById('resetProjectSelect').addEventListener('change', async function() {
        const projectId = this.value;
        if (!projectId) {
            document.getElementById('currentCodeDisplay').textContent = '-----';
            return;
        }
        
        const result = await getProjectCode(projectId);
        if (result.success) {
            document.getElementById('currentCodeDisplay').textContent = result.code || 'Not set';
        }
    });
    
    document.getElementById('newCodeOption').addEventListener('change', function() {
        const customSection = document.getElementById('customCodeSection');
        customSection.classList.toggle('hidden', this.value !== 'custom');
    });
    
    document.getElementById('generateCodeBtn').addEventListener('click', async function() {
        const projectId = document.getElementById('resetProjectSelect').value;
        const option = document.getElementById('newCodeOption').value;
        
        if (!projectId) {
            showError('resetCodeError', 'Please select a project first');
            return;
        }
        
        let newCode;
        if (option === 'custom') {
            newCode = document.getElementById('customCode').value;
            if (!/^\d{5}$/.test(newCode)) {
                showError('resetCodeError', 'Please enter a valid 5-digit code (numbers only)');
                return;
            }
        }
        
        this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Generating...';
        this.disabled = true;
        
        const result = await resetProjectCode(projectId, newCode);
        
        this.innerHTML = '<i class="mdi mdi-refresh"></i> Generate New Code';
        this.disabled = false;
        
        if (result.success) {
            showSuccess('resetCodeSuccess', `New code generated: ${result.code}`);
            document.getElementById('currentCodeDisplay').textContent = result.code;
            document.getElementById('customCode').value = '';
            
            const projectName = document.querySelector(`#resetProjectSelect option[value="${projectId}"]`)?.textContent || 'Project';
            document.getElementById('qrCodeSection').classList.remove('hidden');
            generateQRCode(projectName, result.code);
        } else {
            showError('resetCodeError', `Failed: ${result.error}`);
        }
    });
    
    document.getElementById('copyCodeBtn').addEventListener('click', function() {
        const code = document.getElementById('currentCodeDisplay').textContent.trim();
        if (code && code !== '-----') {
            copyToClipboard(code);
        } else {
            alert('No code to copy');
        }
    });
    
    document.getElementById('showQRBtn').addEventListener('click', function() {
        const projectId = document.getElementById('resetProjectSelect').value;
        const code = document.getElementById('currentCodeDisplay').textContent.trim();
        
        if (!projectId || !code || code === '-----') {
            alert('Please generate a code first');
            return;
        }
        
        const projectName = document.querySelector(`#resetProjectSelect option[value="${projectId}"]`)?.textContent || 'Project';
        document.getElementById('qrCodeSection').classList.remove('hidden');
        generateQRCode(projectName, code);
    });
    
    document.getElementById('notifyDoctorBtn').addEventListener('click', function() {
        const projectId = document.getElementById('resetProjectSelect').value;
        const code = document.getElementById('currentCodeDisplay').textContent.trim();
        
        if (!projectId || !code || code === '-----') {
            alert('Please generate a code first');
            return;
        }
        
        const projectName = document.querySelector(`#resetProjectSelect option[value="${projectId}"]`)?.textContent || 'Project';
        notifyDoctor(projectName, code);
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideAllModals();
        }
    });

    // Handle browser back button for modals
    window.addEventListener('popstate', function() {
        hideAllModals();
    });

    // Initialize with focus on login if no user
    if (!currentUser) {
        setTimeout(() => {
            document.getElementById('loginUsername')?.focus();
        }, 300);
    }

    // Auto-refresh every 5 minutes for logged-in users
    setInterval(async () => {
        if (currentUser) {
            console.log('Auto-refreshing dashboard...');
            await initDashboard();
        }
    }, 5 * 60 * 1000); // 5 minutes
});

// Make functions available globally for inline onclick handlers
window.resetSingleCode = resetSingleCode;
window.approveComment = approveComment;
window.rejectComment = rejectComment;
window.deleteComment = deleteComment;
        </script>

</body>
</html>
