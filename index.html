<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>TRAci v3 | Pneumology Innovation Platform</title>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* ===== VARIABLES & RESET ===== */
        :root {
            /* Color System */
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            
            --medical-teal: #0d9488;
            --medical-green: #059669;
            --medical-purple: #7c3aed;
            --medical-cyan: #0891b2;
            --medical-pink: #db2777;
            
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --info: #3b82f6;
            --info-light: #dbeafe;
            
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Backgrounds */
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-sidebar: #1e293b;
            
            /* Borders */
            --border-light: #e2e8f0;
            --border: #cbd5e1;
            --border-dark: #94a3b8;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            
            /* Fonts */
            --font-sans: 'Inter', sans-serif;
            --font-heading: 'Space Grotesk', sans-serif;
            
            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            /* Sizes */
            --icon-sm: 1rem;
            --icon-md: 1.25rem;
            --icon-lg: 1.5rem;
            --icon-xl: 2rem;
            
            --btn-sm: 2rem;
            --btn-md: 2.5rem;
            --btn-lg: 3rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, var(--bg-primary) 0%, #f0f9ff 100%);
            color: var(--gray-800);
            line-height: 1.5;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 300px;
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--medical-teal) 100%);
            opacity: 0.03;
            z-index: -1;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .gap-8 { gap: 2rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .rounded { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .border { border: 1px solid var(--border); }
        .border-2 { border: 2px solid var(--border); }
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow { box-shadow: var(--shadow); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }

        /* ===== CONTAINER & LAYOUT ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem 0;
        }

        @media (min-width: 1024px) {
            .main-layout {
                grid-template-columns: 280px 1fr;
            }
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
            padding: 1.5rem;
            height: fit-content;
            box-shadow: var(--shadow-md);
        }

        .sidebar-header {
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-light);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--primary-50);
            color: var(--primary-600);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            box-shadow: var(--shadow);
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }

        /* ===== HEADER ===== */
        .header {
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-600), var(--medical-teal));
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            box-shadow: var(--shadow);
        }

        .platform-info h1 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-700), var(--medical-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .platform-info .subtitle {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* ===== BUTTONS (COMPACT) ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            min-height: var(--btn-md);
            text-decoration: none;
            user-select: none;
            touch-action: manipulation;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            min-height: var(--btn-sm);
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            min-height: var(--btn-lg);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
            border-color: var(--primary-600);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-700), var(--primary-800));
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
            border-color: var(--gray-400);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border-color: var(--success);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            border-color: var(--danger);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-600);
            border-color: var(--primary-300);
        }

        .btn-outline:hover {
            background: var(--primary-50);
        }

        .btn-icon {
            width: var(--btn-md);
            padding: 0;
            justify-content: center;
        }

        .btn-icon-sm {
            width: var(--btn-sm);
            padding: 0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow);
            border-color: var(--primary-300);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-light);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ===== STATS CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-500), var(--medical-teal));
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gray-900);
            font-family: var(--font-heading);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-family: var(--font-sans);
            transition: all 0.2s ease;
            background: var(--white);
            color: var(--gray-900);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .form-control::placeholder {
            color: var(--gray-400);
        }

        .form-text {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .form-error {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        /* ===== TABLES ===== */
        .table-container {
            overflow-x: auto;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .table th {
            background: var(--gray-50);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.75rem;
        }

        .table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .table tr:hover {
            background: var(--gray-50);
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .badge-warning {
            background: var(--warning-light);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .badge-danger {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .badge-info {
            background: var(--info-light);
            color: var(--info);
            border: 1px solid var(--info);
        }

        .badge-primary {
            background: var(--primary-100);
            color: var(--primary-700);
            border: 1px solid var(--primary-300);
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 1rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl);
        }

        @keyframes slideUp {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 1;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--danger);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .alert-success {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .alert-warning {
            background: var(--warning-light);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .alert-info {
            background: var(--info-light);
            color: var(--info);
            border: 1px solid var(--info);
        }

        /* ===== LOADING ===== */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.375rem;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ===== PERMISSION BADGES ===== */
        .permission-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--gray-100);
            color: var(--gray-700);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid transparent;
        }

        .permission-badge.active {
            background: var(--success-light);
            color: var(--success);
            border-color: var(--success);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .logo-section {
                justify-content: center;
            }
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .modal-content {
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
            }
        }

        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-400);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-500);
        }

        /* ===== GRID SYSTEM ===== */
        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }

        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .md\:grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        }

        /* ===== TOGGLE SWITCH ===== */
        .toggle {
            position: relative;
            display: inline-block;
            width: 3rem;
            height: 1.5rem;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: .4s;
            border-radius: 1.5rem;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.125rem;
            width: 1.125rem;
            left: 0.1875rem;
            bottom: 0.1875rem;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(1.5rem);
        }

        /* ===== AVATAR ===== */
        .avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, var(--primary-500), var(--medical-teal));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .avatar-sm {
            width: 2rem;
            height: 2rem;
            font-size: 0.875rem;
        }

        .avatar-lg {
            width: 3rem;
            height: 3rem;
            font-size: 1.25rem;
        }

        /* ===== TOOLTIPS ===== */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-900);
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 0.5rem;
        }

        [data-tooltip]:hover::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 0.375rem solid transparent;
            border-top-color: var(--gray-900);
            margin-bottom: -0.125rem;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .bounce {
            animation: bounce 1s infinite;
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                border: 1px solid var(--gray-300) !important;
                box-shadow: none !important;
            }
            
            a {
                text-decoration: none !important;
                color: inherit !important;
            }
        }
    </style>
</head>
<body>
    <!-- ===== AUTH SCREENS ===== -->
    <div id="authScreens" class="container" style="max-width: 480px; padding-top: 3rem;">
        <!-- Landing Screen -->
        <div id="landingScreen" class="card">
            <div class="text-center mb-6">
                <div class="logo" style="margin: 0 auto 1.5rem; width: 64px; height: 64px; font-size: 1.75rem;">
                    <i class="mdi mdi-lungs"></i>
                </div>
                <h1 class="text-2xl font-bold mb-2">TRAci Platform</h1>
                <p class="text-gray-600 mb-6">Clinical Innovation & Research Collaboration</p>
            </div>
            
            <div class="space-y-3">
                <button id="loginScreenBtn" class="btn btn-primary w-full">
                    <i class="mdi mdi-login"></i>
                    Sign In
                </button>
                <button id="registerScreenBtn" class="btn btn-outline w-full">
                    <i class="mdi mdi-account-plus"></i>
                    Request Access
                </button>
                <button id="guestContinueBtn" class="btn btn-secondary w-full">
                    <i class="mdi mdi-eye"></i>
                    Continue as Guest
                </button>
            </div>
            
            <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                <p class="text-sm text-gray-500">
                    <i class="mdi mdi-shield-check"></i>
                    HIPAA Compliant • Secure Access • Audit Logged
                </p>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="card hidden">
            <div class="text-center mb-6">
                <div class="logo" style="margin: 0 auto 1rem; width: 48px; height: 48px;">
                    <i class="mdi mdi-shield-lock"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">Secure Sign In</h2>
                <p class="text-gray-600">Access your clinical innovation dashboard</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" 
                           placeholder="your.email@hospital.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-control" 
                           placeholder="Enter your password" required>
                    <div class="flex justify-between mt-1">
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" id="rememberMe" class="rounded">
                            <span>Remember me</span>
                        </label>
                        <button type="button" id="forgotPasswordBtn" class="text-sm text-primary-600 hover:underline">
                            Forgot password?
                        </button>
                    </div>
                </div>
                
                <div id="loginAlert" class="alert alert-error hidden"></div>
                
                <button type="submit" class="btn btn-primary w-full mb-3">
                    <span id="loginBtnText">Sign In</span>
                </button>
                
                <button type="button" id="backToLandingBtn" class="btn btn-secondary w-full">
                    <i class="mdi mdi-arrow-left"></i>
                    Back
                </button>
            </form>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="card hidden">
            <div class="text-center mb-6">
                <div class="logo" style="margin: 0 auto 1rem; width: 48px; height: 48px;">
                    <i class="mdi mdi-account-plus"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">Request Access</h2>
                <p class="text-gray-600">Submit your details for administrator approval</p>
            </div>
            
            <form id="registerForm">
                <div class="grid grid-cols-2 gap-3">
                    <div class="form-group">
                        <label class="form-label">First Name</label>
                        <input type="text" id="registerFirstName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name</label>
                        <input type="text" id="registerLastName" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="registerEmail" class="form-control" 
                           placeholder="professional.email@institution.com" required>
                    <div class="form-text">Use your institutional email for verification</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Institution/Organization</label>
                    <input type="text" id="registerInstitution" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Department</label>
                    <select id="registerDepartment" class="form-control" required>
                        <option value="">Select department</option>
                        <option value="pulmonology">Pulmonology</option>
                        <option value="cardiology">Cardiology</option>
                        <option value="neurology">Neurology</option>
                        <option value="radiology">Radiology</option>
                        <option value="research">Research</option>
                        <option value="administration">Administration</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Role/Position</label>
                    <input type="text" id="registerPosition" class="form-control" 
                           placeholder="e.g., Clinical Lead, Researcher, etc.">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Purpose of Access</label>
                    <textarea id="registerPurpose" class="form-control" rows="3" 
                              placeholder="Briefly describe why you need access to the platform..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="registerTerms" required class="rounded">
                        <span class="text-sm">I agree to the platform terms and data usage policy</span>
                    </label>
                </div>
                
                <div id="registerAlert" class="alert hidden"></div>
                
                <button type="submit" class="btn btn-primary w-full mb-3">
                    <span id="registerBtnText">Submit Request</span>
                </button>
                
                <button type="button" id="backToLandingFromRegister" class="btn btn-secondary w-full">
                    <i class="mdi mdi-arrow-left"></i>
                    Cancel
                </button>
            </form>
        </div>

        <!-- Forgot Password Screen -->
        <div id="forgotPasswordScreen" class="card hidden">
            <div class="text-center mb-6">
                <div class="logo" style="margin: 0 auto 1rem; width: 48px; height: 48px;">
                    <i class="mdi mdi-key-reset"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">Reset Password</h2>
                <p class="text-gray-600">Enter your email to receive reset instructions</p>
            </div>
            
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="resetEmail" class="form-control" required>
                    <div class="form-text">You'll receive a secure link to reset your password</div>
                </div>
                
                <div id="resetAlert" class="alert hidden"></div>
                
                <button type="submit" class="btn btn-primary w-full mb-3">
                    Send Reset Instructions
                </button>
                
                <button type="button" id="backToLoginBtn" class="btn btn-secondary w-full">
                    <i class="mdi mdi-arrow-left"></i>
                    Back to Login
                </button>
            </form>
        </div>

        <!-- Guest Dashboard -->
        <div id="guestDashboard" class="hidden">
            <div class="header mb-6">
                <div class="logo-section">
                    <div class="logo">
                        <i class="mdi mdi-lungs"></i>
                    </div>
                    <div class="platform-info">
                        <h1>TRAci Platform</h1>
                        <div class="subtitle">Guest Preview Mode</div>
                    </div>
                </div>
                <button id="guestLoginBtn" class="btn btn-primary">
                    <i class="mdi mdi-login"></i>
                    Sign In
                </button>
            </div>
            
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="mdi mdi-information"></i>
                        Welcome Guest
                    </h3>
                </div>
                <div class="space-y-3">
                    <p>You're viewing the TRAci platform in guest mode. Some features are restricted.</p>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-outline">
                            <i class="mdi mdi-eye"></i>
                            View Public Projects
                        </button>
                        <button class="btn btn-sm btn-outline">
                            <i class="mdi mdi-toolbox"></i>
                            Browse Tools
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MAIN DASHBOARD (Initially Hidden) ===== -->
    <div id="mainDashboard" class="hidden">
        <div class="container">
            <!-- Header -->
            <header class="header">
                <div class="logo-section">
                    <div class="logo">
                        <i class="mdi mdi-lungs"></i>
                    </div>
                    <div class="platform-info">
                        <h1>TRAci Platform</h1>
                        <div class="subtitle">Pneumology Innovation</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="status-panel hidden" id="statusPanel">
                        <span class="live-indicator">
                            <span class="live-dot"></span>
                            <span>LIVE</span>
                        </span>
                        <span class="text-sm text-gray-600 ml-2">
                            Updated: <span id="lastUpdatedTime">--:--</span>
                        </span>
                    </div>
                    
                    <div class="user-menu" id="userMenu">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </header>

            <!-- Main Layout -->
            <div class="main-layout">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <div class="sidebar-header">
                        <h3 class="font-semibold text-gray-900">Navigation</h3>
                    </div>
                    
                    <nav class="space-y-1">
                        <a href="#" class="nav-item active" data-page="dashboard">
                            <i class="mdi mdi-view-dashboard"></i>
                            Dashboard
                        </a>
                        
                        <a href="#" class="nav-item" data-page="projects">
                            <i class="mdi mdi-flask"></i>
                            Projects
                            <span class="badge" id="projectsBadge">0</span>
                        </a>
                        
                        <a href="#" class="nav-item" data-page="tools">
                            <i class="mdi mdi-toolbox"></i>
                            Clinical Tools
                        </a>
                        
                        <a href="#" class="nav-item" data-page="collaboration">
                            <i class="mdi mdi-comment-multiple"></i>
                            Collaboration
                            <span class="badge" id="commentsBadge">0</span>
                        </a>
                        
                        <div class="pt-4 mt-4 border-t border-gray-200">
                            <div class="px-3 mb-2 text-xs font-semibold text-gray-500 uppercase">Administration</div>
                            
                            <a href="#" class="nav-item" data-page="users">
                                <i class="mdi mdi-account-multiple"></i>
                                User Management
                            </a>
                            
                            <a href="#" class="nav-item" data-page="permissions">
                                <i class="mdi mdi-shield-account"></i>
                                Permissions
                            </a>
                            
                            <a href="#" class="nav-item" data-page="audit">
                                <i class="mdi mdi-history"></i>
                                Audit Log
                            </a>
                            
                            <a href="#" class="nav-item" data-page="settings">
                                <i class="mdi mdi-cog"></i>
                                Settings
                            </a>
                        </div>
                    </nav>
                    
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <button id="quickAddProject" class="btn btn-primary w-full mb-3">
                            <i class="mdi mdi-plus"></i>
                            New Project
                        </button>
                        <button id="quickAddTool" class="btn btn-outline w-full">
                            <i class="mdi mdi-toolbox-plus"></i>
                            Add Tool
                        </button>
                    </div>
                </aside>

                <!-- Main Content Area -->
                <main class="space-y-6">
                    <!-- Stats Overview -->
                    <section id="statsSection" class="hidden">
                        <div class="stats-grid">
                            <div class="card stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary-500), var(--primary-600));">
                                    <i class="mdi mdi-flask"></i>
                                </div>
                                <div class="stat-value" id="projectsCount">0</div>
                                <div class="stat-label">Active Projects</div>
                            </div>
                            
                            <div class="card stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--medical-teal), var(--medical-cyan));">
                                    <i class="mdi mdi-toolbox"></i>
                                </div>
                                <div class="stat-value" id="toolsCount">0</div>
                                <div class="stat-label">Clinical Tools</div>
                            </div>
                            
                            <div class="card stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--success), var(--medical-green));">
                                    <i class="mdi mdi-comment-multiple"></i>
                                </div>
                                <div class="stat-value" id="collaborationCount">0</div>
                                <div class="stat-label">Collaborations</div>
                            </div>
                            
                            <div class="card stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--medical-purple), #9333ea);">
                                    <i class="mdi mdi-shield-account"></i>
                                </div>
                                <div class="stat-value" id="usersCount">0</div>
                                <div class="stat-label">Active Users</div>
                            </div>
                        </div>
                    </section>

                    <!-- Page Content -->
                    <div id="pageContent">
                        <!-- Will be populated by JavaScript based on navigation -->
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- ===== MODALS ===== -->
    
    <!-- Login Modal (for guest dashboard) -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="mdi mdi-shield-lock"></i>
                    Sign In
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Login form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="mdi mdi-plus-circle"></i>
                    New Project
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Project form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Permission Editor Modal -->
    <div id="permissionEditorModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="mdi mdi-shield-account"></i>
                    Permission Editor
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Permission editor will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal-overlay" style="background: rgba(255, 255, 255, 0.9); display: none;">
        <div class="flex flex-col items-center justify-center gap-4">
            <div class="loading-spinner" style="width: 3rem; height: 3rem; border-width: 3px;"></div>
            <p class="text-lg font-semibold text-gray-700" id="loadingText">Loading...</p>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toastContainer" style="position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; max-width: 400px;"></div>

    <!-- JavaScript -->
    <script>
       // ========== CONFIGURATION ==========
const SUPABASE_URL = 'https://bledpouekiytppuhxeqq.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_zdlIM8UbOrRIFpmYLJOmWQ_4QqNi_5C';

// ========== SUPABASE INITIALIZATION ==========
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ========== GLOBAL STATE ==========
let currentUser = null;
let userPermissions = {};
let authToken = localStorage.getItem('traci_auth_token');
let sessionTimeout = null;
let currentPage = 'dashboard';

// ========== PERMISSION DEFINITIONS ==========
const PERMISSIONS = {
    VIEW_PROJECTS: 'view_projects',
    CREATE_PROJECTS: 'create_projects',
    EDIT_OWN_PROJECTS: 'edit_own_projects',
    EDIT_ALL_PROJECTS: 'edit_all_projects',
    DELETE_PROJECTS: 'delete_projects',
    EXPORT_PROJECTS: 'export_projects',
    VIEW_TOOLS: 'view_tools',
    MANAGE_TOOLS: 'manage_tools',
    VIEW_COMMENTS: 'view_comments',
    CREATE_COMMENTS: 'create_comments',
    MODERATE_COMMENTS: 'moderate_comments',
    VIEW_USERS: 'view_users',
    MANAGE_USERS: 'manage_users',
    EDIT_PERMISSIONS: 'edit_permissions',
    VIEW_AUDIT_LOG: 'view_audit_log',
    MANAGE_SETTINGS: 'manage_settings',
    SYNC_EXTERNAL: 'sync_external',
    BYPASS_APPROVAL: 'bypass_approval',
    SUPER_ADMIN: 'super_admin'
};

// ========== UTILITY FUNCTIONS ==========
function showToast(message, type = 'info', duration = 5000) {
    const container = document.getElementById('toastContainer') || createToastContainer();
    const toast = document.createElement('div');
    
    let bgColor = 'bg-blue-100 border-blue-500 text-blue-700';
    let icon = 'mdi-information';
    
    switch (type) {
        case 'success':
            bgColor = 'bg-green-100 border-green-500 text-green-700';
            icon = 'mdi-check-circle';
            break;
        case 'error':
            bgColor = 'bg-red-100 border-red-500 text-red-700';
            icon = 'mdi-alert-circle';
            break;
        case 'warning':
            bgColor = 'bg-yellow-100 border-yellow-500 text-yellow-700';
            icon = 'mdi-alert';
            break;
    }
    
    toast.className = `border-l-4 ${bgColor} p-4 rounded shadow-lg flex items-center gap-3 animate-slide-in`;
    toast.innerHTML = `
        <i class="mdi ${icon} text-xl"></i>
        <div class="flex-1">${message}</div>
        <button class="text-gray-500 hover:text-gray-700" onclick="this.parentElement.remove()">
            <i class="mdi mdi-close"></i>
        </button>
    `;
    
    container.appendChild(toast);
    
    if (duration > 0) {
        setTimeout(() => {
            if (toast.parentElement) toast.remove();
        }, duration);
    }
    
    if (!document.getElementById('toast-animations')) {
        const style = document.createElement('style');
        style.id = 'toast-animations';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            .animate-slide-in { animation: slideIn 0.3s ease; }
        `;
        document.head.appendChild(style);
    }
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.style.cssText = `
        position: fixed; top: 1rem; right: 1rem; z-index: 9999; 
        display: flex; flex-direction: column; gap: 0.5rem; max-width: 400px;
    `;
    document.body.appendChild(container);
    return container;
}

function showLoading(message = 'Loading...') {
    let overlay = document.getElementById('loadingOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.className = 'modal-overlay';
        overlay.style.cssText = 'background: rgba(255, 255, 255, 0.9); display: none;';
        overlay.innerHTML = `
            <div class="flex flex-col items-center justify-center gap-4">
                <div class="loading-spinner" style="width: 3rem; height: 3rem; border-width: 3px;"></div>
                <p class="text-lg font-semibold text-gray-700">${message}</p>
            </div>
        `;
        document.body.appendChild(overlay);
    }
    document.getElementById('loadingText').textContent = message;
    overlay.style.display = 'flex';
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.style.display = 'none';
}

async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

function generateRandomPassword(length = 12) {
    const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
    let password = '';
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    return password;
}

function hasPermission(permission) {
    if (!currentUser) return false;
    if (userPermissions[PERMISSIONS.SUPER_ADMIN]) return true;
    return userPermissions[permission] === true;
}

function updateUIForPermissions() {
    document.querySelectorAll('[data-permission]').forEach(el => {
        const requiredPermission = el.dataset.permission;
        if (requiredPermission && !hasPermission(requiredPermission)) {
            el.classList.add('hidden');
        } else {
            el.classList.remove('hidden');
        }
    });
}

// ========== DATABASE FUNCTIONS ==========
async function initializeDatabase() {
    try {
        const { error } = await supabase
            .from('users')
            .select('count', { count: 'exact', head: true });
        
        if (error && error.message.includes('relation "users" does not exist")) {
            await createDatabaseTables();
        }
        
        return true;
    } catch (error) {
        console.error('Database initialization error:', error);
        return false;
    }
}

async function createDatabaseTables() {
    const sql = `
        CREATE TABLE IF NOT EXISTS users (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            email TEXT UNIQUE NOT NULL,
            username TEXT,
            full_name TEXT,
            institution TEXT,
            department TEXT,
            position TEXT,
            encrypted_password TEXT,
            status TEXT DEFAULT 'pending',
            permissions JSONB DEFAULT '{}',
            last_login TIMESTAMP WITH TIME ZONE,
            login_attempts INTEGER DEFAULT 0,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        CREATE TABLE IF NOT EXISTS access_requests (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            email TEXT NOT NULL,
            full_name TEXT,
            institution TEXT,
            department TEXT,
            position TEXT,
            purpose TEXT,
            status TEXT DEFAULT 'pending',
            reviewed_by UUID REFERENCES users(id),
            reviewed_at TIMESTAMP WITH TIME ZONE,
            notes TEXT,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        CREATE TABLE IF NOT EXISTS projects (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            name TEXT NOT NULL,
            description TEXT,
            status TEXT DEFAULT 'planning',
            progress INTEGER DEFAULT 0,
            category TEXT,
            priority TEXT DEFAULT 'medium',
            needs_feedback BOOLEAN DEFAULT false,
            visibility TEXT DEFAULT 'private',
            owner_id UUID REFERENCES users(id),
            edit_code TEXT,
            review_status TEXT DEFAULT 'none',
            tags TEXT[],
            metadata JSONB DEFAULT '{}',
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        CREATE TABLE IF NOT EXISTS tools (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            name TEXT NOT NULL,
            description TEXT,
            url TEXT,
            status TEXT DEFAULT 'operational',
            category TEXT,
            icon TEXT DEFAULT 'mdi mdi-toolbox',
            last_checked TIMESTAMP WITH TIME ZONE,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        CREATE TABLE IF NOT EXISTS audit_logs (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            user_id UUID REFERENCES users(id),
            user_name TEXT,
            action TEXT NOT NULL,
            details JSONB DEFAULT '{}',
            project_id UUID REFERENCES projects(id),
            ip_address TEXT,
            user_agent TEXT,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        CREATE TABLE IF NOT EXISTS comments (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            project_id UUID REFERENCES projects(id),
            user_id UUID REFERENCES users(id),
            user_name TEXT,
            content TEXT NOT NULL,
            status TEXT DEFAULT 'pending',
            upvotes INTEGER DEFAULT 0,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        
        INSERT INTO users (
            email, username, full_name, institution, department,
            encrypted_password, status, permissions
        ) VALUES (
            'admin@hospital.com', 'admin', 'System Administrator', 
            'Hospital System', 'Administration',
            '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8',
            'active', '{"super_admin": true}'
        ) ON CONFLICT (email) DO NOTHING;
    `;
    
    console.log('Run in Supabase SQL Editor:', sql);
}

async function logAudit(action, details, projectId = null) {
    if (!currentUser) return;
    
    try {
        const auditData = {
            user_id: currentUser.id,
            user_name: currentUser.full_name || currentUser.email,
            action: action,
            details: details,
            project_id: projectId,
            created_at: new Date().toISOString()
        };
        
        const { error } = await supabase
            .from('audit_logs')
            .insert([auditData]);
        
        if (error) console.error('Audit log error:', error);
    } catch (error) {
        console.error('Failed to log audit:', error);
    }
}

// ========== AUTHENTICATION FUNCTIONS ==========
async function login(email, password) {
    showLoading('Signing in...');
    
    try {
        const hashedPassword = await hashPassword(password);
        
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('email', email.toLowerCase().trim())
            .single();
        
        if (error) throw new Error('Invalid email or password');
        if (user.status !== 'active') throw new Error('Account is not active');
        if (user.encrypted_password !== hashedPassword) throw new Error('Invalid email or password');
        
        await supabase
            .from('users')
            .update({ 
                login_attempts: 0,
                last_login: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .eq('id', user.id);
        
        currentUser = {
            id: user.id,
            email: user.email,
            username: user.username || user.email.split('@')[0],
            full_name: user.full_name || 'User',
            institution: user.institution || '',
            department: user.department || '',
            position: user.position || '',
            status: user.status,
            created_at: user.created_at
        };
        
        userPermissions = user.permissions || {};
        authToken = btoa(JSON.stringify({ userId: user.id, email: user.email, timestamp: Date.now() }));
        localStorage.setItem('traci_auth_token', authToken);
        
        resetSessionTimeout();
        await logAudit('login', { email: email });
        
        hideLoading();
        return true;
        
    } catch (error) {
        hideLoading();
        throw error;
    }
}

function resetSessionTimeout() {
    if (sessionTimeout) clearTimeout(sessionTimeout);
    sessionTimeout = setTimeout(() => {
        showToast('Session expired. Please sign in again.', 'warning');
        logout();
    }, 8 * 60 * 60 * 1000);
}

function logout() {
    if (currentUser) logAudit('logout', {});
    
    currentUser = null;
    userPermissions = {};
    authToken = null;
    localStorage.removeItem('traci_auth_token');
    
    if (sessionTimeout) {
        clearTimeout(sessionTimeout);
        sessionTimeout = null;
    }
    
    showAuthScreens();
}

async function registerAccessRequest(formData) {
    showLoading('Submitting request...');
    
    try {
        const { data: existingUser } = await supabase
            .from('users')
            .select('id')
            .eq('email', formData.email)
            .single();
        
        if (existingUser) throw new Error('An account with this email already exists.');
        
        const { data: pendingRequest } = await supabase
            .from('access_requests')
            .select('id')
            .eq('email', formData.email)
            .eq('status', 'pending')
            .single();
        
        if (pendingRequest) throw new Error('You already have a pending access request.');
        
        const { data, error } = await supabase
            .from('access_requests')
            .insert([{
                email: formData.email,
                full_name: `${formData.firstName} ${formData.lastName}`.trim(),
                institution: formData.institution,
                department: formData.department,
                position: formData.position,
                purpose: formData.purpose,
                status: 'pending'
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        hideLoading();
        return data;
        
    } catch (error) {
        hideLoading();
        throw error;
    }
}

async function requestPasswordReset(email) {
    showLoading('Processing request...');
    
    try {
        const { data: user } = await supabase
            .from('users')
            .select('id, email, full_name')
            .eq('email', email)
            .single();
        
        if (!user) return true;
        
        // In production: Store reset token and send email
        showToast(`Password reset instructions sent to ${email}`, 'success');
        return true;
        
    } catch (error) {
        return true;
    }
}

// ========== PROJECT CRUD OPERATIONS ==========
async function loadProjects(filter = 'all') {
    try {
        let query = supabase
            .from('projects')
            .select('*')
            .order('created_at', { ascending: false });
        
        switch (filter) {
            case 'active': query = query.neq('status', 'archived'); break;
            case 'archived': query = query.eq('status', 'archived'); break;
            case 'needs_review': query = query.eq('needs_feedback', true); break;
        }
        
        if (!hasPermission(PERMISSIONS.EDIT_ALL_PROJECTS)) {
            query = query.or('visibility.eq.public,visibility.eq.internal');
        }
        
        const { data, error } = await query;
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Error loading projects:', error);
        return [];
    }
}

async function createProject(projectData) {
    showLoading('Creating project...');
    
    try {
        const projectToInsert = {
            ...projectData,
            owner_id: currentUser.id,
            edit_code: Math.floor(10000 + Math.random() * 90000).toString(),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabase
            .from('projects')
            .insert([projectToInsert])
            .select()
            .single();
        
        if (error) throw error;
        
        await logAudit('project_created', {
            project_id: data.id,
            name: projectData.name,
            visibility: projectData.visibility
        }, data.id);
        
        hideLoading();
        return { success: true, data };
        
    } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
    }
}

async function updateProject(projectId, projectData) {
    showLoading('Updating project...');
    
    try {
        const { data, error } = await supabase
            .from('projects')
            .update({
                ...projectData,
                updated_at: new Date().toISOString()
            })
            .eq('id', projectId)
            .select()
            .single();
        
        if (error) throw error;
        
        await logAudit('project_updated', {
            project_id: projectId,
            changes: Object.keys(projectData)
        }, projectId);
        
        hideLoading();
        return { success: true, data };
        
    } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
    }
}

async function deleteProject(projectId) {
    if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
        return { success: false };
    }
    
    showLoading('Deleting project...');
    
    try {
        const { error } = await supabase
            .from('projects')
            .delete()
            .eq('id', projectId);
        
        if (error) throw error;
        
        await logAudit('project_deleted', { project_id: projectId });
        
        hideLoading();
        return { success: true };
        
    } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
    }
}

// ========== TOOL CRUD OPERATIONS ==========
async function loadTools() {
    try {
        const { data, error } = await supabase
            .from('tools')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Error loading tools:', error);
        return [];
    }
}

async function createTool(toolData) {
    showLoading('Adding tool...');
    
    try {
        const { data, error } = await supabase
            .from('tools')
            .insert([{
                ...toolData,
                last_checked: new Date().toISOString(),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        await logAudit('tool_created', { tool_name: toolData.name });
        
        hideLoading();
        return { success: true, data };
        
    } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
    }
}

async function updateTool(toolId, toolData) {
    showLoading('Updating tool...');
    
    try {
        const { data, error } = await supabase
            .from('tools')
            .update({
                ...toolData,
                last_checked: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .eq('id', toolId)
            .select()
            .single();
        
        if (error) throw error;
        
        await logAudit('tool_updated', { tool_id: toolId });
        
        hideLoading();
        return { success: true, data };
        
    } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
    }
}

async function deleteTool(toolId) {
    if (!confirm('Are you sure you want to delete this tool?')) {
        return { success: false };
    }
    
    showLoading('Deleting tool...');
    
    try {
        const { error } = await supabase
            .from('tools')
            .delete()
            .eq('id', toolId);
        
        if (error) throw error;
        
        await logAudit('tool_deleted', { tool_id: toolId });
        
        hideLoading();
        return { success: true };
        
    } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
    }
}

// ========== COMMENT SYSTEM ==========
async function loadComments(projectId) {
    try {
        const { data, error } = await supabase
            .from('comments')
            .select('*')
            .eq('project_id', projectId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Error loading comments:', error);
        return [];
    }
}

async function createComment(commentData) {
    try {
        const { data, error } = await supabase
            .from('comments')
            .insert([{
                ...commentData,
                user_name: currentUser.full_name,
                status: hasPermission(PERMISSIONS.MODERATE_COMMENTS) ? 'approved' : 'pending',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        await logAudit('comment_added', {
            project_id: commentData.project_id,
            comment_length: commentData.content.length
        }, commentData.project_id);
        
        return { success: true, data };
        
    } catch (error) {
        return { success: false, error: error.message };
    }
}

async function updateCommentStatus(commentId, status) {
    try {
        const { error } = await supabase
            .from('comments')
            .update({ status: status })
            .eq('id', commentId);
        
        if (error) throw error;
        
        await logAudit('comment_moderated', { comment_id: commentId, status: status });
        
        return { success: true };
    } catch (error) {
        return { success: false, error: error.message };
    }
}

// ========== USER MANAGEMENT ==========
async function loadUsers() {
    try {
        const { data, error } = await supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Error loading users:', error);
        return [];
    }
}

async function createUser(userData) {
    showLoading('Creating user...');
    
    try {
        const hashedPassword = await hashPassword(userData.password);
        
        const { data, error } = await supabase
            .from('users')
            .insert([{
                email: userData.email,
                username: userData.username,
                full_name: userData.full_name,
                institution: userData.institution,
                department: userData.department,
                position: userData.position,
                encrypted_password: hashedPassword,
                status: userData.is_active ? 'active' : 'pending',
                permissions: userData.permissions || {},
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (error) throw error;
        
        await logAudit('user_created', {
            user_id: data.id,
            email: userData.email,
            role: userData.permissions
        });
        
        hideLoading();
        return { success: true, data, password: userData.password };
        
    } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
    }
}

async function updateUser(userId, userData) {
    showLoading('Updating user...');
    
    try {
        const updateData = {
            full_name: userData.full_name,
            email: userData.email,
            department: userData.department,
            position: userData.position,
            status: userData.is_active ? 'active' : 'suspended',
            permissions: userData.permissions || {},
            updated_at: new Date().toISOString()
        };
        
        if (userData.password) {
            updateData.encrypted_password = await hashPassword(userData.password);
        }
        
        const { data, error } = await supabase
            .from('users')
            .update(updateData)
            .eq('id', userId)
            .select()
            .single();
        
        if (error) throw error;
        
        await logAudit('user_updated', { user_id: userId });
        
        hideLoading();
        return { success: true, data };
        
    } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
    }
}

async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) {
        return { success: false };
    }
    
    showLoading('Deleting user...');
    
    try {
        const { error } = await supabase
            .from('users')
            .delete()
            .eq('id', userId);
        
        if (error) throw error;
        
        await logAudit('user_deleted', { user_id: userId });
        
        hideLoading();
        return { success: true };
        
    } catch (error) {
        hideLoading();
        return { success: false, error: error.message };
    }
}

// ========== SEARCH AND FILTER ==========
async function searchProjects(searchTerm) {
    try {
        const { data, error } = await supabase
            .from('projects')
            .select('*')
            .or(`name.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Search error:', error);
        return [];
    }
}

async function searchUsers(searchTerm) {
    try {
        const { data, error } = await supabase
            .from('users')
            .select('*')
            .or(`email.ilike.%${searchTerm}%,full_name.ilike.%${searchTerm}%,department.ilike.%${searchTerm}%`)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Search error:', error);
        return [];
    }
}

// ========== EXPORT FUNCTIONALITY ==========
async function exportProjectsToCSV() {
    try {
        const projects = await loadProjects();
        
        const headers = ['Name', 'Description', 'Status', 'Progress', 'Category', 'Priority', 'Visibility', 'Created'];
        const rows = projects.map(p => [
            p.name,
            p.description?.replace(/"/g, '""') || '',
            p.status,
            p.progress + '%',
            p.category,
            p.priority,
            p.visibility,
            new Date(p.created_at).toLocaleDateString()
        ]);
        
        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `traci-projects-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showToast('Projects exported successfully', 'success');
        
    } catch (error) {
        console.error('Export error:', error);
        showToast('Failed to export projects', 'error');
    }
}

async function exportAuditLog() {
    try {
        const { data, error } = await supabase
            .from('audit_logs')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const csvContent = [
            ['Timestamp', 'User', 'Action', 'Details', 'IP Address'].join(','),
            ...(data || []).map(log => [
                new Date(log.created_at).toISOString(),
                log.user_name,
                log.action,
                JSON.stringify(log.details).replace(/"/g, '""'),
                log.ip_address || ''
            ].map(cell => `"${cell}"`).join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `traci-audit-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showToast('Audit log exported successfully', 'success');
        
    } catch (error) {
        console.error('Export error:', error);
        showToast('Failed to export audit log', 'error');
    }
}

// ========== EMAIL NOTIFICATIONS ==========
async function sendEmailNotification(to, subject, body) {
    // This is a placeholder for email integration
    // In production, integrate with email service like SendGrid, AWS SES, etc.
    console.log('Email notification:', { to, subject, body });
    
    // Mock implementation
    return new Promise(resolve => {
        setTimeout(() => {
            console.log(`[MOCK EMAIL] To: ${to}, Subject: ${subject}`);
            resolve({ success: true });
        }, 500);
    });
}

async function notifyNewComment(projectId, comment) {
    if (!hasPermission(PERMISSIONS.MODERATE_COMMENTS)) return;
    
    try {
        const { data: project } = await supabase
            .from('projects')
            .select('name, owner_id')
            .eq('id', projectId)
            .single();
        
        if (!project) return;
        
        const { data: owner } = await supabase
            .from('users')
            .select('email, full_name')
            .eq('id', project.owner_id)
            .single();
        
        if (owner && owner.email) {
            await sendEmailNotification(
                owner.email,
                `New Comment on Project: ${project.name}`,
                `Hello ${owner.full_name},\n\nA new comment has been added to your project "${project.name}":\n\n"${comment.content}"\n\nBy: ${comment.user_name}\n\nPlease review the comment in the TRAci platform.\n\nBest regards,\nTRAci System`
            );
        }
    } catch (error) {
        console.error('Failed to send comment notification:', error);
    }
}

async function notifyAccessRequest(request) {
    try {
        const { data: admins } = await supabase
            .from('users')
            .select('email, full_name')
            .eq('status', 'active')
            .or('permissions.super_admin.eq.true,permissions.manage_users.eq.true');
        
        if (!admins || admins.length === 0) return;
        
        for (const admin of admins) {
            await sendEmailNotification(
                admin.email,
                'New Access Request - TRAci Platform',
                `Hello ${admin.full_name},\n\nA new access request has been submitted:\n\nName: ${request.full_name}\nEmail: ${request.email}\nInstitution: ${request.institution}\nDepartment: ${request.department}\nPurpose: ${request.purpose || 'Not specified'}\n\nPlease review and approve/reject this request in the admin panel.\n\nBest regards,\nTRAci System`
            );
        }
    } catch (error) {
        console.error('Failed to send access request notification:', error);
    }
}

// ========== ERROR HANDLING ==========
function handleError(error, context) {
    console.error(`Error in ${context}:`, error);
    
    const errorMessages = {
        'network': 'Network error. Please check your internet connection.',
        'auth': 'Authentication failed. Please try again.',
        'permission': 'You do not have permission to perform this action.',
        'database': 'Database error. Please try again later.',
        'validation': 'Please check your input and try again.',
        'unknown': 'An unexpected error occurred. Please try again.'
    };
    
    let message = errorMessages.unknown;
    
    if (error.message.includes('network') || error.message.includes('fetch')) {
        message = errorMessages.network;
    } else if (error.message.includes('permission') || error.message.includes('unauthorized')) {
        message = errorMessages.permission;
    } else if (error.message.includes('auth') || error.message.includes('login')) {
        message = errorMessages.auth;
    } else if (error.message.includes('validation') || error.message.includes('invalid')) {
        message = errorMessages.validation;
    } else if (error.message) {
        message = error.message;
    }
    
    showToast(`${context}: ${message}`, 'error');
    return { success: false, error: message };
}

// ========== UI MANAGEMENT ==========
function showAuthScreens() {
    document.getElementById('mainDashboard')?.classList.add('hidden');
    document.getElementById('guestDashboard')?.classList.add('hidden');
    document.getElementById('authScreens')?.classList.remove('hidden');
    showScreen('landingScreen');
}

function showMainDashboard() {
    document.getElementById('authScreens')?.classList.add('hidden');
    document.getElementById('guestDashboard')?.classList.add('hidden');
    document.getElementById('mainDashboard')?.classList.remove('hidden');
    updateUIForPermissions();
    loadDashboard();
}

function showGuestDashboard() {
    document.getElementById('authScreens')?.classList.add('hidden');
    document.getElementById('mainDashboard')?.classList.add('hidden');
    document.getElementById('guestDashboard')?.classList.remove('hidden');
}

function showScreen(screenId) {
    ['landingScreen', 'loginScreen', 'registerScreen', 'forgotPasswordScreen'].forEach(id => {
        document.getElementById(id)?.classList.add('hidden');
    });
    document.getElementById(screenId)?.classList.remove('hidden');
}

function showModal(modalId, content = null) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    document.querySelectorAll('.modal-overlay').forEach(m => {
        m.style.display = 'none';
    });
    
    if (content) {
        const modalBody = modal.querySelector('.modal-body');
        if (modalBody) modalBody.innerHTML = content;
    }
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function hideModals() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.style.display = 'none';
    });
    document.body.style.overflow = 'auto';
}

// ========== DASHBOARD FUNCTIONS ==========
async function loadDashboard() {
    if (!currentUser) return;
    
    showLoading('Loading dashboard...');
    
    try {
        await loadDashboardStats();
        await loadPage('dashboard');
        updateUserMenu();
        hideLoading();
    } catch (error) {
        hideLoading();
        handleError(error, 'loadDashboard');
    }
}

async function loadDashboardStats() {
    try {
        const [projects, tools, comments, users] = await Promise.all([
            getProjectsCount(),
            getToolsCount(),
            getCommentsCount(),
            getUsersCount()
        ]);
        
        document.getElementById('projectsCount').textContent = projects;
        document.getElementById('toolsCount').textContent = tools;
        document.getElementById('collaborationCount').textContent = comments;
        document.getElementById('usersCount').textContent = users;
        
        document.getElementById('projectsBadge').textContent = projects;
        document.getElementById('commentsBadge').textContent = comments;
        
        document.getElementById('statsSection')?.classList.remove('hidden');
    } catch (error) {
        console.error('Stats load error:', error);
    }
}

async function getProjectsCount() {
    try {
        let query = supabase
            .from('projects')
            .select('id', { count: 'exact', head: true });
        
        if (!hasPermission(PERMISSIONS.EDIT_ALL_PROJECTS)) {
            query = query.eq('visibility', 'public');
        }
        
        const { count } = await query;
        return count || 0;
    } catch {
        return 0;
    }
}

async function getToolsCount() {
    try {
        const { count } = await supabase
            .from('tools')
            .select('id', { count: 'exact', head: true });
        return count || 0;
    } catch {
        return 0;
    }
}

async function getCommentsCount() {
    try {
        const { count } = await supabase
            .from('comments')
            .select('id', { count: 'exact', head: true })
            .eq('status', 'approved');
        return count || 0;
    } catch {
        return 0;
    }
}

async function getUsersCount() {
    if (!hasPermission(PERMISSIONS.VIEW_USERS)) return 0;
    try {
        const { count } = await supabase
            .from('users')
            .select('id', { count: 'exact', head: true })
            .eq('status', 'active');
        return count || 0;
    } catch {
        return 0;
    }
}

// ========== PAGE LOADING ==========
async function loadPage(page) {
    currentPage = page;
    const content = document.getElementById('pageContent');
    if (!content) return;
    
    showLoading(`Loading ${page}...`);
    
    try {
        let html = '';
        
        switch (page) {
            case 'dashboard': html = await loadDashboardPage(); break;
            case 'projects': html = await loadProjectsPage(); break;
            case 'tools': html = await loadToolsPage(); break;
            case 'collaboration': html = await loadCollaborationPage(); break;
            case 'users': html = await loadUsersPage(); break;
            case 'permissions': html = await loadPermissionsPage(); break;
            case 'audit': html = await loadAuditPage(); break;
            case 'settings': html = await loadSettingsPage(); break;
            default: html = '<div class="card"><p>Page not found</p></div>';
        }
        
        content.innerHTML = html;
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
        
        hideLoading();
    } catch (error) {
        hideLoading();
        content.innerHTML = `
            <div class="card">
                <div class="text-center py-8">
                    <i class="mdi mdi-alert-circle text-4xl text-red-500 mb-4"></i>
                    <h3 class="text-lg font-semibold mb-2">Error Loading Page</h3>
                    <p class="text-gray-600">${error.message}</p>
                </div>
            </div>
        `;
    }
}

// ========== PAGE TEMPLATES ==========
async function loadDashboardPage() {
    const projects = await loadProjects();
    const recentProjects = projects.slice(0, 5);
    
    return `
        <div class="space-y-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="mdi mdi-view-dashboard"></i>
                        Welcome, ${currentUser.full_name}
                    </h3>
                    <button class="btn btn-sm btn-outline" onclick="refreshDashboard()">
                        <i class="mdi mdi-refresh"></i> Refresh
                    </button>
                </div>
                <div class="space-y-4">
                    <p>Welcome to the TRAci Clinical Innovation Platform.</p>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        ${hasPermission(PERMISSIONS.CREATE_PROJECTS) ? `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                                    <i class="mdi mdi-plus text-primary-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Create Project</h4>
                                    <p class="text-sm text-gray-600">Start new research initiative</p>
                                </div>
                            </div>
                            <button onclick="showNewProjectModal()" class="btn btn-sm btn-primary w-full">
                                New Project
                            </button>
                        </div>
                        ` : ''}
                        
                        ${hasPermission(PERMISSIONS.VIEW_PROJECTS) ? `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                                    <i class="mdi mdi-flask text-green-600"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold">Browse Projects</h4>
                                    <p class="text-sm text-gray-600">View clinical initiatives</p>
                                </div>
                            </div>
                            <button onclick="loadPage('projects')" class="btn btn-sm btn-outline w-full">
                                View All
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="mdi mdi-history"></i>
                        Recent Projects
                    </h3>
                </div>
                <div class="space-y-3">
                    ${recentProjects.length > 0 ? recentProjects.map(project => `
                        <div class="border border-gray-200 rounded-lg p-4 hover:border-primary-300 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold">${project.name}</h4>
                                <span class="badge badge-${project.status === 'archived' ? 'danger' : 'success'}">
                                    ${project.status}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">${project.description?.substring(0, 100)}...</p>
                            <div class="flex justify-between text-sm">
                                <span>Progress: ${project.progress}%</span>
                                <span>${new Date(project.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                    `).join('') : '<p class="text-gray-500 text-center py-4">No projects found</p>'}
                </div>
            </div>
        </div>
    `;
}

async function loadProjectsPage() {
    if (!hasPermission(PERMISSIONS.VIEW_PROJECTS)) {
        return `<div class="card"><p class="text-center py-8">Access restricted</p></div>`;
    }
    
    const projects = await loadProjects();
    
    return `
        <div class="space-y-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="mdi mdi-flask"></i>
                        Research Projects
                    </h3>
                    <div class="flex gap-2">
                        <input type="text" id="projectSearch" class="form-control" placeholder="Search projects..." style="width: 200px;">
                        ${hasPermission(PERMISSIONS.CREATE_PROJECTS) ? `
                        <button onclick="showNewProjectModal()" class="btn btn-primary">
                            <i class="mdi mdi-plus"></i> New Project
                        </button>
                        ` : ''}
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-primary" onclick="filterProjects('all')">All</button>
                        <button class="btn btn-sm btn-outline" onclick="filterProjects('active')">Active</button>
                        <button class="btn btn-sm btn-outline" onclick="filterProjects('archived')">Archived</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Visibility</th>
                                <th>Created</th>
                                ${hasPermission(PERMISSIONS.EDIT_OWN_PROJECTS) ? '<th>Actions</th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            ${projects.length > 0 ? projects.map(project => `
                                <tr>
                                    <td>
                                        <div class="font-semibold">${project.name}</div>
                                        <div class="text-sm text-gray-600">${project.description?.substring(0, 50)}...</div>
                                    </td>
                                    <td><span class="badge badge-${project.status === 'archived' ? 'danger' : 'success'}">${project.status}</span></td>
                                    <td>
                                        <div class="flex items-center gap-2">
                                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                                <div class="bg-primary-500 h-2 rounded-full" style="width: ${project.progress}%"></div>
                                            </div>
                                            <span class="text-sm">${project.progress}%</span>
                                        </div>
                                    </td>
                                    <td><span class="badge badge-${project.visibility === 'public' ? 'success' : 'warning'}">${project.visibility}</span></td>
                                    <td class="text-sm">${new Date(project.created_at).toLocaleDateString()}</td>
                                    ${hasPermission(PERMISSIONS.EDIT_OWN_PROJECTS) ? `
                                    <td>
                                        <div class="flex gap-2">
                                            <button class="btn btn-sm btn-outline" onclick="editProject('${project.id}')">
                                                <i class="mdi mdi-pencil"></i>
                                            </button>
                                            ${hasPermission(PERMISSIONS.DELETE_PROJECTS) ? `
                                            <button class="btn btn-sm btn-danger" onclick="deleteProjectPrompt('${project.id}')">
                                                <i class="mdi mdi-delete"></i>
                                            </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                    ` : ''}
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="${hasPermission(PERMISSIONS.EDIT_OWN_PROJECTS) ? '6' : '5'}" class="text-center py-8">
                                        <p class="text-gray-500">No projects found</p>
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

// ========== EVENT LISTENERS ==========
document.addEventListener('DOMContentLoaded', function() {
    initializeDatabase().then(() => {
        if (authToken) {
            try {
                const tokenData = JSON.parse(atob(authToken));
                showAuthScreens();
            } catch {
                showAuthScreens();
            }
        } else {
            showAuthScreens();
        }
    });
    
    // Auth screen buttons
    document.getElementById('loginScreenBtn')?.addEventListener('click', () => showScreen('loginScreen'));
    document.getElementById('registerScreenBtn')?.addEventListener('click', () => showScreen('registerScreen'));
    document.getElementById('guestContinueBtn')?.addEventListener('click', showGuestDashboard);
    document.getElementById('backToLandingBtn')?.addEventListener('click', () => showScreen('landingScreen'));
    document.getElementById('backToLandingFromRegister')?.addEventListener('click', () => showScreen('landingScreen'));
    document.getElementById('forgotPasswordBtn')?.addEventListener('click', () => showScreen('forgotPasswordScreen'));
    document.getElementById('backToLoginBtn')?.addEventListener('click', () => showScreen('loginScreen'));
    document.getElementById('guestLoginBtn')?.addEventListener('click', () => showScreen('loginScreen'));
    
    // Login form
    document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const alertDiv = document.getElementById('loginAlert');
        
        alertDiv?.classList.add('hidden');
        
        try {
            await login(email, password);
            showMainDashboard();
            showToast('Welcome back!', 'success');
        } catch (error) {
            if (alertDiv) {
                alertDiv.textContent = error.message;
                alertDiv.classList.remove('hidden');
            }
        }
    });
    
    // Navigation
    document.addEventListener('click', (e) => {
        const navItem = e.target.closest('.nav-item');
        if (navItem && navItem.dataset.page) {
            e.preventDefault();
            loadPage(navItem.dataset.page);
        }
    });
    
    // Modal close
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-close') || e.target.classList.contains('modal-overlay')) {
            hideModals();
        }
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') hideModals();
    });
});

// ========== GLOBAL FUNCTIONS ==========
window.refreshDashboard = async function() {
    await loadDashboardStats();
    showToast('Dashboard refreshed', 'success');
};

window.logout = logout;

window.showNewProjectModal = function() {
    const modalContent = `
        <form id="newProjectForm" onsubmit="createProjectHandler(event)">
            <div class="space-y-4">
                <div class="form-group">
                    <label class="form-label">Project Name *</label>
                    <input type="text" id="projectName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="projectDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="projectStatus" class="form-control">
                            <option value="planning">Planning</option>
                            <option value="development" selected>Development</option>
                            <option value="testing">Testing</option>
                            <option value="production">Production</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Progress (%)</label>
                        <input type="number" id="projectProgress" class="form-control" min="0" max="100" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Visibility</label>
                    <select id="projectVisibility" class="form-control">
                        <option value="private">Private</option>
                        <option value="internal">Internal</option>
                        <option value="public">Public</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideModals()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </div>
        </form>
    `;
    showModal('newProjectModal', modalContent);
};

async function createProjectHandler(e) {
    e.preventDefault();
    
    const projectData = {
        name: document.getElementById('projectName').value,
        description: document.getElementById('projectDescription').value,
        status: document.getElementById('projectStatus').value,
        progress: parseInt(document.getElementById('projectProgress').value) || 0,
        visibility: document.getElementById('projectVisibility').value
    };
    
    const result = await createProject(projectData);
    
    if (result.success) {
        showToast('Project created successfully', 'success');
        hideModals();
        loadPage(currentPage);
    } else {
        showToast(`Failed to create project: ${result.error}`, 'error');
    }
}

window.filterProjects = async function(filter) {
    const projects = await loadProjects(filter);
    const tbody = document.getElementById('projectsTableBody');
    
    if (!tbody) return;
    
    tbody.innerHTML = projects.map(project => `
        <tr>
            <td>
                <div class="font-semibold">${project.name}</div>
                <div class="text-sm text-gray-600">${project.description?.substring(0, 50)}...</div>
            </td>
            <td><span class="badge badge-${project.status === 'archived' ? 'danger' : 'success'}">${project.status}</span></td>
            <td>${project.progress}%</td>
            <td><span class="badge badge-${project.visibility === 'public' ? 'success' : 'warning'}">${project.visibility}</span></td>
            <td class="text-sm">${new Date(project.created_at).toLocaleDateString()}</td>
            ${hasPermission(PERMISSIONS.EDIT_OWN_PROJECTS) ? `
            <td>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-outline" onclick="editProject('${project.id}')">
                        <i class="mdi mdi-pencil"></i>
                    </button>
                    ${hasPermission(PERMISSIONS.DELETE_PROJECTS) ? `
                    <button class="btn btn-sm btn-danger" onclick="deleteProjectPrompt('${project.id}')">
                        <i class="mdi mdi-delete"></i>
                    </button>
                    ` : ''}
                </div>
            </td>
            ` : ''}
        </tr>
    `).join('') || '<tr><td colspan="6" class="text-center py-8"><p class="text-gray-500">No projects found</p></td></tr>';
};

window.deleteProjectPrompt = async function(projectId) {
    const result = await deleteProject(projectId);
    if (result.success) {
        showToast('Project deleted successfully', 'success');
        loadPage(currentPage);
    } else {
        showToast(`Failed to delete project: ${result.error}`, 'error');
    }
};

window.editProject = async function(projectId) {
    showLoading('Loading project...');
    
    try {
        const { data: project, error } = await supabase
            .from('projects')
            .select('*')
            .eq('id', projectId)
            .single();
        
        if (error) throw error;
        
        const modalContent = `
            <form id="editProjectForm" onsubmit="updateProjectHandler(event, '${projectId}')">
                <div class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">Project Name *</label>
                        <input type="text" id="editProjectName" class="form-control" value="${project.name}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="editProjectDescription" class="form-control" rows="3">${project.description || ''}</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="editProjectStatus" class="form-control">
                                <option value="planning" ${project.status === 'planning' ? 'selected' : ''}>Planning</option>
                                <option value="development" ${project.status === 'development' ? 'selected' : ''}>Development</option>
                                <option value="testing" ${project.status === 'testing' ? 'selected' : ''}>Testing</option>
                                <option value="production" ${project.status === 'production' ? 'selected' : ''}>Production</option>
                                <option value="archived" ${project.status === 'archived' ? 'selected' : ''}>Archived</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Progress (%)</label>
                            <input type="number" id="editProjectProgress" class="form-control" min="0" max="100" value="${project.progress}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Visibility</label>
                        <select id="editProjectVisibility" class="form-control">
                            <option value="private" ${project.visibility === 'private' ? 'selected' : ''}>Private</option>
                            <option value="internal" ${project.visibility === 'internal' ? 'selected' : ''}>Internal</option>
                            <option value="public" ${project.visibility === 'public' ? 'selected' : ''}>Public</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="hideModals()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Project</button>
                    </div>
                </div>
            </form>
        `;
        
        hideLoading();
        showModal('newProjectModal', modalContent);
        
    } catch (error) {
        hideLoading();
        showToast('Failed to load project', 'error');
    }
};

async function updateProjectHandler(e, projectId) {
    e.preventDefault();
    
    const projectData = {
        name: document.getElementById('editProjectName').value,
        description: document.getElementById('editProjectDescription').value,
        status: document.getElementById('editProjectStatus').value,
        progress: parseInt(document.getElementById('editProjectProgress').value) || 0,
        visibility: document.getElementById('editProjectVisibility').value
    };
    
    const result = await updateProject(projectId, projectData);
    
    if (result.success) {
        showToast('Project updated successfully', 'success');
        hideModals();
        loadPage(currentPage);
    } else {
        showToast(`Failed to update project: ${result.error}`, 'error');
    }
}

// ========== DEBUG FUNCTIONS ==========
window.debugDatabase = async function() {
    console.log('=== DATABASE DEBUG ===');
    
    try {
        const [users, projects, tools] = await Promise.all([
            supabase.from('users').select('count', { count: 'exact', head: true }),
            supabase.from('projects').select('count', { count: 'exact', head: true }),
            supabase.from('tools').select('count', { count: 'exact', head: true })
        ]);
        
        console.log('Users:', users.count);
        console.log('Projects:', projects.count);
        console.log('Tools:', tools.count);
        
        showToast('Debug info logged to console', 'info');
    } catch (error) {
        console.error('Debug error:', error);
        showToast('Debug failed', 'error');
    }
};

// ========== INITIALIZATION ==========
// Start the application
window.addEventListener('load', () => {
    console.log('TRAci Platform v3.0 initialized');
});
    </script>
</body>
</html>
