<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>TRAci v3 | Pneumology Innovation Platform</title>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* ===== VARIABLES & RESET ===== */
        :root {
            /* Color System */
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            
            --medical-teal: #0d9488;
            --medical-green: #059669;
            --medical-purple: #7c3aed;
            --medical-cyan: #0891b2;
            --medical-pink: #db2777;
            
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --info: #3b82f6;
            --info-light: #dbeafe;
            
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Backgrounds */
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-sidebar: #1e293b;
            
            /* Borders */
            --border-light: #e2e8f0;
            --border: #cbd5e1;
            --border-dark: #94a3b8;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            
            /* Fonts */
            --font-sans: 'Inter', sans-serif;
            --font-heading: 'Space Grotesk', sans-serif;
            
            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            /* Sizes */
            --icon-sm: 1rem;
            --icon-md: 1.25rem;
            --icon-lg: 1.5rem;
            --icon-xl: 2rem;
            
            --btn-sm: 2rem;
            --btn-md: 2.5rem;
            --btn-lg: 3rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, var(--bg-primary) 0%, #f0f9ff 100%);
            color: var(--gray-800);
            line-height: 1.5;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 300px;
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--medical-teal) 100%);
            opacity: 0.03;
            z-index: -1;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .gap-8 { gap: 2rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .rounded { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .border { border: 1px solid var(--border); }
        .border-2 { border: 2px solid var(--border); }
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow { box-shadow: var(--shadow); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }

        /* ===== CONTAINER & LAYOUT ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem 0;
        }

        @media (min-width: 1024px) {
            .main-layout {
                grid-template-columns: 280px 1fr;
            }
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
            padding: 1.5rem;
            height: fit-content;
            box-shadow: var(--shadow-md);
        }

        .sidebar-header {
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-light);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--primary-50);
            color: var(--primary-600);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            box-shadow: var(--shadow);
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }

        /* ===== HEADER ===== */
        .header {
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-600), var(--medical-teal));
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            box-shadow: var(--shadow);
        }

        .platform-info h1 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-700), var(--medical-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .platform-info .subtitle {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* ===== BUTTONS (COMPACT) ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            min-height: var(--btn-md);
            text-decoration: none;
            user-select: none;
            touch-action: manipulation;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            min-height: var(--btn-sm);
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            min-height: var(--btn-lg);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            color: white;
            border-color: var(--primary-600);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-700), var(--primary-800));
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
            border-color: var(--gray-400);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border-color: var(--success);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            border-color: var(--danger);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-600);
            border-color: var(--primary-300);
        }

        .btn-outline:hover {
            background: var(--primary-50);
        }

        .btn-icon {
            width: var(--btn-md);
            padding: 0;
            justify-content: center;
        }

        .btn-icon-sm {
            width: var(--btn-sm);
            padding: 0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: var(--shadow);
            border-color: var(--primary-300);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-light);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ===== STATS CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-500), var(--medical-teal));
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--gray-900);
            font-family: var(--font-heading);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-family: var(--font-sans);
            transition: all 0.2s ease;
            background: var(--white);
            color: var(--gray-900);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .form-control::placeholder {
            color: var(--gray-400);
        }

        .form-text {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .form-error {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        /* ===== TABLES ===== */
        .table-container {
            overflow-x: auto;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .table th {
            background: var(--gray-50);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.75rem;
        }

        .table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .table tr:hover {
            background: var(--gray-50);
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .badge-warning {
            background: var(--warning-light);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .badge-danger {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .badge-info {
            background: var(--info-light);
            color: var(--info);
            border: 1px solid var(--info);
        }

        .badge-primary {
            background: var(--primary-100);
            color: var(--primary-700);
            border: 1px solid var(--primary-300);
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 1rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl);
        }

        @keyframes slideUp {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 1;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--danger);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .alert-success {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .alert-warning {
            background: var(--warning-light);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .alert-info {
            background: var(--info-light);
            color: var(--info);
            border: 1px solid var(--info);
        }

        /* ===== LOADING ===== */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.375rem;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ===== PERMISSION BADGES ===== */
        .permission-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--gray-100);
            color: var(--gray-700);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid transparent;
        }

        .permission-badge.active {
            background: var(--success-light);
            color: var(--success);
            border-color: var(--success);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .logo-section {
                justify-content: center;
            }
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .modal-content {
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
            }
        }

        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-400);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-500);
        }

        /* ===== GRID SYSTEM ===== */
        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }

        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .md\:grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        }

        /* ===== TOGGLE SWITCH ===== */
        .toggle {
            position: relative;
            display: inline-block;
            width: 3rem;
            height: 1.5rem;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-300);
            transition: .4s;
            border-radius: 1.5rem;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.125rem;
            width: 1.125rem;
            left: 0.1875rem;
            bottom: 0.1875rem;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(1.5rem);
        }

        /* ===== AVATAR ===== */
        .avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, var(--primary-500), var(--medical-teal));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .avatar-sm {
            width: 2rem;
            height: 2rem;
            font-size: 0.875rem;
        }

        .avatar-lg {
            width: 3rem;
            height: 3rem;
            font-size: 1.25rem;
        }

        /* ===== TOOLTIPS ===== */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-900);
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 0.5rem;
        }

        [data-tooltip]:hover::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 0.375rem solid transparent;
            border-top-color: var(--gray-900);
            margin-bottom: -0.125rem;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .bounce {
            animation: bounce 1s infinite;
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                border: 1px solid var(--gray-300) !important;
                box-shadow: none !important;
            }
            
            a {
                text-decoration: none !important;
                color: inherit !important;
            }
        }
    </style>
</head>
<body>
    <!-- ===== AUTH SCREENS ===== -->
    <div id="authScreens" class="container" style="max-width: 480px; padding-top: 3rem;">
        <!-- Landing Screen -->
        <div id="landingScreen" class="card">
            <div class="text-center mb-6">
                <div class="logo" style="margin: 0 auto 1.5rem; width: 64px; height: 64px; font-size: 1.75rem;">
                    <i class="mdi mdi-lungs"></i>
                </div>
                <h1 class="text-2xl font-bold mb-2">TRAci Platform</h1>
                <p class="text-gray-600 mb-6">Clinical Innovation & Research Collaboration</p>
            </div>
            
            <div class="space-y-3">
                <button id="loginScreenBtn" class="btn btn-primary w-full">
                    <i class="mdi mdi-login"></i>
                    Sign In
                </button>
                <button id="registerScreenBtn" class="btn btn-outline w-full">
                    <i class="mdi mdi-account-plus"></i>
                    Request Access
                </button>
                <button id="guestContinueBtn" class="btn btn-secondary w-full">
                    <i class="mdi mdi-eye"></i>
                    Continue as Guest
                </button>
            </div>
            
            <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                <p class="text-sm text-gray-500">
                    <i class="mdi mdi-shield-check"></i>
                    HIPAA Compliant • Secure Access • Audit Logged
                </p>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="card hidden">
            <div class="text-center mb-6">
                <div class="logo" style="margin: 0 auto 1rem; width: 48px; height: 48px;">
                    <i class="mdi mdi-shield-lock"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">Secure Sign In</h2>
                <p class="text-gray-600">Access your clinical innovation dashboard</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" 
                           placeholder="your.email@hospital.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-control" 
                           placeholder="Enter your password" required>
                    <div class="flex justify-between mt-1">
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" id="rememberMe" class="rounded">
                            <span>Remember me</span>
                        </label>
                        <button type="button" id="forgotPasswordBtn" class="text-sm text-primary-600 hover:underline">
                            Forgot password?
                        </button>
                    </div>
                </div>
                
                <div id="loginAlert" class="alert alert-error hidden"></div>
                
                <button type="submit" class="btn btn-primary w-full mb-3">
                    <span id="loginBtnText">Sign In</span>
                </button>
                
                <button type="button" id="backToLandingBtn" class="btn btn-secondary w-full">
                    <i class="mdi mdi-arrow-left"></i>
                    Back
                </button>
            </form>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="card hidden">
            <div class="text-center mb-6">
                <div class="logo" style="margin: 0 auto 1rem; width: 48px; height: 48px;">
                    <i class="mdi mdi-account-plus"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">Request Access</h2>
                <p class="text-gray-600">Submit your details for administrator approval</p>
            </div>
            
            <form id="registerForm">
                <div class="grid grid-cols-2 gap-3">
                    <div class="form-group">
                        <label class="form-label">First Name</label>
                        <input type="text" id="registerFirstName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name</label>
                        <input type="text" id="registerLastName" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="registerEmail" class="form-control" 
                           placeholder="professional.email@institution.com" required>
                    <div class="form-text">Use your institutional email for verification</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Institution/Organization</label>
                    <input type="text" id="registerInstitution" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Department</label>
                    <select id="registerDepartment" class="form-control" required>
                        <option value="">Select department</option>
                        <option value="pulmonology">Pulmonology</option>
                        <option value="cardiology">Cardiology</option>
                        <option value="neurology">Neurology</option>
                        <option value="radiology">Radiology</option>
                        <option value="research">Research</option>
                        <option value="administration">Administration</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Role/Position</label>
                    <input type="text" id="registerPosition" class="form-control" 
                           placeholder="e.g., Clinical Lead, Researcher, etc.">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Purpose of Access</label>
                    <textarea id="registerPurpose" class="form-control" rows="3" 
                              placeholder="Briefly describe why you need access to the platform..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="registerTerms" required class="rounded">
                        <span class="text-sm">I agree to the platform terms and data usage policy</span>
                    </label>
                </div>
                
                <div id="registerAlert" class="alert hidden"></div>
                
                <button type="submit" class="btn btn-primary w-full mb-3">
                    <span id="registerBtnText">Submit Request</span>
                </button>
                
                <button type="button" id="backToLandingFromRegister" class="btn btn-secondary w-full">
                    <i class="mdi mdi-arrow-left"></i>
                    Cancel
                </button>
            </form>
        </div>

        <!-- Forgot Password Screen -->
        <div id="forgotPasswordScreen" class="card hidden">
            <div class="text-center mb-6">
                <div class="logo" style="margin: 0 auto 1rem; width: 48px; height: 48px;">
                    <i class="mdi mdi-key-reset"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">Reset Password</h2>
                <p class="text-gray-600">Enter your email to receive reset instructions</p>
            </div>
            
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="resetEmail" class="form-control" required>
                    <div class="form-text">You'll receive a secure link to reset your password</div>
                </div>
                
                <div id="resetAlert" class="alert hidden"></div>
                
                <button type="submit" class="btn btn-primary w-full mb-3">
                    Send Reset Instructions
                </button>
                
                <button type="button" id="backToLoginBtn" class="btn btn-secondary w-full">
                    <i class="mdi mdi-arrow-left"></i>
                    Back to Login
                </button>
            </form>
        </div>

        <!-- Guest Dashboard -->
        <div id="guestDashboard" class="hidden">
            <div class="header mb-6">
                <div class="logo-section">
                    <div class="logo">
                        <i class="mdi mdi-lungs"></i>
                    </div>
                    <div class="platform-info">
                        <h1>TRAci Platform</h1>
                        <div class="subtitle">Guest Preview Mode</div>
                    </div>
                </div>
                <button id="guestLoginBtn" class="btn btn-primary">
                    <i class="mdi mdi-login"></i>
                    Sign In
                </button>
            </div>
            
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="mdi mdi-information"></i>
                        Welcome Guest
                    </h3>
                </div>
                <div class="space-y-3">
                    <p>You're viewing the TRAci platform in guest mode. Some features are restricted.</p>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-outline">
                            <i class="mdi mdi-eye"></i>
                            View Public Projects
                        </button>
                        <button class="btn btn-sm btn-outline">
                            <i class="mdi mdi-toolbox"></i>
                            Browse Tools
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MAIN DASHBOARD (Initially Hidden) ===== -->
    <div id="mainDashboard" class="hidden">
        <div class="container">
            <!-- Header -->
            <header class="header">
                <div class="logo-section">
                    <div class="logo">
                        <i class="mdi mdi-lungs"></i>
                    </div>
                    <div class="platform-info">
                        <h1>TRAci Platform</h1>
                        <div class="subtitle">Pneumology Innovation</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="status-panel hidden" id="statusPanel">
                        <span class="live-indicator">
                            <span class="live-dot"></span>
                            <span>LIVE</span>
                        </span>
                        <span class="text-sm text-gray-600 ml-2">
                            Updated: <span id="lastUpdatedTime">--:--</span>
                        </span>
                    </div>
                    
                    <div class="user-menu" id="userMenu">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </header>

            <!-- Main Layout -->
            <div class="main-layout">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <div class="sidebar-header">
                        <h3 class="font-semibold text-gray-900">Navigation</h3>
                    </div>
                    
                    <nav class="space-y-1">
                        <a href="#" class="nav-item active" data-page="dashboard">
                            <i class="mdi mdi-view-dashboard"></i>
                            Dashboard
                        </a>
                        
                        <a href="#" class="nav-item" data-page="projects">
                            <i class="mdi mdi-flask"></i>
                            Projects
                            <span class="badge" id="projectsBadge">0</span>
                        </a>
                        
                        <a href="#" class="nav-item" data-page="tools">
                            <i class="mdi mdi-toolbox"></i>
                            Clinical Tools
                        </a>
                        
                        <a href="#" class="nav-item" data-page="collaboration">
                            <i class="mdi mdi-comment-multiple"></i>
                            Collaboration
                            <span class="badge" id="commentsBadge">0</span>
                        </a>
                        
                        <div class="pt-4 mt-4 border-t border-gray-200">
                            <div class="px-3 mb-2 text-xs font-semibold text-gray-500 uppercase">Administration</div>
                            
                            <a href="#" class="nav-item" data-page="users">
                                <i class="mdi mdi-account-multiple"></i>
                                User Management
                            </a>
                            
                            <a href="#" class="nav-item" data-page="permissions">
                                <i class="mdi mdi-shield-account"></i>
                                Permissions
                            </a>
                            
                            <a href="#" class="nav-item" data-page="audit">
                                <i class="mdi mdi-history"></i>
                                Audit Log
                            </a>
                            
                            <a href="#" class="nav-item" data-page="settings">
                                <i class="mdi mdi-cog"></i>
                                Settings
                            </a>
                        </div>
                    </nav>
                    
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <button id="quickAddProject" class="btn btn-primary w-full mb-3">
                            <i class="mdi mdi-plus"></i>
                            New Project
                        </button>
                        <button id="quickAddTool" class="btn btn-outline w-full">
                            <i class="mdi mdi-toolbox-plus"></i>
                            Add Tool
                        </button>
                    </div>
                </aside>

                <!-- Main Content Area -->
                <main class="space-y-6">
                    <!-- Stats Overview -->
                    <section id="statsSection" class="hidden">
                        <div class="stats-grid">
                            <div class="card stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary-500), var(--primary-600));">
                                    <i class="mdi mdi-flask"></i>
                                </div>
                                <div class="stat-value" id="projectsCount">0</div>
                                <div class="stat-label">Active Projects</div>
                            </div>
                            
                            <div class="card stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--medical-teal), var(--medical-cyan));">
                                    <i class="mdi mdi-toolbox"></i>
                                </div>
                                <div class="stat-value" id="toolsCount">0</div>
                                <div class="stat-label">Clinical Tools</div>
                            </div>
                            
                            <div class="card stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--success), var(--medical-green));">
                                    <i class="mdi mdi-comment-multiple"></i>
                                </div>
                                <div class="stat-value" id="collaborationCount">0</div>
                                <div class="stat-label">Collaborations</div>
                            </div>
                            
                            <div class="card stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, var(--medical-purple), #9333ea);">
                                    <i class="mdi mdi-shield-account"></i>
                                </div>
                                <div class="stat-value" id="usersCount">0</div>
                                <div class="stat-label">Active Users</div>
                            </div>
                        </div>
                    </section>

                    <!-- Page Content -->
                    <div id="pageContent">
                        <!-- Will be populated by JavaScript based on navigation -->
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- ===== MODALS ===== -->
    
    <!-- Login Modal (for guest dashboard) -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="mdi mdi-shield-lock"></i>
                    Sign In
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Login form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="mdi mdi-plus-circle"></i>
                    New Project
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Project form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Permission Editor Modal -->
    <div id="permissionEditorModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="mdi mdi-shield-account"></i>
                    Permission Editor
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Permission editor will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal-overlay" style="background: rgba(255, 255, 255, 0.9); display: none;">
        <div class="flex flex-col items-center justify-center gap-4">
            <div class="loading-spinner" style="width: 3rem; height: 3rem; border-width: 3px;"></div>
            <p class="text-lg font-semibold text-gray-700" id="loadingText">Loading...</p>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toastContainer" style="position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; max-width: 400px;"></div>

    <!-- JavaScript -->
    <script>
        // ========== CONFIGURATION ==========
        const SUPABASE_URL = 'https://bledpouekiytppuhxeqq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_zdlIM8UbOrRIFpmYLJOmWQ_4QqNi_5C';
        
        // ========== SUPABASE INITIALIZATION ==========
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ========== GLOBAL STATE ==========
        let currentUser = null;
        let userPermissions = {};
        let authToken = localStorage.getItem('traci_auth_token');
        let sessionTimeout = null;
        
        // ========== PERMISSION DEFINITIONS ==========
        const PERMISSIONS = {
            // Project permissions
            VIEW_PROJECTS: 'view_projects',
            CREATE_PROJECTS: 'create_projects',
            EDIT_OWN_PROJECTS: 'edit_own_projects',
            EDIT_ALL_PROJECTS: 'edit_all_projects',
            DELETE_PROJECTS: 'delete_projects',
            EXPORT_PROJECTS: 'export_projects',
            
            // Tool permissions
            VIEW_TOOLS: 'view_tools',
            MANAGE_TOOLS: 'manage_tools',
            
            // Collaboration permissions
            VIEW_COMMENTS: 'view_comments',
            CREATE_COMMENTS: 'create_comments',
            MODERATE_COMMENTS: 'moderate_comments',
            
            // User permissions
            VIEW_USERS: 'view_users',
            MANAGE_USERS: 'manage_users',
            EDIT_PERMISSIONS: 'edit_permissions',
            
            // System permissions
            VIEW_AUDIT_LOG: 'view_audit_log',
            MANAGE_SETTINGS: 'manage_settings',
            SYNC_EXTERNAL: 'sync_external',
            
            // Special permissions
            BYPASS_APPROVAL: 'bypass_approval',
            SUPER_ADMIN: 'super_admin'
        };
        
        // Permission presets
        const PERMISSION_PRESETS = {
            CLINICAL_LEAD: {
                name: 'Clinical Lead',
                permissions: [
                    PERMISSIONS.VIEW_PROJECTS,
                    PERMISSIONS.CREATE_PROJECTS,
                    PERMISSIONS.EDIT_OWN_PROJECTS,
                    PERMISSIONS.EDIT_ALL_PROJECTS,
                    PERMISSIONS.VIEW_TOOLS,
                    PERMISSIONS.VIEW_COMMENTS,
                    PERMISSIONS.CREATE_COMMENTS,
                    PERMISSIONS.MODERATE_COMMENTS,
                    PERMISSIONS.VIEW_USERS,
                    PERMISSIONS.EXPORT_PROJECTS
                ]
            },
            RESEARCHER: {
                name: 'Researcher',
                permissions: [
                    PERMISSIONS.VIEW_PROJECTS,
                    PERMISSIONS.CREATE_PROJECTS,
                    PERMISSIONS.EDIT_OWN_PROJECTS,
                    PERMISSIONS.VIEW_TOOLS,
                    PERMISSIONS.VIEW_COMMENTS,
                    PERMISSIONS.CREATE_COMMENTS
                ]
            },
            EXTERNAL_COLLABORATOR: {
                name: 'External Collaborator',
                permissions: [
                    PERMISSIONS.VIEW_PROJECTS,
                    PERMISSIONS.VIEW_COMMENTS,
                    PERMISSIONS.CREATE_COMMENTS
                ]
            },
            AUDITOR: {
                name: 'Auditor',
                permissions: [
                    PERMISSIONS.VIEW_PROJECTS,
                    PERMISSIONS.VIEW_TOOLS,
                    PERMISSIONS.VIEW_COMMENTS,
                    PERMISSIONS.VIEW_USERS,
                    PERMISSIONS.VIEW_AUDIT_LOG,
                    PERMISSIONS.EXPORT_PROJECTS
                ]
            }
        };
        
        // ========== UTILITY FUNCTIONS ==========
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            let bgColor = 'bg-blue-100 border-blue-500 text-blue-700';
            let icon = 'mdi-information';
            
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-100 border-green-500 text-green-700';
                    icon = 'mdi-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-100 border-red-500 text-red-700';
                    icon = 'mdi-alert-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-100 border-yellow-500 text-yellow-700';
                    icon = 'mdi-alert';
                    break;
            }
            
            toast.className = `border-l-4 ${bgColor} p-4 rounded shadow-lg flex items-center gap-3 animate-slide-in`;
            toast.innerHTML = `
                <i class="mdi ${icon} text-xl"></i>
                <div class="flex-1">${message}</div>
                <button class="text-gray-500 hover:text-gray-700" onclick="this.parentElement.remove()">
                    <i class="mdi mdi-close"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, duration);
            }
            
            // Add animation style
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                .animate-slide-in {
                    animation: slideIn 0.3s ease;
                }
            `;
            if (!document.getElementById('toast-animations')) {
                style.id = 'toast-animations';
                document.head.appendChild(style);
            }
        }
        
        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            overlay.style.display = 'flex';
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }
        
        function hasPermission(permission) {
            if (!currentUser) return false;
            if (userPermissions[PERMISSIONS.SUPER_ADMIN]) return true;
            return userPermissions[permission] === true;
        }
        
        function updateUIForPermissions() {
            // Hide/show elements based on permissions
            const elements = document.querySelectorAll('[data-permission]');
            elements.forEach(element => {
                const requiredPermission = element.dataset.permission;
                if (requiredPermission && !hasPermission(requiredPermission)) {
                    element.classList.add('hidden');
                } else {
                    element.classList.remove('hidden');
                }
            });
            
            // Update sidebar based on permissions
            const navItems = {
                dashboard: true,
                projects: hasPermission(PERMISSIONS.VIEW_PROJECTS),
                tools: hasPermission(PERMISSIONS.VIEW_TOOLS),
                collaboration: hasPermission(PERMISSIONS.VIEW_COMMENTS),
                users: hasPermission(PERMISSIONS.VIEW_USERS),
                permissions: hasPermission(PERMISSIONS.EDIT_PERMISSIONS),
                audit: hasPermission(PERMISSIONS.VIEW_AUDIT_LOG),
                settings: hasPermission(PERMISSIONS.MANAGE_SETTINGS)
            };
            
            Object.entries(navItems).forEach(([page, visible]) => {
                const navItem = document.querySelector(`[data-page="${page}"]`);
                if (navItem) {
                    if (!visible) {
                        navItem.classList.add('hidden');
                    }
                }
            });
        }
        
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        function generateRandomPassword(length = 12) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return password;
        }
        
        // ========== DATABASE FUNCTIONS ==========
        async function initializeDatabase() {
            showLoading('Initializing database...');
            
            try {
                // Check if tables exist and create if needed
                const { error: usersError } = await supabase
                    .from('users')
                    .select('count', { count: 'exact', head: true });
                
                if (usersError && usersError.message.includes('relation "users" does not exist')) {
                    await createDatabaseTables();
                }
                
                hideLoading();
                return true;
            } catch (error) {
                console.error('Database initialization error:', error);
                hideLoading();
                showToast('Database initialization failed', 'error');
                return false;
            }
        }
        
        async function createDatabaseTables() {
            // This is a conceptual function - in reality, you'd run SQL in Supabase
            showToast('Please create database tables via Supabase SQL Editor', 'warning', 10000);
            
            const sql = `
                -- Users table with permissions
                CREATE TABLE IF NOT EXISTS users (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    email TEXT UNIQUE NOT NULL,
                    username TEXT,
                    full_name TEXT,
                    institution TEXT,
                    department TEXT,
                    position TEXT,
                    encrypted_password TEXT,
                    status TEXT DEFAULT 'pending', -- pending, active, suspended
                    permissions JSONB DEFAULT '{}',
                    last_login TIMESTAMP WITH TIME ZONE,
                    login_attempts INTEGER DEFAULT 0,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- Access requests table
                CREATE TABLE IF NOT EXISTS access_requests (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    email TEXT NOT NULL,
                    full_name TEXT,
                    institution TEXT,
                    department TEXT,
                    position TEXT,
                    purpose TEXT,
                    status TEXT DEFAULT 'pending', -- pending, approved, rejected
                    reviewed_by UUID REFERENCES users(id),
                    reviewed_at TIMESTAMP WITH TIME ZONE,
                    notes TEXT,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- Projects table
                CREATE TABLE IF NOT EXISTS projects (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    name TEXT NOT NULL,
                    description TEXT,
                    status TEXT DEFAULT 'planning', -- planning, development, testing, production, archived
                    progress INTEGER DEFAULT 0,
                    category TEXT,
                    priority TEXT DEFAULT 'medium', -- low, medium, high, critical
                    needs_feedback BOOLEAN DEFAULT false,
                    visibility TEXT DEFAULT 'private', -- public, private, internal
                    owner_id UUID REFERENCES users(id),
                    edit_code TEXT,
                    review_status TEXT DEFAULT 'none', -- none, pending, approved, rejected, needs_revision
                    tags TEXT[],
                    metadata JSONB DEFAULT '{}',
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- Tools table
                CREATE TABLE IF NOT EXISTS tools (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    name TEXT NOT NULL,
                    description TEXT,
                    url TEXT,
                    status TEXT DEFAULT 'operational', -- operational, maintenance, deprecated, beta
                    category TEXT,
                    icon TEXT DEFAULT 'mdi mdi-toolbox',
                    last_checked TIMESTAMP WITH TIME ZONE,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- Comments/audit logs table
                CREATE TABLE IF NOT EXISTS audit_logs (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    user_id UUID REFERENCES users(id),
                    user_name TEXT,
                    action TEXT NOT NULL,
                    details JSONB DEFAULT '{}',
                    project_id UUID REFERENCES projects(id),
                    ip_address TEXT,
                    user_agent TEXT,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- Create indexes
                CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
                CREATE INDEX IF NOT EXISTS idx_users_status ON users(status);
                CREATE INDEX IF NOT EXISTS idx_projects_status ON projects(status);
                CREATE INDEX IF NOT EXISTS idx_projects_visibility ON projects(visibility);
                CREATE INDEX IF NOT EXISTS idx_audit_logs_created ON audit_logs(created_at DESC);
                CREATE INDEX IF NOT EXISTS idx_audit_logs_action ON audit_logs(action);
                
                -- Insert default super admin if no users exist
                DO $$
                BEGIN
                    IF NOT EXISTS (SELECT 1 FROM users WHERE email = 'admin@hospital.com') THEN
                        INSERT INTO users (
                            email, 
                            username, 
                            full_name, 
                            institution, 
                            department,
                            encrypted_password,
                            status,
                            permissions
                        ) VALUES (
                            'admin@hospital.com',
                            'admin',
                            'System Administrator',
                            'Hospital System',
                            'Administration',
                            '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8', -- password
                            'active',
                            '{"super_admin": true}'
                        );
                    END IF;
                END $$;
            `;
            
            console.log('Run this SQL in Supabase SQL Editor:', sql);
        }
        
        // ========== AUTHENTICATION FUNCTIONS ==========
        async function login(email, password) {
            showLoading('Signing in...');
            
            try {
                const hashedPassword = await hashPassword(password);
                
                // Check user exists and is active
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email.toLowerCase().trim())
                    .single();
                
                if (error) {
                    throw new Error('Invalid email or password');
                }
                
                if (user.status !== 'active') {
                    throw new Error('Account is not active. Please contact administrator.');
                }
                
                if (user.encrypted_password !== hashedPassword) {
                    // Update login attempts
                    await supabase
                        .from('users')
                        .update({ 
                            login_attempts: (user.login_attempts || 0) + 1,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', user.id);
                    
                    throw new Error('Invalid email or password');
                }
                
                // Reset login attempts on successful login
                await supabase
                    .from('users')
                    .update({ 
                        login_attempts: 0,
                        last_login: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', user.id);
                
                // Parse permissions
                const permissions = user.permissions || {};
                
                // Set current user
                currentUser = {
                    id: user.id,
                    email: user.email,
                    username: user.username || user.email.split('@')[0],
                    full_name: user.full_name || 'User',
                    institution: user.institution || '',
                    department: user.department || '',
                    position: user.position || '',
                    status: user.status,
                    created_at: user.created_at
                };
                
                userPermissions = permissions;
                
                // Create auth token
                authToken = btoa(JSON.stringify({
                    userId: user.id,
                    email: user.email,
                    timestamp: Date.now()
                }));
                localStorage.setItem('traci_auth_token', authToken);
                
                // Set session timeout (8 hours)
                resetSessionTimeout();
                
                // Log audit
                await logAudit('login', { 
                    email: email,
                    permissions: Object.keys(permissions).filter(p => permissions[p])
                });
                
                hideLoading();
                return true;
                
            } catch (error) {
                hideLoading();
                console.error('Login error:', error);
                throw error;
            }
        }
        
        function resetSessionTimeout() {
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
            }
            
            // 8 hours session
            sessionTimeout = setTimeout(() => {
                showToast('Session expired. Please sign in again.', 'warning');
                logout();
            }, 8 * 60 * 60 * 1000);
        }
        
        function logout() {
            if (currentUser) {
                logAudit('logout', {});
            }
            
            currentUser = null;
            userPermissions = {};
            authToken = null;
            localStorage.removeItem('traci_auth_token');
            
            if (sessionTimeout) {
                clearTimeout(sessionTimeout);
                sessionTimeout = null;
            }
            
            showAuthScreens();
        }
        
        async function registerAccessRequest(formData) {
            showLoading('Submitting request...');
            
            try {
                // Check if email already exists
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('id')
                    .eq('email', formData.email)
                    .single();
                
                if (existingUser) {
                    throw new Error('An account with this email already exists.');
                }
                
                // Check for pending request
                const { data: pendingRequest } = await supabase
                    .from('access_requests')
                    .select('id')
                    .eq('email', formData.email)
                    .eq('status', 'pending')
                    .single();
                
                if (pendingRequest) {
                    throw new Error('You already have a pending access request.');
                }
                
                // Create access request
                const { data, error } = await supabase
                    .from('access_requests')
                    .insert([{
                        email: formData.email,
                        full_name: `${formData.firstName} ${formData.lastName}`.trim(),
                        institution: formData.institution,
                        department: formData.department,
                        position: formData.position,
                        purpose: formData.purpose,
                        status: 'pending'
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                hideLoading();
                return data;
                
            } catch (error) {
                hideLoading();
                throw error;
            }
        }
        
        async function requestPasswordReset(email) {
            showLoading('Processing request...');
            
            try {
                // Check if user exists
                const { data: user } = await supabase
                    .from('users')
                    .select('id, email, full_name')
                    .eq('email', email)
                    .single();
                
                if (!user) {
                    // Don't reveal if user exists or not
                    hideLoading();
                    return true;
                }
                
                // Generate reset token
                const resetToken = btoa(JSON.stringify({
                    userId: user.id,
                    email: user.email,
                    expires: Date.now() + 3600000 // 1 hour
                }));
                
                // In a real app, you would:
                // 1. Store reset token in database
                // 2. Send email with reset link
                // 3. Validate token on reset
                
                // For now, just show a message
                hideLoading();
                showToast(`Password reset instructions sent to ${email}`, 'success');
                return true;
                
            } catch (error) {
                hideLoading();
                // Don't reveal error details
                return true;
            }
        }
        
        // ========== AUDIT LOGGING ==========
        async function logAudit(action, details, projectId = null) {
            if (!currentUser) return;
            
            try {
                const auditData = {
                    user_id: currentUser.id,
                    user_name: currentUser.full_name || currentUser.email,
                    action: action,
                    details: details,
                    project_id: projectId,
                    created_at: new Date().toISOString()
                };
                
                const { error } = await supabase
                    .from('audit_logs')
                    .insert([auditData]);
                
                if (error) {
                    console.error('Audit log error:', error);
                }
            } catch (error) {
                console.error('Failed to log audit:', error);
            }
        }
        
        // ========== UI MANAGEMENT ==========
        function showAuthScreens() {
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('guestDashboard').classList.add('hidden');
            document.getElementById('authScreens').classList.remove('hidden');
            
            showScreen('landingScreen');
        }
        
        function showMainDashboard() {
            document.getElementById('authScreens').classList.add('hidden');
            document.getElementById('guestDashboard').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            
            updateUIForPermissions();
            loadDashboard();
        }
        
        function showGuestDashboard() {
            document.getElementById('authScreens').classList.add('hidden');
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('guestDashboard').classList.remove('hidden');
        }
        
        function showScreen(screenId) {
            // Hide all screens
            ['landingScreen', 'loginScreen', 'registerScreen', 'forgotPasswordScreen'].forEach(id => {
                document.getElementById(id)?.classList.add('hidden');
            });
            
            // Show requested screen
            document.getElementById(screenId)?.classList.remove('hidden');
        }
        
        function showModal(modalId, content = null) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // Hide all modals first
            document.querySelectorAll('.modal-overlay').forEach(m => {
                m.style.display = 'none';
            });
            
            if (content) {
                const modalBody = modal.querySelector('.modal-body');
                if (modalBody) {
                    modalBody.innerHTML = content;
                }
            }
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function hideModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
            document.body.style.overflow = 'auto';
        }
        
        // ========== DASHBOARD FUNCTIONS ==========
        async function loadDashboard() {
            if (!currentUser) return;
            
            showLoading('Loading dashboard...');
            
            try {
                // Load stats
                await loadDashboardStats();
                
                // Load initial page
                await loadPage('dashboard');
                
                // Update user menu
                updateUserMenu();
                
                hideLoading();
                
            } catch (error) {
                hideLoading();
                console.error('Dashboard load error:', error);
                showToast('Failed to load dashboard', 'error');
            }
        }
        
        async function loadDashboardStats() {
            try {
                // Get counts
                const [
                    projectsCount,
                    toolsCount,
                    commentsCount,
                    usersCount
                ] = await Promise.all([
                    getProjectsCount(),
                    getToolsCount(),
                    getCommentsCount(),
                    getUsersCount()
                ]);
                
                // Update UI
                document.getElementById('projectsCount').textContent = projectsCount;
                document.getElementById('toolsCount').textContent = toolsCount;
                document.getElementById('collaborationCount').textContent = commentsCount;
                document.getElementById('usersCount').textContent = usersCount;
                
                // Update badges
                document.getElementById('projectsBadge').textContent = projectsCount;
                document.getElementById('commentsBadge').textContent = commentsCount;
                
                // Show stats section
                document.getElementById('statsSection').classList.remove('hidden');
                
            } catch (error) {
                console.error('Stats load error:', error);
            }
        }
        
        async function getProjectsCount() {
            try {
                let query = supabase
                    .from('projects')
                    .select('id', { count: 'exact', head: true });
                
                // Filter by visibility based on permissions
                if (!hasPermission(PERMISSIONS.EDIT_ALL_PROJECTS)) {
                    query = query.eq('visibility', 'public');
                }
                
                const { count, error } = await query;
                return error ? 0 : count;
            } catch {
                return 0;
            }
        }
        
        async function getToolsCount() {
            try {
                const { count, error } = await supabase
                    .from('tools')
                    .select('id', { count: 'exact', head: true });
                
                return error ? 0 : count;
            } catch {
                return 0;
            }
        }
        
        async function getCommentsCount() {
            try {
                const { count, error } = await supabase
                    .from('audit_logs')
                    .select('id', { count: 'exact', head: true })
                    .eq('action', 'comment_added');
                
                return error ? 0 : count;
            } catch {
                return 0;
            }
        }
        
        async function getUsersCount() {
            if (!hasPermission(PERMISSIONS.VIEW_USERS)) return 0;
            
            try {
                const { count, error } = await supabase
                    .from('users')
                    .select('id', { count: 'exact', head: true })
                    .eq('status', 'active');
                
                return error ? 0 : count;
            } catch {
                return 0;
            }
        }
        
        // ========== PAGE LOADING ==========
        async function loadPage(page) {
            const content = document.getElementById('pageContent');
            if (!content) return;
            
            showLoading(`Loading ${page}...`);
            
            try {
                let html = '';
                
                switch (page) {
                    case 'dashboard':
                        html = await loadDashboardPage();
                        break;
                    case 'projects':
                        html = await loadProjectsPage();
                        break;
                    case 'tools':
                        html = await loadToolsPage();
                        break;
                    case 'collaboration':
                        html = await loadCollaborationPage();
                        break;
                    case 'users':
                        html = await loadUsersPage();
                        break;
                    case 'permissions':
                        html = await loadPermissionsPage();
                        break;
                    case 'audit':
                        html = await loadAuditPage();
                        break;
                    case 'settings':
                        html = await loadSettingsPage();
                        break;
                    default:
                        html = '<div class="card"><p>Page not found</p></div>';
                }
                
                content.innerHTML = html;
                
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
                
                hideLoading();
                
            } catch (error) {
                hideLoading();
                content.innerHTML = `
                    <div class="card">
                        <div class="text-center py-8">
                            <i class="mdi mdi-alert-circle text-4xl text-red-500 mb-4"></i>
                            <h3 class="text-lg font-semibold mb-2">Error Loading Page</h3>
                            <p class="text-gray-600">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        async function loadDashboardPage() {
            return `
                <div class="space-y-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-view-dashboard"></i>
                                Welcome, ${currentUser.full_name}
                            </h3>
                            <button class="btn btn-sm btn-outline" onclick="refreshDashboard()">
                                <i class="mdi mdi-refresh"></i>
                                Refresh
                            </button>
                        </div>
                        <div class="space-y-4">
                            <p>Welcome to the TRAci Clinical Innovation Platform. Here's what you can do:</p>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                ${hasPermission(PERMISSIONS.CREATE_PROJECTS) ? `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                                            <i class="mdi mdi-plus text-primary-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold">Create Project</h4>
                                            <p class="text-sm text-gray-600">Start new research initiative</p>
                                        </div>
                                    </div>
                                    <button onclick="showNewProjectModal()" class="btn btn-sm btn-primary w-full">
                                        New Project
                                    </button>
                                </div>
                                ` : ''}
                                
                                ${hasPermission(PERMISSIONS.VIEW_PROJECTS) ? `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                                            <i class="mdi mdi-flask text-green-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold">Browse Projects</h4>
                                            <p class="text-sm text-gray-600">View clinical initiatives</p>
                                        </div>
                                    </div>
                                    <button onclick="loadPage('projects')" class="btn btn-sm btn-outline w-full">
                                        View All
                                    </button>
                                </div>
                                ` : ''}
                                
                                ${hasPermission(PERMISSIONS.VIEW_TOOLS) ? `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                                            <i class="mdi mdi-toolbox text-blue-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold">Clinical Tools</h4>
                                            <p class="text-sm text-gray-600">Access resources</p>
                                        </div>
                                    </div>
                                    <button onclick="loadPage('tools')" class="btn btn-sm btn-outline w-full">
                                        Explore Tools
                                    </button>
                                </div>
                                ` : ''}
                                
                                ${hasPermission(PERMISSIONS.VIEW_COMMENTS) ? `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
                                            <i class="mdi mdi-comment-multiple text-purple-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold">Collaboration</h4>
                                            <p class="text-sm text-gray-600">Join discussions</p>
                                        </div>
                                    </div>
                                    <button onclick="loadPage('collaboration')" class="btn btn-sm btn-outline w-full">
                                        View Discussions
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-history"></i>
                                Recent Activity
                            </h3>
                        </div>
                        <div class="space-y-3" id="recentActivity">
                            <div class="text-center py-8">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="text-gray-500 mt-2">Loading activity...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function loadProjectsPage() {
            if (!hasPermission(PERMISSIONS.VIEW_PROJECTS)) {
                return `
                    <div class="card">
                        <div class="text-center py-8">
                            <i class="mdi mdi-lock text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold mb-2">Access Restricted</h3>
                            <p class="text-gray-600">You don't have permission to view projects.</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-flask"></i>
                                Research Projects
                            </h3>
                            ${hasPermission(PERMISSIONS.CREATE_PROJECTS) ? `
                            <button onclick="showNewProjectModal()" class="btn btn-primary">
                                <i class="mdi mdi-plus"></i>
                                New Project
                            </button>
                            ` : ''}
                        </div>
                        <div class="space-y-4">
                            <!-- Filter controls -->
                            <div class="flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-primary" data-filter="all">All</button>
                                <button class="btn btn-sm btn-outline" data-filter="active">Active</button>
                                <button class="btn btn-sm btn-outline" data-filter="archived">Archived</button>
                                <button class="btn btn-sm btn-outline" data-filter="needs_review">Needs Review</button>
                            </div>
                            
                            <!-- Projects list -->
                            <div id="projectsList">
                                <div class="text-center py-8">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="text-gray-500 mt-2">Loading projects...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        // ========== CONTINUING FROM PREVIOUS SCRIPT ==========

        // ========== PAGE LOADING CONTINUED ==========
        async function loadToolsPage() {
            if (!hasPermission(PERMISSIONS.VIEW_TOOLS)) {
                return `
                    <div class="card">
                        <div class="text-center py-8">
                            <i class="mdi mdi-lock text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold mb-2">Access Restricted</h3>
                            <p class="text-gray-600">You don't have permission to view tools.</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-toolbox"></i>
                                Clinical Tools & Resources
                            </h3>
                            ${hasPermission(PERMISSIONS.MANAGE_TOOLS) ? `
                            <button onclick="showNewToolModal()" class="btn btn-primary">
                                <i class="mdi mdi-plus"></i>
                                Add Tool
                            </button>
                            ` : ''}
                        </div>
                        
                        <div class="table-container">
                            <table class="table" id="toolsTable">
                                <thead>
                                    <tr>
                                        <th>Tool</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        ${hasPermission(PERMISSIONS.MANAGE_TOOLS) ? '<th>Actions</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="${hasPermission(PERMISSIONS.MANAGE_TOOLS) ? '5' : '4'}" class="text-center py-8">
                                            <div class="loading-spinner mx-auto"></div>
                                            <p class="text-gray-500 mt-2">Loading tools...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function loadCollaborationPage() {
            if (!hasPermission(PERMISSIONS.VIEW_COMMENTS)) {
                return `
                    <div class="card">
                        <div class="text-center py-8">
                            <i class="mdi mdi-lock text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold mb-2">Access Restricted</h3>
                            <p class="text-gray-600">You don't have permission to view collaborations.</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <!-- Pending Comments for Moderation -->
                    ${hasPermission(PERMISSIONS.MODERATE_COMMENTS) ? `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-comment-processing"></i>
                                Comments for Moderation
                            </h3>
                            <span class="badge badge-danger" id="pendingCommentsCount">0</span>
                        </div>
                        <div id="pendingCommentsList" class="space-y-3">
                            <div class="text-center py-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="text-gray-500 mt-2">Loading pending comments...</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Recent Discussions -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-comment-multiple"></i>
                                Recent Discussions
                            </h3>
                        </div>
                        <div id="recentDiscussions" class="space-y-4">
                            <div class="text-center py-8">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="text-gray-500 mt-2">Loading discussions...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function loadUsersPage() {
            if (!hasPermission(PERMISSIONS.VIEW_USERS)) {
                return `
                    <div class="card">
                        <div class="text-center py-8">
                            <i class="mdi mdi-lock text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold mb-2">Access Restricted</h3>
                            <p class="text-gray-600">You don't have permission to view users.</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-account-multiple"></i>
                                User Management
                            </h3>
                            ${hasPermission(PERMISSIONS.MANAGE_USERS) ? `
                            <div class="flex gap-2">
                                <button onclick="showNewUserModal()" class="btn btn-primary">
                                    <i class="mdi mdi-account-plus"></i>
                                    Add User
                                </button>
                                <button onclick="showAccessRequestsModal()" class="btn btn-outline">
                                    <i class="mdi mdi-account-clock"></i>
                                    Access Requests
                                    <span class="badge badge-danger ml-1" id="pendingRequestsCount">0</span>
                                </button>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex gap-2">
                                <input type="text" id="userSearch" class="form-control" placeholder="Search users...">
                                <select id="userStatusFilter" class="form-control" style="width: 150px;">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Department</th>
                                        <th>Status</th>
                                        <th>Last Login</th>
                                        ${hasPermission(PERMISSIONS.MANAGE_USERS) ? '<th>Actions</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="${hasPermission(PERMISSIONS.MANAGE_USERS) ? '6' : '5'}" class="text-center py-8">
                                            <div class="loading-spinner mx-auto"></div>
                                            <p class="text-gray-500 mt-2">Loading users...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function loadPermissionsPage() {
            if (!hasPermission(PERMISSIONS.EDIT_PERMISSIONS)) {
                return `
                    <div class="card">
                        <div class="text-center py-8">
                            <i class="mdi mdi-lock text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold mb-2">Access Restricted</h3>
                            <p class="text-gray-600">You don't have permission to manage permissions.</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <!-- Permission Presets -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-shield-star"></i>
                                Permission Presets
                            </h3>
                            <button onclick="showNewPresetModal()" class="btn btn-primary">
                                <i class="mdi mdi-plus"></i>
                                New Preset
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="permissionPresets">
                            ${Object.entries(PERMISSION_PRESETS).map(([key, preset]) => `
                                <div class="border border-gray-200 rounded-lg p-4 hover:border-primary-300 transition-colors">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-semibold">${preset.name}</h4>
                                        <span class="badge badge-primary">${preset.permissions.length} perms</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4">Quick apply this permission set</p>
                                    <div class="flex gap-2">
                                        <button onclick="applyPreset('${key}')" class="btn btn-sm btn-outline flex-1">
                                            Apply
                                        </button>
                                        <button onclick="editPreset('${key}')" class="btn btn-sm btn-icon">
                                            <i class="mdi mdi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Permission Matrix -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-matrix"></i>
                                Permission Matrix
                            </h3>
                            <div class="flex gap-2">
                                <button onclick="selectAllPermissions()" class="btn btn-sm btn-outline">
                                    Select All
                                </button>
                                <button onclick="clearAllPermissions()" class="btn btn-sm btn-outline">
                                    Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-4" id="permissionMatrix">
                            <div class="text-center py-8">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="text-gray-500 mt-2">Loading permission matrix...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function loadAuditPage() {
            if (!hasPermission(PERMISSIONS.VIEW_AUDIT_LOG)) {
                return `
                    <div class="card">
                        <div class="text-center py-8">
                            <i class="mdi mdi-lock text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold mb-2">Access Restricted</h3>
                            <p class="text-gray-600">You don't have permission to view audit logs.</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-history"></i>
                                Audit Log
                            </h3>
                            <button onclick="exportAuditLog()" class="btn btn-outline">
                                <i class="mdi mdi-download"></i>
                                Export
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <input type="date" id="auditDateFrom" class="form-control">
                                <input type="date" id="auditDateTo" class="form-control">
                                <select id="auditActionFilter" class="form-control">
                                    <option value="">All Actions</option>
                                    <option value="login">Logins</option>
                                    <option value="logout">Logouts</option>
                                    <option value="project_created">Project Created</option>
                                    <option value="project_updated">Project Updated</option>
                                    <option value="user_created">User Created</option>
                                    <option value="permission_changed">Permission Changed</option>
                                </select>
                                <button onclick="loadAuditLogs()" class="btn btn-primary">
                                    <i class="mdi mdi-filter"></i>
                                    Apply Filters
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table" id="auditTable">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>User</th>
                                        <th>Action</th>
                                        <th>Details</th>
                                        <th>IP Address</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="text-center py-8">
                                            <div class="loading-spinner mx-auto"></div>
                                            <p class="text-gray-500 mt-2">Loading audit log...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function loadSettingsPage() {
            if (!hasPermission(PERMISSIONS.MANAGE_SETTINGS)) {
                return `
                    <div class="card">
                        <div class="text-center py-8">
                            <i class="mdi mdi-lock text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-semibold mb-2">Access Restricted</h3>
                            <p class="text-gray-600">You don't have permission to manage settings.</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="space-y-6">
                    <!-- Platform Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-cog"></i>
                                Platform Settings
                            </h3>
                        </div>
                        
                        <form id="platformSettingsForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Platform Name</label>
                                    <input type="text" class="form-control" value="TRAci Platform" disabled>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Platform Version</label>
                                    <input type="text" class="form-control" value="3.0.0" disabled>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Default Project Visibility</label>
                                <select class="form-control">
                                    <option value="private">Private</option>
                                    <option value="internal">Internal</option>
                                    <option value="public">Public</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Session Timeout (minutes)</label>
                                <input type="number" class="form-control" value="480" min="15" max="1440">
                            </div>
                            
                            <div class="form-group">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="rounded" checked>
                                    <span>Require email verification for new users</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="rounded">
                                    <span>Enable two-factor authentication</span>
                                </label>
                            </div>
                            
                            <div class="flex justify-end">
                                <button type="submit" class="btn btn-primary">
                                    Save Settings
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Integration Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="mdi mdi-api"></i>
                                Integrations
                            </h3>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <h4 class="font-semibold">ThoraxLab Integration</h4>
                                        <p class="text-sm text-gray-600">Sync projects with external research platform</p>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox" ${hasPermission(PERMISSIONS.SYNC_EXTERNAL) ? 'checked' : ''}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                ${hasPermission(PERMISSIONS.SYNC_EXTERNAL) ? `
                                <div class="mt-3 space-y-2">
                                    <input type="text" class="form-control" placeholder="API Endpoint">
                                    <input type="password" class="form-control" placeholder="API Key">
                                    <button class="btn btn-sm btn-primary w-full">
                                        Test Connection
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <h4 class="font-semibold">Email Notifications</h4>
                                        <p class="text-sm text-gray-600">Send email alerts for important events</p>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Danger Zone -->
                    <div class="card border-red-200">
                        <div class="card-header border-red-200">
                            <h3 class="card-title text-red-700">
                                <i class="mdi mdi-alert"></i>
                                Danger Zone
                            </h3>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-red-700 mb-2">Clear All Data</h4>
                                <p class="text-sm text-gray-600 mb-3">This will permanently delete all projects, tools, and user data.</p>
                                <button onclick="showClearDataConfirmation()" class="btn btn-danger">
                                    <i class="mdi mdi-delete"></i>
                                    Clear All Data
                                </button>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-red-700 mb-2">Export Database</h4>
                                <p class="text-sm text-gray-600 mb-3">Download complete database backup.</p>
                                <button onclick="exportDatabase()" class="btn btn-outline border-red-300 text-red-700">
                                    <i class="mdi mdi-database-export"></i>
                                    Export Database
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ========== MODAL FUNCTIONS ==========
        function showNewProjectModal() {
            const modalContent = `
                <form id="newProjectForm">
                    <div class="space-y-4">
                        <div class="form-group">
                            <label class="form-label">Project Name *</label>
                            <input type="text" id="projectName" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea id="projectDescription" class="form-control" rows="3"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select id="projectStatus" class="form-control">
                                    <option value="planning">Planning</option>
                                    <option value="development" selected>Development</option>
                                    <option value="testing">Testing</option>
                                    <option value="production">Production</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Progress (%)</label>
                                <input type="range" id="projectProgress" class="w-full" min="0" max="100" value="0">
                                <div class="flex justify-between text-sm text-gray-500">
                                    <span>0%</span>
                                    <span id="progressValue">0%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select id="projectCategory" class="form-control">
                                    <option value="clinical_research">Clinical Research</option>
                                    <option value="quality_improvement">Quality Improvement</option>
                                    <option value="technology">Technology</option>
                                    <option value="education">Education</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select id="projectPriority" class="form-control">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Visibility</label>
                            <select id="projectVisibility" class="form-control">
                                <option value="private">🔒 Private (Team only)</option>
                                <option value="internal">🏢 Internal (Organization)</option>
                                <option value="public">🌍 Public (All users)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="needsFeedback">
                                <span>Mark for clinical review</span>
                            </label>
                        </div>
                        
                        <div id="projectFormAlert" class="alert hidden"></div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="hideModals()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="mdi mdi-content-save"></i>
                                Create Project
                            </button>
                        </div>
                    </div>
                </form>
            `;
            
            showModal('newProjectModal', modalContent);
            
            // Add progress bar update
            const progressInput = document.getElementById('projectProgress');
            const progressValue = document.getElementById('progressValue');
            progressInput.addEventListener('input', (e) => {
                progressValue.textContent = e.target.value + '%';
            });
        }
        
        function showNewToolModal() {
            const modalContent = `
                <form id="newToolForm">
                    <div class="space-y-4">
                        <div class="form-group">
                            <label class="form-label">Tool Name *</label>
                            <input type="text" id="toolName" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea id="toolDescription" class="form-control" rows="2"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">URL *</label>
                            <input type="url" id="toolUrl" class="form-control" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select id="toolCategory" class="form-control">
                                    <option value="clinical">Clinical Tools</option>
                                    <option value="research">Research Tools</option>
                                    <option value="administrative">Administrative</option>
                                    <option value="educational">Educational</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select id="toolStatus" class="form-control">
                                    <option value="operational">Operational</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="beta">Beta</option>
                                    <option value="deprecated">Deprecated</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Icon</label>
                            <div class="flex gap-2">
                                <input type="text" id="toolIcon" class="form-control" value="mdi mdi-toolbox">
                                <button type="button" class="btn btn-outline" onclick="showIconPicker()">
                                    <i class="mdi mdi-palette"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="toolFormAlert" class="alert hidden"></div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="hideModals()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="mdi mdi-content-save"></i>
                                Add Tool
                            </button>
                        </div>
                    </div>
                </form>
            `;
            
            showModal('newProjectModal', modalContent);
        }
        
        function showNewUserModal() {
            const modalContent = `
                <form id="newUserForm">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-group">
                                <label class="form-label">First Name *</label>
                                <input type="text" id="userFirstName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name *</label>
                                <input type="text" id="userLastName" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Email Address *</label>
                            <input type="email" id="userEmail" class="form-control" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="form-group">
                                <label class="form-label">Department</label>
                                <select id="userDepartment" class="form-control">
                                    <option value="pulmonology">Pulmonology</option>
                                    <option value="cardiology">Cardiology</option>
                                    <option value="neurology">Neurology</option>
                                    <option value="research">Research</option>
                                    <option value="administration">Administration</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Position</label>
                                <input type="text" id="userPosition" class="form-control">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <div class="flex gap-2">
                                <input type="text" id="userPassword" class="form-control" value="${generateRandomPassword()}">
                                <button type="button" class="btn btn-outline" onclick="generateNewPassword()">
                                    <i class="mdi mdi-refresh"></i>
                                </button>
                            </div>
                            <div class="form-text">Save this password securely. It will not be shown again.</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="userActive" checked>
                                <span>Account active immediately</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Permission Preset</label>
                            <select id="userPermissionPreset" class="form-control" onchange="applyPresetToForm(this.value)">
                                <option value="">Custom Permissions</option>
                                ${Object.entries(PERMISSION_PRESETS).map(([key, preset]) => `
                                    <option value="${key}">${preset.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div id="userFormAlert" class="alert hidden"></div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="hideModals()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="mdi mdi-account-plus"></i>
                                Create User
                            </button>
                        </div>
                    </div>
                </form>
            `;
            
            showModal('newProjectModal', modalContent);
        }
        
        function showPermissionEditorModal(userId = null) {
            const modalContent = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold">Permission Editor</h4>
                            <p class="text-sm text-gray-600">${userId ? 'Edit user permissions' : 'Create permission preset'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-outline" onclick="selectAllPermissions()">
                                Select All
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="clearAllPermissions()">
                                Clear All
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="permissionEditorGrid">
                        ${Object.entries(PERMISSIONS).map(([key, perm]) => `
                            <div class="border border-gray-200 rounded-lg p-3 hover:border-primary-300 transition-colors">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" name="permission" value="${perm}" class="rounded">
                                    <div>
                                        <div class="font-medium">${perm.replace(/_/g, ' ')}</div>
                                        <div class="text-xs text-gray-500">${getPermissionDescription(perm)}</div>
                                    </div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="hideModals()">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" onclick="savePermissions(${userId ? `'${userId}'` : 'null'})">
                            <i class="mdi mdi-content-save"></i>
                            Save Permissions
                        </button>
                    </div>
                </div>
            `;
            
            showModal('permissionEditorModal', modalContent);
        }
        
        function showAccessRequestsModal() {
            const modalContent = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold">Access Requests</h4>
                            <p class="text-sm text-gray-600">Review and approve registration requests</p>
                        </div>
                        <span class="badge badge-danger" id="modalRequestsCount">0</span>
                    </div>
                    
                    <div id="accessRequestsList" class="space-y-3">
                        <div class="text-center py-8">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="text-gray-500 mt-2">Loading access requests...</p>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('newProjectModal', modalContent);
            loadAccessRequests();
        }
        
        // ========== HELPER FUNCTIONS ==========
        function getPermissionDescription(permission) {
            const descriptions = {
                [PERMISSIONS.VIEW_PROJECTS]: 'Can view research projects',
                [PERMISSIONS.CREATE_PROJECTS]: 'Can create new projects',
                [PERMISSIONS.EDIT_OWN_PROJECTS]: 'Can edit projects they created',
                [PERMISSIONS.EDIT_ALL_PROJECTS]: 'Can edit all projects',
                [PERMISSIONS.DELETE_PROJECTS]: 'Can delete projects',
                [PERMISSIONS.EXPORT_PROJECTS]: 'Can export project data',
                [PERMISSIONS.VIEW_TOOLS]: 'Can view clinical tools',
                [PERMISSIONS.MANAGE_TOOLS]: 'Can add/edit/delete tools',
                [PERMISSIONS.VIEW_COMMENTS]: 'Can view comments',
                [PERMISSIONS.CREATE_COMMENTS]: 'Can add comments',
                [PERMISSIONS.MODERATE_COMMENTS]: 'Can approve/reject comments',
                [PERMISSIONS.VIEW_USERS]: 'Can view user list',
                [PERMISSIONS.MANAGE_USERS]: 'Can add/edit/delete users',
                [PERMISSIONS.EDIT_PERMISSIONS]: 'Can edit user permissions',
                [PERMISSIONS.VIEW_AUDIT_LOG]: 'Can view audit logs',
                [PERMISSIONS.MANAGE_SETTINGS]: 'Can change platform settings',
                [PERMISSIONS.SYNC_EXTERNAL]: 'Can sync with external systems',
                [PERMISSIONS.BYPASS_APPROVAL]: 'Can bypass approval workflows',
                [PERMISSIONS.SUPER_ADMIN]: 'Full system access (all permissions)'
            };
            return descriptions[permission] || 'No description available';
        }
        
        function updateUserMenu() {
            const userMenu = document.getElementById('userMenu');
            if (!userMenu || !currentUser) return;
            
            const initials = currentUser.full_name
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);
            
            userMenu.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="text-right hidden md:block">
                        <div class="font-semibold text-sm">${currentUser.full_name}</div>
                        <div class="text-xs text-gray-500">${currentUser.department || 'No department'}</div>
                    </div>
                    <div class="avatar cursor-pointer" id="userMenuToggle">
                        ${initials}
                    </div>
                </div>
                
                <div id="userDropdown" class="hidden absolute top-full right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-2 z-50">
                    <div class="px-4 py-3 border-b border-gray-100">
                        <div class="font-semibold">${currentUser.full_name}</div>
                        <div class="text-sm text-gray-500">${currentUser.email}</div>
                    </div>
                    <a href="#" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50">
                        <i class="mdi mdi-account text-gray-500"></i>
                        <span>Profile</span>
                    </a>
                    <a href="#" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50">
                        <i class="mdi mdi-cog text-gray-500"></i>
                        <span>Account Settings</span>
                    </a>
                    <div class="border-t border-gray-100 my-1"></div>
                    <button onclick="logout()" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50 w-full text-left text-red-600">
                        <i class="mdi mdi-logout"></i>
                        <span>Sign Out</span>
                    </button>
                </div>
            `;
            
            // Add dropdown toggle
            document.getElementById('userMenuToggle').addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = document.getElementById('userDropdown');
                dropdown.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown && !dropdown.contains(e.target) && !document.getElementById('userMenuToggle').contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }
        
        function generateNewPassword() {
            const passwordField = document.getElementById('userPassword');
            if (passwordField) {
                passwordField.value = generateRandomPassword();
            }
        }
        
        function applyPresetToForm(presetKey) {
            const preset = PERMISSION_PRESETS[presetKey];
            if (!preset) return;
            
            // In a real implementation, this would update the permission checkboxes
            console.log('Applying preset:', preset.name);
        }
        
        async function loadAccessRequests() {
            try {
                const { data: requests, error } = await supabase
                    .from('access_requests')
                    .select('*')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const list = document.getElementById('accessRequestsList');
                const countBadge = document.getElementById('modalRequestsCount');
                
                if (!requests || requests.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-8">
                            <i class="mdi mdi-check-circle text-4xl text-green-500 mb-4"></i>
                            <p class="text-gray-600">No pending access requests</p>
                        </div>
                    `;
                    countBadge.textContent = '0';
                    return;
                }
                
                countBadge.textContent = requests.length;
                
                list.innerHTML = requests.map(request => `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h5 class="font-semibold">${request.full_name}</h5>
                                <p class="text-sm text-gray-600">${request.email}</p>
                                <p class="text-xs text-gray-500">${request.institution} • ${request.department}</p>
                            </div>
                            <span class="badge badge-warning">Pending</span>
                        </div>
                        
                        <p class="text-sm mb-3">${request.purpose || 'No purpose provided'}</p>
                        
                        <div class="text-xs text-gray-500 mb-3">
                            Requested: ${new Date(request.created_at).toLocaleDateString()}
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="approveRequest('${request.id}')" class="btn btn-sm btn-success flex-1">
                                <i class="mdi mdi-check"></i>
                                Approve
                            </button>
                            <button onclick="rejectRequest('${request.id}')" class="btn btn-sm btn-danger flex-1">
                                <i class="mdi mdi-close"></i>
                                Reject
                            </button>
                            <button onclick="viewRequestDetails('${request.id}')" class="btn btn-sm btn-outline">
                                <i class="mdi mdi-eye"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading access requests:', error);
                document.getElementById('accessRequestsList').innerHTML = `
                    <div class="alert alert-error">
                        <i class="mdi mdi-alert-circle"></i>
                        Failed to load access requests
                    </div>
                `;
            }
        }
        
        async function approveRequest(requestId) {
            if (!confirm('Approve this access request?')) return;
            
            showLoading('Approving request...');
            
            try {
                // Get request details
                const { data: request } = await supabase
                    .from('access_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (!request) throw new Error('Request not found');
                
                // Create user account
                const password = generateRandomPassword();
                const hashedPassword = await hashPassword(password);
                
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .insert([{
                        email: request.email,
                        full_name: request.full_name,
                        institution: request.institution,
                        department: request.department,
                        position: request.position,
                        encrypted_password: hashedPassword,
                        status: 'active',
                        permissions: PERMISSION_PRESETS.RESEARCHER.permissions.reduce((acc, perm) => {
                            acc[perm] = true;
                            return acc;
                        }, {})
                    }])
                    .select()
                    .single();
                
                if (userError) throw userError;
                
                // Update request status
                await supabase
                    .from('access_requests')
                    .update({
                        status: 'approved',
                        reviewed_by: currentUser.id,
                        reviewed_at: new Date().toISOString()
                    })
                    .eq('id', requestId);
                
                // Log audit
                await logAudit('access_request_approved', {
                    request_id: requestId,
                    user_email: request.email,
                    assigned_permissions: PERMISSION_PRESETS.RESEARCHER.permissions.length
                });
                
                hideLoading();
                showToast('Access request approved', 'success');
                
                // Show credentials
                alert(`Access granted!\n\nEmail: ${request.email}\nPassword: ${password}\n\nShare these credentials securely with the user.`);
                
                // Reload requests
                loadAccessRequests();
                
            } catch (error) {
                hideLoading();
                console.error('Error approving request:', error);
                showToast('Failed to approve request', 'error');
            }
        }
        
        async function rejectRequest(requestId) {
            const reason = prompt('Enter reason for rejection:', '');
            if (reason === null) return;
            
            showLoading('Rejecting request...');
            
            try {
                await supabase
                    .from('access_requests')
                    .update({
                        status: 'rejected',
                        reviewed_by: currentUser.id,
                        reviewed_at: new Date().toISOString(),
                        notes: reason
                    })
                    .eq('id', requestId);
                
                await logAudit('access_request_rejected', {
                    request_id: requestId,
                    reason: reason
                });
                
                hideLoading();
                showToast('Access request rejected', 'success');
                loadAccessRequests();
                
            } catch (error) {
                hideLoading();
                console.error('Error rejecting request:', error);
                showToast('Failed to reject request', 'error');
            }
        }
        
        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize
            initializeDatabase().then(() => {
                // Check if user is already logged in
                if (authToken) {
                    try {
                        const tokenData = JSON.parse(atob(authToken));
                        // In a real app, you would validate the token with the server
                        // For now, we'll show the auth screens
                        showAuthScreens();
                    } catch {
                        showAuthScreens();
                    }
                } else {
                    showAuthScreens();
                }
            });
            
            // Auth screen buttons
            document.getElementById('loginScreenBtn')?.addEventListener('click', () => {
                showScreen('loginScreen');
            });
            
            document.getElementById('registerScreenBtn')?.addEventListener('click', () => {
                showScreen('registerScreen');
            });
            
            document.getElementById('guestContinueBtn')?.addEventListener('click', () => {
                showGuestDashboard();
            });
            
            document.getElementById('backToLandingBtn')?.addEventListener('click', () => {
                showScreen('landingScreen');
            });
            
            document.getElementById('backToLandingFromRegister')?.addEventListener('click', () => {
                showScreen('landingScreen');
            });
            
            document.getElementById('forgotPasswordBtn')?.addEventListener('click', () => {
                showScreen('forgotPasswordScreen');
            });
            
            document.getElementById('backToLoginBtn')?.addEventListener('click', () => {
                showScreen('loginScreen');
            });
            
            document.getElementById('guestLoginBtn')?.addEventListener('click', () => {
                showScreen('loginScreen');
            });
            
            // Login form
            document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                const alertDiv = document.getElementById('loginAlert');
                
                // Clear previous errors
                alertDiv.classList.add('hidden');
                alertDiv.textContent = '';
                
                try {
                    await login(email, password);
                    showMainDashboard();
                    showToast('Welcome back!', 'success');
                } catch (error) {
                    alertDiv.textContent = error.message;
                    alertDiv.classList.remove('hidden');
                }
            });
            
            // Register form
            document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = {
                    firstName: document.getElementById('registerFirstName').value.trim(),
                    lastName: document.getElementById('registerLastName').value.trim(),
                    email: document.getElementById('registerEmail').value.trim(),
                    institution: document.getElementById('registerInstitution').value.trim(),
                    department: document.getElementById('registerDepartment').value,
                    position: document.getElementById('registerPosition').value.trim(),
                    purpose: document.getElementById('registerPurpose').value.trim()
                };
                
                const alertDiv = document.getElementById('registerAlert');
                
                // Clear previous messages
                alertDiv.classList.add('hidden');
                alertDiv.textContent = '';
                
                try {
                    const request = await registerAccessRequest(formData);
                    
                    alertDiv.textContent = 'Access request submitted! An administrator will review your request.';
                    alertDiv.classList.remove('hidden');
                    alertDiv.classList.add('alert-success');
                    
                    // Reset form
                    e.target.reset();
                    
                    // Show success message
                    setTimeout(() => {
                        showScreen('landingScreen');
                        showToast('Access request submitted successfully', 'success');
                    }, 2000);
                    
                } catch (error) {
                    alertDiv.textContent = error.message;
                    alertDiv.classList.remove('hidden');
                    alertDiv.classList.add('alert-error');
                }
            });
            
            // Forgot password form
            document.getElementById('forgotPasswordForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('resetEmail').value.trim();
                const alertDiv = document.getElementById('resetAlert');
                
                alertDiv.classList.add('hidden');
                alertDiv.textContent = '';
                
                try {
                    await requestPasswordReset(email);
                    showScreen('loginScreen');
                } catch (error) {
                    alertDiv.textContent = error.message;
                    alertDiv.classList.remove('hidden');
                    alertDiv.classList.add('alert-error');
                }
            });
            
            // Navigation
            document.addEventListener('click', (e) => {
                const navItem = e.target.closest('.nav-item');
                if (navItem && navItem.dataset.page) {
                    e.preventDefault();
                    loadPage(navItem.dataset.page);
                }
            });
            
            // Quick action buttons
            document.getElementById('quickAddProject')?.addEventListener('click', () => {
                if (hasPermission(PERMISSIONS.CREATE_PROJECTS)) {
                    showNewProjectModal();
                } else {
                    showToast('You need permission to create projects', 'warning');
                }
            });
            
            document.getElementById('quickAddTool')?.addEventListener('click', () => {
                if (hasPermission(PERMISSIONS.MANAGE_TOOLS)) {
                    showNewToolModal();
                } else {
                    showToast('You need permission to add tools', 'warning');
                }
            });
            
            // Modal close buttons
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-close') || 
                    e.target.classList.contains('modal-overlay')) {
                    hideModals();
                }
            });
            
            // Escape key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideModals();
                }
            });
            
            // Status panel update
            function updateStatusTime() {
                const timeElement = document.getElementById('lastUpdatedTime');
                if (timeElement) {
                    const now = new Date();
                    timeElement.textContent = now.toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
            }
            
            // Update time every minute
            setInterval(updateStatusTime, 60000);
            updateStatusTime();
            
            // Show status panel if user is logged in
            if (currentUser) {
                document.getElementById('statusPanel')?.classList.remove('hidden');
            }
        });
        
        // ========== GLOBAL FUNCTIONS ==========
        window.refreshDashboard = async function() {
            await loadDashboardStats();
            showToast('Dashboard refreshed', 'success');
        };
        
        window.showNewProjectModal = showNewProjectModal;
        window.showNewToolModal = showNewToolModal;
        window.showNewUserModal = showNewUserModal;
        window.showPermissionEditorModal = showPermissionEditorModal;
        window.showAccessRequestsModal = showAccessRequestsModal;
        window.logout = logout;
        
        // ========== PERMISSION MANAGEMENT ==========
        window.applyPreset = function(presetKey) {
            const preset = PERMISSION_PRESETS[presetKey];
            if (!preset) return;
            
            // Update permission checkboxes
            document.querySelectorAll('input[name="permission"]').forEach(checkbox => {
                checkbox.checked = preset.permissions.includes(checkbox.value);
            });
            
            showToast(`Applied ${preset.name} preset`, 'success');
        };
        
        window.selectAllPermissions = function() {
            document.querySelectorAll('input[name="permission"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        };
        
        window.clearAllPermissions = function() {
            document.querySelectorAll('input[name="permission"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        };
        
        window.savePermissions = async function(userId) {
            const checkboxes = document.querySelectorAll('input[name="permission"]:checked');
            const permissions = Array.from(checkboxes).map(cb => cb.value);
            
            const permissionsObj = {};
            permissions.forEach(perm => {
                permissionsObj[perm] = true;
            });
            
            showLoading('Saving permissions...');
            
            try {
                if (userId) {
                    // Update user permissions
                    await supabase
                        .from('users')
                        .update({ permissions: permissionsObj })
                        .eq('id', userId);
                    
                    await logAudit('permissions_updated', {
                        user_id: userId,
                        permissions: permissions
                    });
                    
                    showToast('User permissions updated', 'success');
                } else {
                    // Save as new preset
                    const presetName = prompt('Enter preset name:', '');
                    if (presetName) {
                        // In a real app, you would save to database
                        showToast('Preset saved locally', 'success');
                    }
                }
                
                hideLoading();
                hideModals();
                
            } catch (error) {
                hideLoading();
                console.error('Error saving permissions:', error);
                showToast('Failed to save permissions', 'error');
            }
        };
        
        // ========== DEBUG FUNCTIONS ==========
        window.debugDatabase = async function() {
            console.log('=== DATABASE DEBUG ===');
            
            try {
                const [
                    usersCount,
                    projectsCount,
                    toolsCount,
                    requestsCount
                ] = await Promise.all([
                    supabase.from('users').select('count', { count: 'exact', head: true }),
                    supabase.from('projects').select('count', { count: 'exact', head: true }),
                    supabase.from('tools').select('count', { count: 'exact', head: true }),
                    supabase.from('access_requests').select('count', { count: 'exact', head: true })
                ]);
                
                console.log('Users:', usersCount.count);
                console.log('Projects:', projectsCount.count);
                console.log('Tools:', toolsCount.count);
                console.log('Pending requests:', requestsCount.count);
                
                showToast('Debug info logged to console', 'info');
                
            } catch (error) {
                console.error('Debug error:', error);
                showToast('Debug failed: ' + error.message, 'error');
            }
        };
        
        window.createTestData = async function() {
            if (!confirm('Create test data? This will add sample projects and tools.')) return;
            
            showLoading('Creating test data...');
            
            try {
                // Create sample projects
                const sampleProjects = [
                    {
                        name: 'AI-Assisted Lung Nodule Detection',
                        description: 'Using deep learning algorithms to improve early detection of pulmonary nodules in CT scans.',
                        status: 'development',
                        progress: 65,
                        category: 'clinical_research',
                        priority: 'high',
                        visibility: 'internal',
                        needs_feedback: true
                    },
                    {
                        name: 'Tele-Rehabilitation for COPD Patients',
                        description: 'Remote monitoring and exercise program for chronic obstructive pulmonary disease patients.',
                        status: 'testing',
                        progress: 80,
                        category: 'quality_improvement',
                        priority: 'medium',
                        visibility: 'public'
                    },
                    {
                        name: 'Smart Inhaler Compliance Tracking',
                        description: 'IoT-enabled inhaler with medication adherence monitoring and alerts.',
                        status: 'production',
                        progress: 100,
                        category: 'technology',
                        priority: 'high',
                        visibility: 'internal'
                    }
                ];
                
                for (const project of sampleProjects) {
                    await supabase.from('projects').insert([{
                        ...project,
                        owner_id: currentUser?.id,
                        edit_code: Math.floor(10000 + Math.random() * 90000).toString()
                    }]);
                }
                
                // Create sample tools
                const sampleTools = [
                    {
                        name: 'Lung Function Calculator',
                        description: 'Calculate predicted values and percentages for spirometry results.',
                        url: 'https://example.com/lung-calculator',
                        category: 'clinical',
                        status: 'operational',
                        icon: 'mdi mdi-calculator'
                    },
                    {
                        name: 'Radiology Image Viewer',
                        description: 'DICOM viewer with measurement tools for chest imaging.',
                        url: 'https://example.com/dicom-viewer',
                        category: 'clinical',
                        status: 'operational',
                        icon: 'mdi mdi-radiology-box'
                    },
                    {
                        name: 'Research Protocol Template',
                        description: 'Standardized templates for clinical study protocols.',
                        url: 'https://example.com/protocol-templates',
                        category: 'research',
                        status: 'operational',
                        icon: 'mdi mdi-file-document'
                    }
                ];
                
                for (const tool of sampleTools) {
                    await supabase.from('tools').insert([tool]);
                }
                
                hideLoading();
                showToast('Test data created successfully', 'success');
                
                // Refresh dashboard
                if (currentUser) {
                    await loadDashboardStats();
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error creating test data:', error);
                showToast('Failed to create test data', 'error');
            }
        };
    </script>
</body>
</html>
