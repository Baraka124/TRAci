<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>TRAci | Clinical Innovation Platform</title>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* ===== COMPLETE DESIGN SYSTEM ===== */
        :root {
            /* Professional Hospital Colors */
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --primary-light: #5eead4;
            --secondary: #3b82f6;
            --secondary-dark: #2563eb;
            --accent: #8b5cf6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --info: #0891b2;
            
            /* Clinical Priority Colors */
            --priority-critical: #dc2626;
            --priority-high: #f97316;
            --priority-medium: #eab308;
            --priority-low: #84cc16;
            
            /* Neutrals */
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Status Colors */
            --status-online: #10b981;
            --status-offline: #9ca3af;
            --status-busy: #ef4444;
            --status-away: #f59e0b;
            
            /* Backgrounds */
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: var(--white);
            --bg-overlay: rgba(0, 0, 0, 0.5);
            
            /* Borders */
            --border-light: var(--gray-200);
            --border: var(--gray-300);
            --border-dark: var(--gray-400);
            
            /* Typography */
            --font-sans: 'Inter', sans-serif;
            --font-heading: 'Space Grotesk', sans-serif;
            
            /* Spacing (4px base) */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-7: 32px;
            --space-8: 48px;
            --space-9: 64px;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 350ms ease;
            
            /* Z-index */
            --z-dropdown: 10;
            --z-sticky: 20;
            --z-modal: 30;
            --z-toast: 40;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ===== COMPONENTS ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-4);
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: var(--space-2); }
        .gap-4 { gap: var(--space-4); }
        .gap-6 { gap: var(--space-6); }
        .w-full { width: 100%; }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }
        .mb-8 { margin-bottom: var(--space-8); }
        .p-4 { padding: var(--space-4); }
        .p-6 { padding: var(--space-6); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }
        .border { border: 1px solid var(--border); }
        .shadow-card { box-shadow: var(--shadow-md); }

        /* Header */
        .header {
            padding: var(--space-6) 0;
            border-bottom: 2px solid var(--primary-light);
            margin-bottom: var(--space-6);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .logo {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 24px;
        }

        .platform-name {
            font-family: var(--font-heading);
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-btn {
            padding: var(--space-3) var(--space-6);
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .auth-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Project Stickers/Badges */
        .project-sticker {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 2px solid;
            margin-right: var(--space-2);
        }

        .sticker-imported {
            background: linear-gradient(135deg, #dbeafe, var(--secondary));
            color: var(--white);
            border-color: var(--secondary);
        }

        .sticker-thoraxlab {
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            color: var(--white);
            border-color: var(--accent);
        }

        .sticker-archived {
            background: linear-gradient(135deg, var(--gray-300), var(--gray-500));
            color: var(--white);
            border-color: var(--gray-500);
        }

        .sticker-pending {
            background: linear-gradient(135deg, var(--warning), #b45309);
            color: var(--white);
            border-color: var(--warning);
        }

        .sticker-proposal {
            background: linear-gradient(135deg, #fef3c7, var(--warning));
            color: var(--gray-900);
            border-color: var(--warning);
        }

        /* Priority Badges */
        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--white);
            border: 2px solid;
        }

        .priority-critical {
            background: var(--priority-critical);
            border-color: var(--priority-critical);
            animation: pulse 2s infinite;
        }

        .priority-high {
            background: var(--priority-high);
            border-color: var(--priority-high);
        }

        .priority-medium {
            background: var(--priority-medium);
            border-color: var(--priority-medium);
            color: var(--gray-900);
        }

        .priority-low {
            background: var(--priority-low);
            border-color: var(--priority-low);
            color: var(--gray-900);
        }

        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.online {
            background: var(--status-online);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--status-offline);
        }

        .status-dot.busy {
            background: var(--status-busy);
            animation: pulse 1s infinite;
        }

        .status-dot.away {
            background: var(--status-away);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .card-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border-light);
            background: var(--gray-50);
        }

        .card-body {
            padding: var(--space-4);
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius-full);
            transition: width 1s ease;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            padding: var(--space-4);
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-body {
            padding: var(--space-6);
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-control {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-sans);
            font-size: 14px;
            transition: all var(--transition-base);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            padding: var(--space-4);
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border-left: 4px solid var(--primary);
            z-index: var(--z-toast);
            animation: slideInRight 0.3s ease;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--gray-300);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Quick Actions */
        .quick-actions {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            display: flex;
            gap: var(--space-2);
            z-index: var(--z-sticky);
        }

        .quick-action-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-base);
        }

        .quick-action-btn:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        /* Table */
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .table th {
            background: var(--gray-50);
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--border);
        }

        .table td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--border);
        }

        .table tr:hover {
            background: var(--gray-50);
        }

        /* Channel Buttons - Professional Small */
        .channel-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            text-decoration: none;
            font-size: 16px;
            transition: all var(--transition-base);
        }

        .channel-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .channel-btn.whatsapp { background: #25D366; }
        .channel-btn.email { background: var(--primary); }
        .channel-btn.github { background: var(--gray-800); }
        .channel-btn.discord { background: #5865F2; }

        /* Animations */
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: white !important;
                color: black !important;
            }
            .card {
                border: 1px solid #000 !important;
                box-shadow: none !important;
                break-inside: avoid;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 var(--space-3);
            }
            .platform-name {
                font-size: 24px;
            }
            .modal-content {
                margin: var(--space-2);
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Quick Actions -->
    <div class="quick-actions no-print">
        <button class="quick-action-btn" id="quickAdd" title="Add Project (Ctrl+N)">
            <i class="mdi mdi-plus"></i>
        </button>
        <button class="quick-action-btn" id="quickSync" title="Sync Projects (Ctrl+S)">
            <i class="mdi mdi-sync"></i>
        </button>
        <button class="quick-action-btn" id="quickExport" title="Export Data (Ctrl+E)">
            <i class="mdi mdi-download"></i>
        </button>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div class="logo-section">
                    <div class="logo">
                        <i class="mdi mdi-heart-pulse"></i>
                    </div>
                    <div>
                        <h1 class="platform-name">TRAci</h1>
                        <p class="text-sm font-semibold text-gray-600">Clinical Innovation Platform</p>
                    </div>
                </div>
                <div id="authSection">
                    <div id="guestView">
                        <button id="loginBtn" class="auth-btn">
                            <i class="mdi mdi-login"></i>
                            <span>Login</span>
                        </button>
                    </div>
                    <div id="userView" class="hidden">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2">
                                <div class="status-dot online"></div>
                                <span id="currentUsername" class="font-semibold"></span>
                                <span id="currentUserRole" class="text-xs bg-primary text-white px-2 py-1 rounded"></span>
                            </div>
                            <button id="logoutBtn" class="auth-btn">
                                <i class="mdi mdi-logout"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Guest Welcome -->
        <div id="guestWelcome" class="hidden">
            <div class="card mb-6">
                <div class="card-body">
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="text-4xl text-primary">
                            <i class="mdi mdi-hand-wave"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-2">Welcome to TRAci</h3>
                            <p class="text-gray-600 mb-4">Explore clinical tools, research projects, and innovation portfolio.</p>
                            <button id="guestSignup" class="auth-btn">Request Access</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Controls -->
        <div id="adminControls" class="hidden mb-6">
            <div class="flex flex-wrap gap-2">
                <button id="addProjectBtn" class="auth-btn">
                    <i class="mdi mdi-plus-circle"></i> Add Project
                </button>
                <button id="addToolBtn" class="auth-btn">
                    <i class="mdi mdi-toolbox"></i> Add Tool
                </button>
                <button id="manageUsersBtn" class="auth-btn">
                    <i class="mdi mdi-account-multiple"></i> Manage Users
                </button>
                <button id="syncProjectsBtn" class="auth-btn">
                    <i class="mdi mdi-sync"></i> Sync Projects
                </button>
                <button id="moderateCommentsBtn" class="auth-btn">
                    <i class="mdi mdi-comment-processing"></i> Moderate
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div id="statsContainer" class="hidden mb-8">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="card">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="text-2xl text-primary">
                                <i class="mdi mdi-toolbox"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Tools</p>
                                <p class="text-2xl font-bold" id="toolsCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="text-2xl text-primary">
                                <i class="mdi mdi-flask"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Projects</p>
                                <p class="text-2xl font-bold" id="projectsCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="text-2xl text-primary">
                                <i class="mdi mdi-comment"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Comments</p>
                                <p class="text-2xl font-bold" id="commentsCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="text-2xl text-primary">
                                <i class="mdi mdi-account-group"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Users</p>
                                <p class="text-2xl font-bold" id="usersCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="text-2xl text-primary">
                                <i class="mdi mdi-sync"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Synced</p>
                                <p class="text-2xl font-bold" id="syncCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div id="filterControls" class="hidden mb-6">
            <div class="flex flex-wrap gap-2">
                <button class="auth-btn active" data-filter="all">All</button>
                <button class="auth-btn" data-filter="needs_review">Needs Review</button>
                <button class="auth-btn" data-filter="imported">Imported</button>
                <button class="auth-btn" data-filter="private">Private</button>
                <button class="auth-btn" data-filter="critical">Critical</button>
                <input type="text" id="searchProjects" class="form-control" placeholder="Search projects..." style="max-width: 200px;">
            </div>
        </div>

        <!-- Main Content -->
        <div id="contentGrid" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Tools Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="font-bold">
                            <i class="mdi mdi-toolbox mr-2"></i>
                            Clinical Tools
                        </h2>
                    </div>
                    <div class="card-body">
                        <div id="toolsGrid"></div>
                    </div>
                </div>

                <!-- Projects Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="font-bold">
                            <i class="mdi mdi-flask mr-2"></i>
                            Research Projects
                            <span class="text-sm font-normal text-gray-500" id="projectsCountBadge">(0)</span>
                        </h2>
                    </div>
                    <div class="card-body">
                        <div id="projectsList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Required -->
        <div id="loginRequiredSection" class="hidden">
            <div class="text-center py-12">
                <div class="text-6xl text-primary mb-4">
                    <i class="mdi mdi-shield-lock"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Secure Access Required</h2>
                <p class="text-gray-600 mb-6">Login to access the clinical innovation platform.</p>
                <button id="loginRequiredBtn" class="auth-btn">Login</button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-6 border-t text-center text-gray-500 text-sm">
            <p>TRAci Clinical Innovation Platform v4.0 • HIPAA Compliant</p>
        </footer>
    </div>

    <!-- ===== ALL MODALS ===== -->
    
    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold">
                    <i class="mdi mdi-shield-lock mr-2"></i>
                    Secure Login
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs mb-6">
                    <button class="tab active" data-tab="login">Login</button>
                    <button class="tab" data-tab="signup">Sign Up</button>
                    <button class="tab" data-tab="reset">Reset Password</button>
                </div>
                
                <!-- Login Form -->
                <div id="loginForm" class="tab-content">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-control" placeholder="doctor@hospital.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="••••••••">
                    </div>
                    <button id="submitLogin" class="auth-btn w-full">Sign In</button>
                </div>

                <!-- Signup Form -->
                <div id="signupForm" class="tab-content hidden">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="signupName" class="form-control" placeholder="Dr. John Smith">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="signupEmail" class="form-control" placeholder="doctor@hospital.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select id="signupDepartment" class="form-control">
                            <option value="pulmonology">Pulmonology</option>
                            <option value="cardiology">Cardiology</option>
                            <option value="neurology">Neurology</option>
                            <option value="research">Research</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="signupPassword" class="form-control" placeholder="Minimum 8 characters">
                    </div>
                    <button id="submitSignup" class="auth-btn w-full bg-success">Create Account</button>
                </div>

                <!-- Reset Password Form -->
                <div id="resetForm" class="tab-content hidden">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="resetEmail" class="form-control" placeholder="doctor@hospital.com">
                    </div>
                    <button id="submitReset" class="auth-btn w-full bg-warning">Send Reset Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold">
                    <i class="mdi mdi-plus-circle mr-2"></i>
                    Add New Project
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Project Name *</label>
                    <input type="text" id="projectName" class="form-control" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="projectDescription" class="form-control" rows="4" placeholder="Project description..."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="projectStatus" class="form-control">
                            <option value="planning">Planning</option>
                            <option value="development">Development</option>
                            <option value="testing">Testing</option>
                            <option value="production">Production</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Progress %</label>
                        <input type="number" id="projectProgress" class="form-control" min="0" max="100" value="0">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select id="projectPriority" class="form-control">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="projectCategory" class="form-control">
                            <option value="clinical_research">Clinical Research</option>
                            <option value="quality_improvement">Quality Improvement</option>
                            <option value="technology">Technology</option>
                            <option value="education">Education</option>
                            <option value="administrative">Administrative</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Visibility</label>
                    <select id="projectVisibility" class="form-control">
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                        <option value="admin_only">Admin Only</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="projectNeedsFeedback">
                        <span>Mark for Clinical Review</span>
                    </label>
                </div>
                <button id="saveProjectBtn" class="auth-btn w-full">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal (with Doctor Code Verification) -->
    <div id="editProjectModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold">
                    <i class="mdi mdi-pencil mr-2"></i>
                    Edit Project
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProjectId">
                
                <!-- Doctor Edit Code Section -->
                <div id="editCodeSection" class="hidden mb-6 p-4 bg-warning/10 border border-warning rounded-lg">
                    <h4 class="font-bold mb-2">
                        <i class="mdi mdi-key mr-2"></i>
                        Doctor Edit Verification
                    </h4>
                    <div class="form-group">
                        <label class="form-label">5-Digit Edit Code *</label>
                        <input type="password" id="editCodeVerification" class="form-control" 
                               placeholder="00000" maxlength="5" pattern="[0-9]{5}" 
                               style="font-family: monospace; font-size: 24px; text-align: center; letter-spacing: 10px;">
                    </div>
                </div>

                <!-- Edit Form -->
                <div class="form-group">
                    <label class="form-label">Project Name *</label>
                    <input type="text" id="editProjectName" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="editProjectDescription" class="form-control" rows="4"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="editProjectStatus" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Progress %</label>
                        <input type="number" id="editProjectProgress" class="form-control" min="0" max="100">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select id="editProjectPriority" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="editProjectCategory" class="form-control"></select>
                    </div>
                </div>

                <!-- Admin Only Controls -->
                <div id="adminEditControls" class="hidden">
                    <div class="form-group">
                        <label class="form-label">Edit Code</label>
                        <div class="flex gap-2">
                            <input type="text" id="editProjectEditCode" class="form-control" readonly 
                                   style="font-family: monospace; letter-spacing: 2px;">
                            <button type="button" id="generateEditCodeBtn" class="auth-btn">Generate</button>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 mt-6">
                    <button id="updateProjectBtn" class="auth-btn flex-1">Update</button>
                    <button id="deleteProjectBtn" class="auth-btn flex-1 bg-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Modal (Full System) -->
    <div id="commentsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold">
                    <i class="mdi mdi-comment-multiple mr-2"></i>
                    <span id="commentsModalTitle">Project Comments</span>
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Add Comment Form -->
                <div id="commentFormSection">
                    <div class="form-group">
                        <label class="form-label">Add Comment</label>
                        <textarea id="commentText" class="form-control" rows="3" 
                                  placeholder="Share your feedback..." maxlength="1000"></textarea>
                        <div class="flex justify-between text-sm text-gray-500 mt-1">
                            <span id="commentHint"></span>
                            <span id="commentCharCount">0/1000</span>
                        </div>
                    </div>
                    <div id="guestCommentFields" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Your Name *</label>
                            <input type="text" id="guestName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Your Email *</label>
                            <input type="email" id="guestEmail" class="form-control">
                        </div>
                    </div>
                    <button id="submitCommentBtn" class="auth-btn w-full">Post Comment</button>
                </div>

                <!-- Comments List -->
                <div id="commentsList" class="mt-6 space-y-4 max-h-[400px] overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Moderate Comments Modal -->
    <div id="moderateCommentsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="font-bold">
                    <i class="mdi mdi-comment-processing mr-2"></i>
                    Moderate Comments
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <input type="text" id="moderationSearch" class="form-control" placeholder="Search comments...">
                </div>
                
                <!-- Bulk Actions -->
                <div id="bulkActionsPanel" class="hidden mb-4">
                    <div class="flex gap-2">
                        <button id="selectAllCommentsBtn" class="auth-btn">Select All</button>
                        <button id="bulkApproveBtn" class="auth-btn bg-success">Approve Selected</button>
                        <button id="bulkRejectBtn" class="auth-btn bg-danger">Reject Selected</button>
                    </div>
                </div>

                <!-- Pending Comments -->
                <div id="moderationList" class="space-y-4 max-h-[500px] overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Sync Projects Modal -->
    <div id="syncProjectsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold">
                    <i class="mdi mdi-sync mr-2"></i>
                    Sync with ThoraxLab
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Sync Direction</label>
                    <select id="syncDirection" class="form-control">
                        <option value="import">Import from ThoraxLab</option>
                        <option value="export">Export to ThoraxLab</option>
                    </select>
                </div>
                <div id="importOptions">
                    <div class="form-group">
                        <label class="form-label">Select ThoraxLab Project</label>
                        <select id="thoraxlabProjects" class="form-control"></select>
                    </div>
                </div>
                <div id="exportOptions" class="hidden">
                    <div class="form-group">
                        <label class="form-label">Select TRAci Project</label>
                        <select id="traciProjects" class="form-control"></select>
                    </div>
                </div>
                <button id="startSyncBtn" class="auth-btn w-full mt-4">Start Sync</button>
                <div id="syncResults" class="mt-4 hidden"></div>
            </div>
        </div>
    </div>

    <!-- PDF Export Modal -->
    <div id="pdfExportModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold">
                    <i class="mdi mdi-file-pdf mr-2"></i>
                    Export to PDF
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Project</label>
                    <select id="pdfProjectSelect" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label class="form-label mb-2">Include in PDF:</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="includeDetails" checked>
                            <span>Project Details</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="includeComments" checked>
                            <span>Comments</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="includeTimeline">
                            <span>Timeline</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="includeAttachments">
                            <span>Attachments</span>
                        </label>
                    </div>
                </div>
                <button id="generatePDFBtn" class="auth-btn w-full bg-danger">Generate PDF</button>
            </div>
        </div>
    </div>

    <!-- Manage Users Modal -->
    <div id="manageUsersModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="font-bold">
                    <i class="mdi mdi-account-multiple mr-2"></i>
                    User Management
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <button id="addUserBtn" class="auth-btn">
                        <i class="mdi mdi-account-plus"></i> Add User
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllUsers"></th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
                <div id="bulkUserActions" class="hidden mt-4">
                    <button id="bulkActivateBtn" class="auth-btn">Activate Selected</button>
                    <button id="bulkDeactivateBtn" class="auth-btn">Deactivate Selected</button>
                    <button id="bulkDeleteUsersBtn" class="auth-btn bg-danger">Delete Selected</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userFormModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold" id="userFormTitle">
                    <i class="mdi mdi-account-plus mr-2"></i>
                    Add New User
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" id="userFullName" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="userEmail" class="form-control">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select id="userRole" class="form-control">
                            <option value="admin">Administrator</option>
                            <option value="doctor">Doctor/Clinician</option>
                            <option value="researcher">Researcher</option>
                            <option value="guest">Guest</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select id="userDepartment" class="form-control">
                            <option value="pulmonology">Pulmonology</option>
                            <option value="cardiology">Cardiology</option>
                            <option value="neurology">Neurology</option>
                            <option value="research">Research</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <div class="flex gap-2">
                        <input type="text" id="userPassword" class="form-control" 
                               readonly style="font-family: monospace;">
                        <button type="button" id="generatePasswordBtn" class="auth-btn">Generate</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="userIsActive" checked>
                        <span>Active Account</span>
                    </label>
                </div>
                <button id="saveUserBtn" class="auth-btn w-full">Save User</button>
                
                <div id="newUserCredentials" class="hidden mt-4 p-4 bg-success/10 border border-success rounded-lg">
                    <h4 class="font-bold mb-2">User Credentials</h4>
                    <p><strong>Email:</strong> <span id="generatedEmail"></span></p>
                    <p><strong>Password:</strong> <span id="generatedPassword" style="font-family: monospace;"></span></p>
                    <p class="text-sm text-gray-600 mt-2">Save these credentials securely!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Data Modal -->
    <div id="exportDataModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold">
                    <i class="mdi mdi-download mr-2"></i>
                    Export Data
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Data Type</label>
                    <select id="exportDataType" class="form-control">
                        <option value="projects">Projects</option>
                        <option value="tools">Tools</option>
                        <option value="users">Users</option>
                        <option value="audit_logs">Audit Logs</option>
                        <option value="comments">Comments</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Format</label>
                    <select id="exportFormat" class="form-control">
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date Range</label>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="date" id="exportStartDate" class="form-control">
                        <input type="date" id="exportEndDate" class="form-control">
                    </div>
                </div>
                <button id="generateExportBtn" class="auth-btn w-full">Export Data</button>
            </div>
        </div>
    </div>

    <!-- Attachment Upload Modal -->
    <div id="attachmentModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-bold">
                    <i class="mdi mdi-paperclip mr-2"></i>
                    Upload Attachment
                </h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select File</label>
                    <input type="file" id="attachmentFile" class="form-control" multiple>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="attachmentDescription" class="form-control" placeholder="File description...">
                </div>
                <button id="uploadAttachmentBtn" class="auth-btn w-full">Upload</button>
                
                <div id="attachmentsList" class="mt-4 space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- ===== JAVASCRIPT - COMPLETE IMPLEMENTATION ===== -->
    <script>
        // ===== CONFIGURATION =====
        const SUPABASE_URL = 'https://bledpouekiytppuhxeqq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_zdlIM8UbOrRIFpmYLJOmWQ_4QqNi_5C';
        const THORAXLAB_API_URL = 'https://api.thoraxlab.com/v1'; // Mock API

        // ===== SUPABASE INIT =====
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== STATE MANAGEMENT =====
        let currentUser = null;
        let authToken = localStorage.getItem('traci_auth_token');
        let dashboardData = {
            projects: [],
            tools: [],
            users: [],
            filteredProjects: [],
            attachments: [],
            auditLogs: []
        };
        let currentProjectId = null;
        let commentCounts = {};
        let pendingComments = [];
        let selectedUsers = new Set();
        let selectedComments = new Set();
        let realTimeSubscription = null;

        // ===== TOAST SYSTEM =====
        function showToast(message, type = 'info', duration = 5000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="mdi mdi-${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : type === 'warning' ? 'alert' : 'information'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, duration);
        }

        // ===== PASSWORD & CODE GENERATION =====
        function generatePassword(length = 12) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return password;
        }

        function generateEditCode() {
            return Math.floor(10000 + Math.random() * 90000).toString();
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ===== AUTHENTICATION - COMPLETE =====
        async function loginUser(email, password) {
            try {
                const hashedPassword = await hashPassword(password);
                
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email.toLowerCase())
                    .eq('status', 'active')
                    .single();

                if (error || !data) throw new Error('Invalid credentials');
                if (data.encrypted_password !== hashedPassword) throw new Error('Invalid credentials');

                currentUser = {
                    id: data.id,
                    email: data.email,
                    username: data.username,
                    full_name: data.full_name,
                    role: data.role,
                    department: data.department,
                    is_active: true
                };

                authToken = btoa(JSON.stringify(currentUser));
                localStorage.setItem('traci_auth_token', authToken);
                
                await logAudit('login', { email });
                showToast('Login successful', 'success');
                
                return true;
            } catch (error) {
                showToast(error.message, 'error');
                return false;
            }
        }

        async function signUpUser(userData) {
            try {
                // Validate
                if (!userData.full_name || !userData.email || !userData.password) {
                    throw new Error('All fields are required');
                }
                if (userData.password.length < 8) {
                    throw new Error('Password must be at least 8 characters');
                }

                // Check existing
                const { data: existing } = await supabase
                    .from('users')
                    .select('id')
                    .eq('email', userData.email.toLowerCase())
                    .single();

                if (existing) throw new Error('Email already registered');

                // Create user
                const hashedPassword = await hashPassword(userData.password);
                const newUser = {
                    username: userData.email.split('@')[0].toLowerCase(),
                    full_name: userData.full_name,
                    email: userData.email.toLowerCase(),
                    role: userData.role || 'guest',
                    department: userData.department || 'general',
                    encrypted_password: hashedPassword,
                    status: 'pending',
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('users')
                    .insert([newUser])
                    .select()
                    .single();

                if (error) throw error;

                // Send welcome email (simulated)
                await sendEmailNotification(userData.email, 'Welcome to TRAci', 
                    `Your account has been created and is pending approval.`);

                await logAudit('user_signup', { email: userData.email });
                showToast('Account created successfully! Pending admin approval.', 'success');
                
                return { success: true, data };
            } catch (error) {
                showToast(error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        async function resetPassword(email) {
            try {
                const { data: user } = await supabase
                    .from('users')
                    .select('id, email')
                    .eq('email', email.toLowerCase())
                    .single();

                if (!user) throw new Error('No account found with this email');

                // Generate reset token
                const resetToken = Math.random().toString(36).substring(2, 15);
                const resetLink = `${window.location.origin}/reset-password.html?token=${resetToken}`;

                // Save token to database (simplified)
                await supabase
                    .from('password_resets')
                    .insert([{
                        email: email.toLowerCase(),
                        token: resetToken,
                        expires_at: new Date(Date.now() + 3600000).toISOString()
                    }]);

                // Send email (simulated)
                await sendEmailNotification(email, 'Password Reset Request',
                    `Click here to reset your password: ${resetLink}`);

                showToast('Password reset link sent to your email', 'success');
                return true;
            } catch (error) {
                showToast(error.message, 'error');
                return false;
            }
        }

        // ===== PROJECT MANAGEMENT - COMPLETE =====
        async function fetchProjects() {
            try {
                let query = supabase
                    .from('projects')
                    .select('*');

                if (currentUser.role === 'guest') {
                    query = query.eq('visibility', 'public');
                } else if (currentUser.role === 'doctor') {
                    query = query.in('visibility', ['public', 'private']);
                }

                const { data, error } = await query.order('created_at', { ascending: false });
                if (error) throw error;

                return data || [];
            } catch (error) {
                console.error('Error fetching projects:', error);
                return [];
            }
        }

        async function addProject(projectData) {
            try {
                const project = {
                    name: projectData.name,
                    description: projectData.description,
                    status: projectData.status,
                    progress: parseInt(projectData.progress),
                    category: projectData.category,
                    priority: projectData.priority,
                    needs_feedback: projectData.needs_feedback,
                    visibility: projectData.visibility,
                    owner: currentUser.full_name,
                    edit_code: generateEditCode(),
                    review_status: 'none',
                    created_at: new Date().toISOString(),
                    last_updated: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('projects')
                    .insert([project])
                    .select()
                    .single();

                if (error) throw error;

                await logAudit('project_created', { project_id: data.id, name: project.name });
                showToast('Project created successfully', 'success');

                return data;
            } catch (error) {
                showToast('Error creating project: ' + error.message, 'error');
                throw error;
            }
        }

        async function updateProject(projectId, projectData, editCode = null) {
            try {
                // Verify edit code for doctors
                if (currentUser.role === 'doctor' && editCode) {
                    const { data: project } = await supabase
                        .from('projects')
                        .select('edit_code')
                        .eq('id', projectId)
                        .single();

                    if (!project || project.edit_code !== editCode) {
                        throw new Error('Invalid edit code');
                    }
                }

                const updateData = {
                    name: projectData.name,
                    description: projectData.description,
                    status: projectData.status,
                    progress: parseInt(projectData.progress),
                    category: projectData.category,
                    priority: projectData.priority,
                    needs_feedback: projectData.needs_feedback,
                    last_updated: new Date().toISOString()
                };

                // Admin can update visibility and edit code
                if (currentUser.role === 'admin') {
                    updateData.visibility = projectData.visibility;
                    if (projectData.edit_code) {
                        updateData.edit_code = projectData.edit_code;
                    }
                }

                const { data, error } = await supabase
                    .from('projects')
                    .update(updateData)
                    .eq('id', projectId)
                    .select()
                    .single();

                if (error) throw error;

                await logAudit('project_updated', { project_id: projectId });
                showToast('Project updated successfully', 'success');

                return data;
            } catch (error) {
                showToast('Error updating project: ' + error.message, 'error');
                throw error;
            }
        }

        async function deleteProject(projectId) {
            try {
                const { error } = await supabase
                    .from('projects')
                    .delete()
                    .eq('id', projectId);

                if (error) throw error;

                await logAudit('project_deleted', { project_id: projectId });
                showToast('Project deleted successfully', 'success');

                return true;
            } catch (error) {
                showToast('Error deleting project: ' + error.message, 'error');
                return false;
            }
        }

        // ===== COMMENT SYSTEM - COMPLETE =====
        async function fetchComments(projectId) {
            try {
                const { data, error } = await supabase
                    .from('comments')
                    .select(`
                        *,
                        users (full_name, role)
                    `)
                    .eq('project_id', projectId)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error fetching comments:', error);
                return [];
            }
        }

        async function addComment(projectId, content, guestInfo = null) {
            try {
                const comment = {
                    project_id: projectId,
                    content: content,
                    user_id: currentUser ? currentUser.id : null,
                    user_name: currentUser ? currentUser.full_name : guestInfo?.name,
                    user_email: guestInfo?.email,
                    user_role: currentUser ? currentUser.role : 'guest',
                    status: currentUser && currentUser.role === 'admin' ? 'approved' : 'pending',
                    upvotes: 0,
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('comments')
                    .insert([comment])
                    .select()
                    .single();

                if (error) throw error;

                await logAudit('comment_added', { project_id: projectId, comment_id: data.id });
                
                // Notify admins about pending comment
                if (comment.status === 'pending') {
                    await notifyAdmins('New comment pending approval', 
                        `Project: ${projectId}\nComment by: ${comment.user_name}`);
                }

                showToast('Comment added successfully', 'success');
                return data;
            } catch (error) {
                showToast('Error adding comment: ' + error.message, 'error');
                throw error;
            }
        }

        async function moderateComment(commentId, action, bulk = false) {
            try {
                const status = action === 'approve' ? 'approved' : 'rejected';
                
                const { data, error } = await supabase
                    .from('comments')
                    .update({ 
                        status: status,
                        moderated_at: new Date().toISOString(),
                        moderated_by: currentUser.full_name
                    })
                    .eq('id', commentId)
                    .select()
                    .single();

                if (error) throw error;

                await logAudit('comment_moderated', { comment_id: commentId, action: action });

                if (!bulk) {
                    showToast(`Comment ${action}d successfully`, 'success');
                }

                return data;
            } catch (error) {
                showToast('Error moderating comment: ' + error.message, 'error');
                throw error;
            }
        }

        async function upvoteComment(commentId) {
            try {
                const { data: comment } = await supabase
                    .from('comments')
                    .select('upvotes')
                    .eq('id', commentId)
                    .single();

                const { data, error } = await supabase
                    .from('comments')
                    .update({ upvotes: (comment.upvotes || 0) + 1 })
                    .eq('id', commentId)
                    .select()
                    .single();

                if (error) throw error;

                await logAudit('comment_upvoted', { comment_id: commentId });
                return data;
            } catch (error) {
                showToast('Error upvoting comment', 'error');
                throw error;
            }
        }

        // ===== THORAXLAB INTEGRATION - COMPLETE =====
        async function fetchThoraxLabProjects() {
            try {
                // Mock API call - replace with actual ThoraxLab API
                const mockProjects = [
                    {
                        id: 'thorax-1',
                        name: 'AI Lung Nodule Detection',
                        description: 'Deep learning for early lung cancer detection',
                        status: 'development',
                        progress: 65,
                        category: 'clinical_research',
                        tags: ['AI', 'Radiology', 'ML']
                    },
                    {
                        id: 'thorax-2',
                        name: 'Tele-Rehabilitation COPD',
                        description: 'Remote monitoring for COPD patients',
                        status: 'testing',
                        progress: 80,
                        category: 'quality_improvement',
                        tags: ['Telemedicine', 'Rehabilitation']
                    }
                ];

                return mockProjects;
            } catch (error) {
                showToast('Error fetching ThoraxLab projects', 'error');
                return [];
            }
        }

        async function syncThoraxLabProject(thoraxlabProjectId, direction) {
            try {
                if (direction === 'import') {
                    // Fetch project from ThoraxLab
                    const thoraxlabProjects = await fetchThoraxLabProjects();
                    const project = thoraxlabProjects.find(p => p.id === thoraxlabProjectId);
                    
                    if (!project) throw new Error('Project not found in ThoraxLab');

                    // Import to TRAci
                    const importedProject = {
                        name: `[ThoraxLab] ${project.name}`,
                        description: `Imported from ThoraxLab\n\n${project.description}\n\nTags: ${project.tags?.join(', ') || 'None'}`,
                        status: project.status,
                        progress: project.progress,
                        category: project.category,
                        priority: 'medium',
                        visibility: 'imported',
                        edit_code: generateEditCode(),
                        source: 'thoraxlab',
                        source_id: project.id,
                        created_at: new Date().toISOString()
                    };

                    const { data, error } = await supabase
                        .from('projects')
                        .insert([importedProject])
                        .select()
                        .single();

                    if (error) throw error;

                    await logAudit('project_imported', { 
                        source: 'thoraxlab', 
                        source_id: project.id,
                        project_id: data.id 
                    });

                    showToast('Project imported successfully from ThoraxLab', 'success');
                    return data;

                } else if (direction === 'export') {
                    // Export to ThoraxLab
                    const { data: project } = await supabase
                        .from('projects')
                        .select('*')
                        .eq('id', thoraxlabProjectId)
                        .single();

                    if (!project) throw new Error('Project not found');

                    // Mock API call to ThoraxLab
                    console.log('Exporting to ThoraxLab:', project);
                    
                    await logAudit('project_exported', { 
                        destination: 'thoraxlab',
                        project_id: project.id 
                    });

                    showToast('Project exported to ThoraxLab successfully', 'success');
                    return { exported: true };
                }
            } catch (error) {
                showToast('Sync error: ' + error.message, 'error');
                throw error;
            }
        }

        // ===== PDF EXPORT - COMPLETE =====
        async function exportProjectToPDF(projectId, options = {}) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Fetch project data
                const { data: project } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('id', projectId)
                    .single();

                if (!project) throw new Error('Project not found');

                // PDF Header
                doc.setFontSize(20);
                doc.setTextColor(13, 148, 136);
                doc.text('TRAci Clinical Innovation Platform', 20, 20);
                
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text(`Project: ${project.name}`, 20, 40);

                // Project Details
                doc.setFontSize(12);
                let y = 60;
                
                doc.text(`Status: ${project.status}`, 20, y);
                y += 10;
                doc.text(`Progress: ${project.progress}%`, 20, y);
                y += 10;
                doc.text(`Priority: ${project.priority}`, 20, y);
                y += 10;
                doc.text(`Category: ${project.category}`, 20, y);
                y += 10;
                doc.text(`Visibility: ${project.visibility}`, 20, y);
                y += 20;

                // Description
                doc.setFontSize(14);
                doc.text('Description:', 20, y);
                y += 10;
                doc.setFontSize(10);
                const descriptionLines = doc.splitTextToSize(project.description || 'No description', 170);
                doc.text(descriptionLines, 20, y);
                y += (descriptionLines.length * 5) + 10;

                // Comments if requested
                if (options.includeComments) {
                    const comments = await fetchComments(projectId);
                    if (comments.length > 0) {
                        doc.addPage();
                        doc.setFontSize(16);
                        doc.text('Comments:', 20, 20);
                        
                        let commentY = 30;
                        comments.forEach((comment, index) => {
                            if (commentY > 270) {
                                doc.addPage();
                                commentY = 20;
                            }
                            
                            doc.setFontSize(10);
                            doc.text(`${comment.user_name} (${comment.user_role}):`, 20, commentY);
                            commentY += 5;
                            
                            const commentLines = doc.splitTextToSize(comment.content, 170);
                            doc.text(commentLines, 25, commentY);
                            commentY += (commentLines.length * 5) + 10;
                            
                            doc.text(`Upvotes: ${comment.upvotes} | Status: ${comment.status}`, 25, commentY);
                            commentY += 10;
                        });
                    }
                }

                // Timeline if requested
                if (options.includeTimeline) {
                    doc.addPage();
                    doc.setFontSize(16);
                    doc.text('Project Timeline:', 20, 20);
                    
                    const timeline = [
                        { date: '2024-01-15', event: 'Project Initiated', by: currentUser.full_name },
                        { date: '2024-02-01', event: 'Clinical Review', by: 'Dr. Smith' },
                        { date: '2024-03-15', event: 'Development Started', by: currentUser.full_name }
                    ];
                    
                    let timelineY = 30;
                    timeline.forEach(item => {
                        doc.setFontSize(10);
                        doc.text(`${item.date}: ${item.event} (${item.by})`, 20, timelineY);
                        timelineY += 10;
                    });
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`Page ${i} of ${pageCount}`, 20, 285);
                    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 160, 285);
                }

                // Save PDF
                doc.save(`TRAci-Project-${project.name.replace(/\s+/g, '-')}.pdf`);
                showToast('PDF exported successfully', 'success');

            } catch (error) {
                showToast('Error exporting PDF: ' + error.message, 'error');
            }
        }

        // ===== DATA EXPORT (CSV/Excel/JSON) =====
        async function exportData(dataType, format, options = {}) {
            try {
                let data = [];
                
                switch (dataType) {
                    case 'projects':
                        data = await fetchProjects();
                        break;
                    case 'tools':
                        data = await fetchTools();
                        break;
                    case 'users':
                        data = await fetchUsers();
                        break;
                    case 'comments':
                        data = await fetchAllComments();
                        break;
                    case 'audit_logs':
                        data = await fetchAuditLogs(options.startDate, options.endDate);
                        break;
                }

                if (format === 'csv') {
                    exportToCSV(data, `${dataType}_${new Date().toISOString().split('T')[0]}.csv`);
                } else if (format === 'excel') {
                    exportToExcel(data, `${dataType}_${new Date().toISOString().split('T')[0]}.xlsx`);
                } else if (format === 'json') {
                    exportToJSON(data, `${dataType}_${new Date().toISOString().split('T')[0]}.json`);
                }

                showToast(`Exported ${data.length} ${dataType} in ${format.toUpperCase()} format`, 'success');
            } catch (error) {
                showToast('Error exporting data: ' + error.message, 'error');
            }
        }

        function exportToCSV(data, filename) {
            if (!data.length) return;
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => 
                    JSON.stringify(row[header] || '')).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function exportToExcel(data, filename) {
            if (!data.length) return;
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, filename);
        }

        function exportToJSON(data, filename) {
            const jsonContent = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // ===== ATTACHMENT SYSTEM =====
        async function uploadAttachment(projectId, file, description) {
            try {
                const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
                
                // Upload to Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('attachments')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                // Save attachment record
                const attachment = {
                    project_id: projectId,
                    file_name: file.name,
                    storage_path: uploadData.path,
                    file_size: file.size,
                    file_type: file.type,
                    description: description,
                    uploaded_by: currentUser.id,
                    created_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('attachments')
                    .insert([attachment])
                    .select()
                    .single();

                if (error) throw error;

                await logAudit('attachment_uploaded', { 
                    project_id: projectId, 
                    file_name: file.name,
                    attachment_id: data.id 
                });

                showToast('File uploaded successfully', 'success');
                return data;
            } catch (error) {
                showToast('Error uploading file: ' + error.message, 'error');
                throw error;
            }
        }

        async function fetchAttachments(projectId) {
            try {
                const { data, error } = await supabase
                    .from('attachments')
                    .select('*')
                    .eq('project_id', projectId)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error fetching attachments:', error);
                return [];
            }
        }

        // ===== AUDIT LOGGING - COMPLETE =====
        async function logAudit(action, details = {}, resourceId = null) {
            try {
                const auditLog = {
                    user_id: currentUser?.id || null,
                    user_name: currentUser?.full_name || 'System',
                    user_role: currentUser?.role || 'system',
                    action: action,
                    details: JSON.stringify(details),
                    resource_id: resourceId,
                    ip_address: await getClientIP(),
                    user_agent: navigator.userAgent,
                    created_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('audit_logs')
                    .insert([auditLog]);

                if (error) console.error('Error saving audit log:', error);
            } catch (error) {
                console.error('Error in audit logging:', error);
            }
        }

        async function fetchAuditLogs(startDate = null, endDate = null) {
            try {
                let query = supabase
                    .from('audit_logs')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (startDate) {
                    query = query.gte('created_at', startDate);
                }
                if (endDate) {
                    query = query.lte('created_at', endDate);
                }

                const { data, error } = await query;
                if (error) throw error;

                return data || [];
            } catch (error) {
                console.error('Error fetching audit logs:', error);
                return [];
            }
        }

        // ===== EMAIL NOTIFICATIONS =====
        async function sendEmailNotification(to, subject, body) {
            try {
                // In production, integrate with email service (SendGrid, AWS SES, etc.)
                // For now, log to console
                console.log(`Email Notification:
To: ${to}
Subject: ${subject}
Body: ${body}
                `);

                // Simulate email delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                return true;
            } catch (error) {
                console.error('Error sending email:', error);
                return false;
            }
        }

        async function notifyAdmins(subject, message) {
            try {
                const { data: admins } = await supabase
                    .from('users')
                    .select('email')
                    .eq('role', 'admin')
                    .eq('status', 'active');

                for (const admin of admins) {
                    await sendEmailNotification(admin.email, subject, message);
                }
            } catch (error) {
                console.error('Error notifying admins:', error);
            }
        }

        // ===== REAL-TIME UPDATES =====
        function setupRealTimeUpdates() {
            if (realTimeSubscription) {
                realTimeSubscription.unsubscribe();
            }

            realTimeSubscription = supabase
                .channel('public:projects')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'projects' }, 
                    (payload) => {
                        console.log('Real-time update:', payload);
                        if (payload.eventType === 'INSERT') {
                            showToast('New project added', 'info');
                        }
                        refreshDashboard();
                    }
                )
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'comments' },
                    (payload) => {
                        if (payload.new.status === 'pending' && currentUser.role === 'admin') {
                            showToast('New comment pending approval', 'info');
                        }
                    }
                )
                .subscribe();
        }

        // ===== UI RENDERING =====
        async function refreshDashboard() {
            try {
                const [projects, tools, users, comments] = await Promise.all([
                    fetchProjects(),
                    fetchTools(),
                    fetchUsers(),
                    fetchAllComments()
                ]);

                dashboardData.projects = projects;
                dashboardData.tools = tools;
                dashboardData.users = users;
                dashboardData.filteredProjects = projects;

                // Update stats
                document.getElementById('projectsCount').textContent = projects.length;
                document.getElementById('toolsCount').textContent = tools.length;
                document.getElementById('usersCount').textContent = users.filter(u => u.status === 'active').length;
                document.getElementById('commentsCount').textContent = comments.length;
                document.getElementById('syncCount').textContent = projects.filter(p => p.source === 'thoraxlab').length;

                renderProjects();
                renderTools();
                updateTimestamp();
            } catch (error) {
                showToast('Error refreshing dashboard', 'error');
            }
        }

        function renderProjects() {
            const container = document.getElementById('projectsList');
            if (!container) return;

            const projects = dashboardData.filteredProjects;
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="mdi mdi-flask-outline text-4xl mb-2"></i>
                        <p>No projects found</p>
                    </div>
                `;
                return;
            }

            let html = '';
            projects.forEach(project => {
                const commentCount = dashboardData.comments?.filter(c => c.project_id === project.id).length || 0;
                
                html += `
                    <div class="card mb-4 project-card" data-project-id="${project.id}">
                        <div class="card-body">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-lg">${project.name}</h3>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        ${project.source === 'thoraxlab' ? 
                                            '<span class="project-sticker sticker-thoraxlab"><i class="mdi mdi-import"></i> ThoraxLab</span>' : ''}
                                        ${project.status === 'archived' ? 
                                            '<span class="project-sticker sticker-archived"><i class="mdi mdi-archive"></i> Archived</span>' : ''}
                                        ${project.needs_feedback ? 
                                            '<span class="project-sticker sticker-pending"><i class="mdi mdi-alert"></i> Needs Review</span>' : ''}
                                        <span class="priority-badge priority-${project.priority}">${project.priority}</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="badge ${project.visibility === 'private' ? 'bg-gray-100 text-gray-800' : 'bg-blue-100 text-blue-800'}">
                                        ${project.visibility}
                                    </span>
                                    <div class="text-sm text-gray-500 mt-1">${project.progress}% complete</div>
                                </div>
                            </div>
                            
                            <p class="text-gray-600 mb-4 line-clamp-2">${project.description || 'No description'}</p>
                            
                            <div class="progress-bar mb-4">
                                <div class="progress-fill" style="width: ${project.progress}%"></div>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-outline view-comments" data-project-id="${project.id}">
                                        <i class="mdi mdi-comment"></i> ${commentCount}
                                    </button>
                                    ${currentUser?.role === 'admin' || currentUser?.role === 'doctor' ? 
                                        `<button class="btn btn-sm btn-outline edit-project" data-project-id="${project.id}">
                                            <i class="mdi mdi-pencil"></i> Edit
                                        </button>` : ''}
                                    <button class="btn btn-sm btn-outline export-pdf" data-project-id="${project.id}">
                                        <i class="mdi mdi-file-pdf"></i> PDF
                                    </button>
                                </div>
                                
                                <div class="flex gap-1">
                                    <a href="#" class="channel-btn whatsapp" title="Share on WhatsApp">
                                        <i class="mdi mdi-whatsapp"></i>
                                    </a>
                                    <a href="#" class="channel-btn email" title="Email">
                                        <i class="mdi mdi-email"></i>
                                    </a>
                                    <button class="channel-btn github" title="GitHub">
                                        <i class="mdi mdi-github"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            attachProjectEventListeners();
        }

        function renderTools() {
            const container = document.getElementById('toolsGrid');
            if (!container) return;

            const tools = dashboardData.tools;
            
            if (tools.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="mdi mdi-toolbox-outline text-4xl mb-2"></i>
                        <p>No tools available</p>
                    </div>
                `;
                return;
            }

            let html = '';
            tools.forEach(tool => {
                html += `
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold">${tool.name}</h3>
                                    <div class="text-sm text-gray-500">${tool.category}</div>
                                </div>
                                <span class="badge ${tool.status === 'operational' ? 'bg-green-100 text-green-800' : 
                                                  tool.status === 'maintenance' ? 'bg-yellow-100 text-yellow-800' : 
                                                  'bg-red-100 text-red-800'}">
                                    ${tool.status}
                                </span>
                            </div>
                            <p class="text-gray-600 mb-4">${tool.description || 'No description'}</p>
                            <div class="flex justify-between items-center">
                                <a href="${tool.url}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="mdi mdi-open-in-new"></i> Access Tool
                                </a>
                                ${currentUser?.role === 'admin' ? 
                                    `<button class="btn btn-sm btn-outline edit-tool" data-tool-id="${tool.id}">
                                        <i class="mdi mdi-pencil"></i> Edit
                                    </button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ===== EVENT HANDLERS =====
        function attachProjectEventListeners() {
            // View comments
            document.querySelectorAll('.view-comments').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const projectId = e.target.closest('.project-card').dataset.projectId;
                    await showCommentsModal(projectId);
                });
            });

            // Edit project
            document.querySelectorAll('.edit-project').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const projectId = e.target.closest('.project-card').dataset.projectId;
                    await showEditProjectModal(projectId);
                });
            });

            // Export PDF
            document.querySelectorAll('.export-pdf').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const projectId = e.target.closest('.project-card').dataset.projectId;
                    await showPDFExportModal(projectId);
                });
            });
        }

        // ===== HELPER FUNCTIONS =====
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return '127.0.0.1';
            }
        }

        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdatedTime').textContent = timeString;
        }

        // ===== INITIALIZATION =====
        async function initializeApp() {
            // Load stored user
            if (authToken) {
                try {
                    currentUser = JSON.parse(atob(authToken));
                } catch (error) {
                    localStorage.removeItem('traci_auth_token');
                }
            }

            updateAuthUI();
            setupRealTimeUpdates();
            setupKeyboardShortcuts();
        }

        function updateAuthUI() {
            if (currentUser) {
                document.getElementById('guestView').classList.add('hidden');
                document.getElementById('userView').classList.remove('hidden');
                document.getElementById('currentUsername').textContent = currentUser.full_name;
                document.getElementById('currentUserRole').textContent = currentUser.role;
                
                document.getElementById('loginRequiredSection').classList.add('hidden');
                document.getElementById('statsContainer').classList.remove('hidden');
                document.getElementById('contentGrid').classList.remove('hidden');
                document.getElementById('filterControls').classList.remove('hidden');
                
                if (currentUser.role === 'admin') {
                    document.getElementById('adminControls').classList.remove('hidden');
                    document.getElementById('guestWelcome').classList.add('hidden');
                } else if (currentUser.role === 'guest') {
                    document.getElementById('adminControls').classList.add('hidden');
                    document.getElementById('guestWelcome').classList.remove('hidden');
                }
                
                refreshDashboard();
            } else {
                document.getElementById('guestView').classList.remove('hidden');
                document.getElementById('userView').classList.add('hidden');
                document.getElementById('guestWelcome').classList.remove('hidden');
                document.getElementById('loginRequiredSection').classList.remove('hidden');
                document.getElementById('statsContainer').classList.add('hidden');
                document.getElementById('adminControls').classList.add('hidden');
                document.getElementById('contentGrid').classList.add('hidden');
                document.getElementById('filterControls').classList.add('hidden');
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+N: New Project
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    if (currentUser?.role === 'admin') {
                        showModal('addProjectModal');
                    }
                }
                // Ctrl+S: Sync
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (currentUser?.role === 'admin') {
                        showModal('syncProjectsModal');
                    }
                }
                // Ctrl+E: Export
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    showModal('exportDataModal');
                }
                // Ctrl+F: Search
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchProjects').focus();
                }
                // Esc: Close modals
                if (e.key === 'Escape') {
                    hideAllModals();
                }
            });
        }

        function showModal(modalId) {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function hideAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
            document.body.style.overflow = 'auto';
        }

        // ===== MODAL SPECIFIC FUNCTIONS =====
        async function showCommentsModal(projectId) {
            currentProjectId = projectId;
            const comments = await fetchComments(projectId);
            
            // Render comments
            const container = document.getElementById('commentsList');
            if (comments.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No comments yet</p>';
            } else {
                let html = '';
                comments.forEach(comment => {
                    html += `
                        <div class="comment-card ${comment.status === 'pending' ? 'bg-yellow-50' : ''}">
                            <div class="comment-header">
                                <strong>${comment.user_name}</strong>
                                <span class="text-sm text-gray-500">${new Date(comment.created_at).toLocaleDateString()}</span>
                            </div>
                            <p class="comment-content">${comment.content}</p>
                            <div class="comment-footer">
                                <button class="btn btn-sm upvote-comment" data-comment-id="${comment.id}">
                                    <i class="mdi mdi-thumb-up"></i> ${comment.upvotes}
                                </button>
                                ${currentUser?.role === 'admin' && comment.status === 'pending' ? `
                                    <button class="btn btn-sm btn-success approve-comment" data-comment-id="${comment.id}">Approve</button>
                                    <button class="btn btn-sm btn-danger reject-comment" data-comment-id="${comment.id}">Reject</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
            
            document.getElementById('commentsModalTitle').textContent = `Comments`;
            showModal('commentsModal');
        }

        async function showEditProjectModal(projectId) {
            const { data: project } = await supabase
                .from('projects')
                .select('*')
                .eq('id', projectId)
                .single();

            if (!project) return;

            // Fill form
            document.getElementById('editProjectId').value = project.id;
            document.getElementById('editProjectName').value = project.name;
            document.getElementById('editProjectDescription').value = project.description;
            document.getElementById('editProjectStatus').value = project.status;
            document.getElementById('editProjectProgress').value = project.progress;
            document.getElementById('editProjectPriority').value = project.priority;
            document.getElementById('editProjectCategory').value = project.category;
            document.getElementById('editProjectEditCode').value = project.edit_code;

            // Show edit code section for doctors
            if (currentUser.role === 'doctor') {
                document.getElementById('editCodeSection').classList.remove('hidden');
            }

            // Show admin controls for admins
            if (currentUser.role === 'admin') {
                document.getElementById('adminEditControls').classList.remove('hidden');
            }

            showModal('editProjectModal');
        }

        async function showPDFExportModal(projectId) {
            const { data: projects } = await supabase
                .from('projects')
                .select('id, name')
                .order('name');

            const select = document.getElementById('pdfProjectSelect');
            select.innerHTML = '';
            projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                if (p.id === projectId) option.selected = true;
                select.appendChild(option);
            });

            showModal('pdfExportModal');
        }

        // ===== EVENT LISTENERS SETUP =====
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();

            // Login button
            document.getElementById('loginBtn').addEventListener('click', () => showModal('loginModal'));
            document.getElementById('loginRequiredBtn').addEventListener('click', () => showModal('loginModal'));

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                currentUser = null;
                authToken = null;
                localStorage.removeItem('traci_auth_token');
                updateAuthUI();
                showToast('Logged out successfully', 'info');
            });

            // Quick actions
            document.getElementById('quickAdd').addEventListener('click', () => {
                if (currentUser?.role === 'admin') {
                    showModal('addProjectModal');
                } else {
                    showToast('Admin access required', 'warning');
                }
            });

            document.getElementById('quickSync').addEventListener('click', () => {
                if (currentUser?.role === 'admin') {
                    showModal('syncProjectsModal');
                } else {
                    showToast('Admin access required', 'warning');
                }
            });

            document.getElementById('quickExport').addEventListener('click', () => {
                showModal('exportDataModal');
            });

            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', hideAllModals);
            });

            // Login form submission
            document.getElementById('submitLogin').addEventListener('click', async () => {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showToast('Please enter email and password', 'warning');
                    return;
                }

                const success = await loginUser(email, password);
                if (success) {
                    hideAllModals();
                    updateAuthUI();
                }
            });

            // Add project form
            document.getElementById('saveProjectBtn').addEventListener('click', async () => {
                const projectData = {
                    name: document.getElementById('projectName').value,
                    description: document.getElementById('projectDescription').value,
                    status: document.getElementById('projectStatus').value,
                    progress: document.getElementById('projectProgress').value,
                    priority: document.getElementById('projectPriority').value,
                    category: document.getElementById('projectCategory').value,
                    needs_feedback: document.getElementById('projectNeedsFeedback').checked,
                    visibility: document.getElementById('projectVisibility').value
                };

                try {
                    await addProject(projectData);
                    hideAllModals();
                    refreshDashboard();
                } catch (error) {
                    // Error handled in addProject
                }
            });

            // Update project form
            document.getElementById('updateProjectBtn').addEventListener('click', async () => {
                const projectId = document.getElementById('editProjectId').value;
                const editCode = currentUser.role === 'doctor' ? 
                    document.getElementById('editCodeVerification').value : null;
                
                const projectData = {
                    name: document.getElementById('editProjectName').value,
                    description: document.getElementById('editProjectDescription').value,
                    status: document.getElementById('editProjectStatus').value,
                    progress: document.getElementById('editProjectProgress').value,
                    priority: document.getElementById('editProjectPriority').value,
                    category: document.getElementById('editProjectCategory').value,
                    visibility: document.getElementById('editProjectVisibility')?.value
                };

                if (currentUser.role === 'admin') {
                    projectData.edit_code = document.getElementById('editProjectEditCode').value;
                }

                try {
                    await updateProject(projectId, projectData, editCode);
                    hideAllModals();
                    refreshDashboard();
                } catch (error) {
                    // Error handled in updateProject
                }
            });

            // Generate edit code
            document.getElementById('generateEditCodeBtn').addEventListener('click', () => {
                document.getElementById('editProjectEditCode').value = generateEditCode();
            });

            // Filter projects
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    
                    // Update active state
                    document.querySelectorAll('[data-filter]').forEach(b => {
                        b.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // Apply filter
                    if (filter === 'all') {
                        dashboardData.filteredProjects = dashboardData.projects;
                    } else if (filter === 'critical') {
                        dashboardData.filteredProjects = dashboardData.projects.filter(p => p.priority === 'critical');
                    } else if (filter === 'needs_review') {
                        dashboardData.filteredProjects = dashboardData.projects.filter(p => p.needs_feedback);
                    } else if (filter === 'imported') {
                        dashboardData.filteredProjects = dashboardData.projects.filter(p => p.source === 'thoraxlab');
                    } else if (filter === 'private') {
                        dashboardData.filteredProjects = dashboardData.projects.filter(p => p.visibility === 'private');
                    }
                    
                    renderProjects();
                });
            });

            // Search projects
            document.getElementById('searchProjects').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                dashboardData.filteredProjects = dashboardData.projects.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.description?.toLowerCase().includes(searchTerm) ||
                    p.category.toLowerCase().includes(searchTerm)
                );
                renderProjects();
            });

            // Auto-refresh every 5 minutes
            setInterval(() => {
                if (currentUser) {
                    refreshDashboard();
                }
            }, 5 * 60 * 1000);
        });

        // ===== EXPORT GLOBALLY NEEDED FUNCTIONS =====
        window.showCommentsModal = showCommentsModal;
        window.showEditProjectModal = showEditProjectModal;
        window.exportProjectToPDF = exportProjectToPDF;
        window.exportData = exportData;

    </script>
</body>
</html>
