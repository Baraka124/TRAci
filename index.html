<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>TRAci | Pneumology Innovation Dashboard</title>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* ===== COMPLETE DESIGN SYSTEM ===== */
        :root {
            /* Professional Hospital Color Palette */
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --primary-light: #5eead4;
            --secondary: #3b82f6;
            --secondary-dark: #2563eb;
            --accent: #8b5cf6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --info: #0891b2;
            
            /* Neutrals */
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Backgrounds */
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: var(--white);
            --bg-overlay: rgba(0, 0, 0, 0.5);
            
            /* Borders */
            --border: var(--gray-300);
            
            /* Typography */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-heading: 'Space Grotesk', var(--font-sans);
            
            /* Spacing (4px base) */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-6: 24px;
            --space-8: 32px;
            --space-12: 48px;
            --space-16: 64px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--gray-800);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: var(--space-2); }
        .gap-4 { gap: var(--space-4); }
        .gap-6 { gap: var(--space-6); }
        .w-full { width: 100%; }
        .mb-4 { margin-bottom: var(--space-4); }
        .mb-6 { margin-bottom: var(--space-6); }
        .mb-8 { margin-bottom: var(--space-8); }
        .mt-4 { margin-top: var(--space-4); }
        .mt-6 { margin-top: var(--space-6); }
        .p-4 { padding: var(--space-4); }
        .p-6 { padding: var(--space-6); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }
        .border { border: 1px solid var(--border); }
        .shadow { box-shadow: var(--shadow-md); }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-4);
        }

        /* ===== COMPONENTS ===== */
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-sans);
            font-weight: 600;
            font-size: 0.875rem;
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            padding: var(--space-2) var(--space-4);
            transition: all var(--transition);
            cursor: pointer;
            gap: var(--space-2);
            min-height: 36px;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--white);
            border-color: var(--secondary);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
            border-color: var(--success);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
            border-color: var(--warning);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
            border-color: var(--danger);
        }

        .btn-outline {
            background: transparent;
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        .btn-outline:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        /* Small Channel Buttons */
        .channel-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1rem;
            transition: all var(--transition);
            text-decoration: none;
            flex-shrink: 0;
        }

        .channel-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .channel-btn.whatsapp { background: #25D366; }
        .channel-btn.email { background: var(--primary); }
        .channel-btn.github { background: var(--gray-800); }
        .channel-btn.discord { background: #5865F2; }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: var(--radius-full);
            border: 2px solid transparent;
            white-space: nowrap;
        }

        .badge-primary {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .badge-success {
            background: var(--success);
            color: var(--white);
            border-color: var(--success);
        }

        .badge-warning {
            background: var(--warning);
            color: var(--white);
            border-color: var(--warning);
        }

        .badge-danger {
            background: var(--danger);
            color: var(--white);
            border-color: var(--danger);
        }

        .badge-outline {
            background: transparent;
            color: var(--gray-700);
            border-color: var(--gray-300);
        }

        /* Progress Bar */
        .progress {
            height: 8px;
            background: var(--gray-200);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 1s ease;
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            font-family: var(--font-sans);
            font-size: 0.875rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            transition: all var(--transition);
        }

        .form-control:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            border-color: var(--primary);
        }

        /* Alerts */
        .alert {
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
            border-left: 4px solid transparent;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left-color: var(--success);
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left-color: var(--danger);
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left-color: var(--info);
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-300) 37%, var(--gray-200) 63%);
            background-size: 400% 100%;
            animation: skeleton-loading 1.4s ease infinite;
            border-radius: var(--radius-md);
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.5rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: var(--space-6);
        }

        .tab {
            padding: var(--space-2) var(--space-4);
            font-weight: 600;
            color: var(--gray-600);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition);
        }

        .tab:hover {
            color: var(--gray-900);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn var(--transition);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: var(--space-4);
            overflow-y: auto;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp var(--transition);
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 1;
        }

        .modal-body {
            padding: var(--space-6);
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .table th {
            background: var(--gray-50);
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--border);
        }

        .table td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        /* Quick Actions */
        .quick-actions {
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            display: flex;
            gap: var(--space-2);
            z-index: 20;
        }

        .quick-action-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: var(--white);
            box-shadow: var(--shadow-lg);
            border: none;
            cursor: pointer;
            transition: all var(--transition);
        }

        .quick-action-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes skeleton-loading {
            0% { background-position: 100% 50%; }
            100% { background-position: 0 50%; }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .container {
                padding: 0 var(--space-3);
            }
            
            .modal-content {
                margin: var(--space-2);
                max-height: calc(100vh - var(--space-4));
            }
            
            .modal-header,
            .modal-body {
                padding: var(--space-4);
            }
            
            .quick-actions {
                bottom: var(--space-3);
                right: var(--space-3);
            }
            
            .quick-action-btn {
                width: 44px;
                height: 44px;
            }
        }

        @media (max-width: 480px) {
            .btn {
                padding: var(--space-2) var(--space-3);
                font-size: 0.8125rem;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 2px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-2 max-w-md"></div>

    <!-- Quick Actions -->
    <div class="quick-actions no-print">
        <button class="quick-action-btn" id="quickAddProject" title="Add Project">
            <i class="mdi mdi-plus"></i>
        </button>
        <button class="quick-action-btn" id="quickSync" title="Sync Projects">
            <i class="mdi mdi-sync"></i>
        </button>
        <button class="quick-action-btn" id="quickExport" title="Export PDF">
            <i class="mdi mdi-file-pdf"></i>
        </button>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="py-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <!-- Logo -->
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center shadow-lg">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="w-6 h-6 rounded bg-white opacity-90"></div>
                            <div class="w-6 h-6 rounded bg-white opacity-90"></div>
                            <div class="w-6 h-6 rounded bg-white opacity-90"></div>
                            <div class="w-6 h-6 rounded bg-white opacity-90"></div>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                            TRAci
                        </h1>
                        <p class="text-sm font-semibold text-gray-600 uppercase tracking-wider">
                            Clinical Innovation Platform
                        </p>
                    </div>
                </div>

                <!-- Right Section -->
                <div class="flex flex-col md:flex-row items-stretch md:items-center gap-4 w-full md:w-auto">
                    <!-- Status -->
                    <div id="statusPanel" class="hidden md:flex items-center gap-3 px-4 py-2 bg-white border rounded-full shadow-xs">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-xs font-semibold text-gray-600">LIVE</span>
                        </div>
                        <span class="text-xs text-gray-500">
                            Updated: <span id="lastUpdatedTime" class="font-medium">--:--</span>
                        </span>
                    </div>

                    <!-- Auth -->
                    <div id="authSection">
                        <div id="guestView">
                            <button id="loginBtn" class="btn btn-primary">
                                <i class="mdi mdi-login"></i>
                                <span>Login</span>
                            </button>
                        </div>
                        
                        <div id="userView" class="hidden">
                            <div class="flex items-center gap-3 px-4 py-2 bg-white border rounded-xl shadow-xs hover:shadow-sm transition-shadow">
                                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-semibold text-sm" id="userAvatar">
                                    AA
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold text-gray-900" id="currentUsername">User Name</span>
                                    <span class="text-xs font-medium" id="currentUserRole">Role</span>
                                </div>
                                <button id="logoutBtn" class="btn btn-outline btn-sm" title="Logout">
                                    <i class="mdi mdi-logout text-gray-500"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Guest Welcome -->
        <div id="guestWelcome" class="hidden">
            <div class="card mb-6 border-primary/20 bg-gradient-to-r from-primary/5 to-transparent">
                <div class="card-body">
                    <div class="flex flex-col md:flex-row items-center gap-6">
                        <div class="text-5xl text-primary">
                            <i class="mdi mdi-hand-wave"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-900 mb-2">Welcome to TRAci Platform</h3>
                            <p class="text-gray-600 mb-4">
                                You're viewing our clinical innovation portfolio. Explore tools, review projects, and engage with our research community. 
                                Guest users can comment and view public projects.
                            </p>
                            <div class="flex flex-wrap gap-3">
                                <button id="guestContactBtn" class="btn btn-primary">
                                    <i class="mdi mdi-email-send"></i>
                                    <span>Contact Team</span>
                                </button>
                                <button id="guestLearnBtn" class="btn btn-outline">
                                    <i class="mdi mdi-book-open-variant"></i>
                                    <span>Learn More</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Controls -->
        <div id="adminControls" class="hidden mb-6">
            <div class="flex flex-wrap gap-3">
                <button id="addProjectBtn" class="btn btn-primary">
                    <i class="mdi mdi-plus-circle"></i>
                    <span>Add Project</span>
                </button>
                <button id="addToolBtn" class="btn btn-secondary">
                    <i class="mdi mdi-toolbox"></i>
                    <span>Add Tool</span>
                </button>
                <button id="manageUsersBtn" class="btn btn-outline">
                    <i class="mdi mdi-account-multiple"></i>
                    <span>Manage Users</span>
                </button>
                <button id="syncProjectsBtn" class="btn btn-outline">
                    <i class="mdi mdi-sync"></i>
                    <span>Sync Projects</span>
                </button>
                <button id="viewCodesBtn" class="btn btn-outline">
                    <i class="mdi mdi-key-chain"></i>
                    <span>Edit Codes</span>
                </button>
                <button id="moderateCommentsBtn" class="btn btn-outline">
                    <i class="mdi mdi-comment-processing"></i>
                    <span>Moderate</span>
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div id="statsContainer" class="hidden mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="card hover:shadow-md transition-all duration-300">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-primary-dark flex items-center justify-center text-white">
                                <i class="mdi mdi-toolbox text-xl"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Active Tools</p>
                                <p class="text-2xl font-bold text-gray-900" id="toolsCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card hover:shadow-md transition-all duration-300">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-secondary to-secondary-dark flex items-center justify-center text-white">
                                <i class="mdi mdi-flask-outline text-xl"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Research Projects</p>
                                <p class="text-2xl font-bold text-gray-900" id="projectsCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card hover:shadow-md transition-all duration-300">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-success to-green-600 flex items-center justify-center text-white">
                                <i class="mdi mdi-comment-multiple text-xl"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Total Comments</p>
                                <p class="text-2xl font-bold text-gray-900" id="commentsCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="usersCard" class="card hover:shadow-md transition-all duration-300 hidden">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-accent to-purple-600 flex items-center justify-center text-white">
                                <i class="mdi mdi-shield-account text-xl"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Active Users</p>
                                <p class="text-2xl font-bold text-gray-900" id="usersCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="syncCard" class="card hover:shadow-md transition-all duration-300 hidden">
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-warning to-amber-600 flex items-center justify-center text-white">
                                <i class="mdi mdi-sync text-xl"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Sync Status</p>
                                <p class="text-2xl font-bold text-gray-900" id="syncCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div id="filterControls" class="hidden mb-6">
            <div class="flex flex-wrap gap-2">
                <button class="tab active" data-filter="all">All Projects</button>
                <button class="tab" data-filter="needs_review">Needs Review</button>
                <button class="tab" data-filter="proposals">Proposals</button>
                <button class="tab" data-filter="imported">Imported</button>
                <button class="tab" data-filter="published">Published</button>
                <button class="tab" data-filter="private">Private</button>
                <button class="tab" data-filter="public">Public</button>
                <button class="tab" data-filter="most_commented">Most Comments</button>
            </div>
        </div>

        <!-- Main Content -->
        <div id="contentGrid" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Tools Section -->
                <div class="card">
                    <div class="card-header border-b p-6">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-bold text-gray-900">
                                <i class="mdi mdi-toolbox mr-2 text-primary"></i>
                                Clinical Tools & Resources
                            </h2>
                        </div>
                    </div>
                    <div class="card-body p-6">
                        <div id="toolsGrid" class="space-y-4">
                            <!-- Tools loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Projects Section -->
                <div class="card">
                    <div class="card-header border-b p-6">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-bold text-gray-900">
                                <i class="mdi mdi-flask mr-2 text-primary"></i>
                                Research & Innovation Projects
                            </h2>
                            <span class="text-sm font-semibold text-gray-500" id="projectsCountBadge">
                                <i class="mdi mdi-counter mr-1"></i> 0 projects
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-6">
                        <div id="projectsList" class="space-y-4">
                            <!-- Projects loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Required -->
        <div id="loginRequiredSection" class="hidden">
            <div class="text-center py-16">
                <div class="text-6xl text-primary mb-6">
                    <i class="mdi mdi-shield-lock-outline"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Secure Clinical Innovation Dashboard</h2>
                <p class="text-gray-600 max-w-md mx-auto mb-8">
                    Access to the TRAci Clinical Innovation Platform is restricted to authorized healthcare personnel only. 
                    All accounts must be created and authorized by the system administrator.
                </p>
                <button id="loginRequiredBtn" class="btn btn-primary">
                    <i class="mdi mdi-login"></i>
                    <span>Login to Continue</span>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-6 border-t mt-8">
            <div class="text-center">
                <p class="text-gray-600">
                    <strong>TRAci Clinical Innovation Platform</strong> v3.0 • 
                    <a href="#" id="refreshLink" class="text-primary font-semibold hover:underline">
                        <i class="mdi mdi-refresh"></i>
                        <span>Refresh Data</span>
                    </a>
                </p>
                <p class="text-xs text-gray-400 mt-2">
                    Secure • HIPAA Compliant • Audit Logged
                </p>
            </div>
        </footer>
    </div>

    <!-- ===== ALL MODALS ===== -->
    
    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-bold">
                    <i class="mdi mdi-shield-lock-outline mr-2 text-primary"></i>
                    Secure Login
                </h3>
                <button class="modal-close btn btn-outline btn-sm">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" data-tab="login">Login</button>
                    <button class="tab" data-tab="signup">Sign Up</button>
                    <button class="tab" data-tab="forgot">Forgot Password</button>
                </div>

                <div id="loginForm" class="tab-content active">
                    <div class="form-group">
                        <label for="loginEmail" class="form-label">
                            <i class="mdi mdi-email"></i>
                            Email Address
                        </label>
                        <input type="email" id="loginEmail" class="form-control" 
                               placeholder="your.email@hospital.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword" class="form-label">
                            <i class="mdi mdi-key"></i>
                            Password
                        </label>
                        <input type="password" id="loginPassword" class="form-control" 
                               placeholder="Enter your password" autocomplete="current-password">
                    </div>
                    <button id="submitLogin" class="btn btn-primary w-full">
                        <i class="mdi mdi-login"></i>
                        <span>Sign In</span>
                    </button>
                </div>

                <div id="signupForm" class="tab-content">
                    <div class="form-group">
                        <label for="signupFullName" class="form-label">Full Name *</label>
                        <input type="text" id="signupFullName" class="form-control" 
                               placeholder="Dr. John Smith">
                    </div>
                    <div class="form-group">
                        <label for="signupEmail" class="form-label">Email Address *</label>
                        <input type="email" id="signupEmail" class="form-control" 
                               placeholder="doctor@hospital.com">
                    </div>
                    <div class="form-group">
                        <label for="signupUsername" class="form-label">Username *</label>
                        <input type="text" id="signupUsername" class="form-control" 
                               placeholder="john.smith (no spaces)">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="signupDepartment" class="form-label">Department</label>
                            <select id="signupDepartment" class="form-control">
                                <option value="pulmonology">Pulmonology</option>
                                <option value="cardiology">Cardiology</option>
                                <option value="neurology">Neurology</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="signupRole" class="form-label">Role</label>
                            <select id="signupRole" class="form-control">
                                <option value="doctor">Doctor</option>
                                <option value="researcher">Researcher</option>
                                <option value="guest">Guest</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword" class="form-label">Password *</label>
                        <input type="password" id="signupPassword" class="form-control" 
                               placeholder="Minimum 8 characters">
                    </div>
                    <div class="form-group">
                        <label for="signupConfirmPassword" class="form-label">Confirm Password *</label>
                        <input type="password" id="signupConfirmPassword" class="form-control" 
                               placeholder="Re-enter your password">
                    </div>
                    <button id="submitSignup" class="btn btn-success w-full">
                        <i class="mdi mdi-account-plus"></i>
                        <span>Create Account</span>
                    </button>
                </div>

                <div id="forgotForm" class="tab-content">
                    <div class="form-group">
                        <label for="forgotEmail" class="form-label">Email Address *</label>
                        <input type="email" id="forgotEmail" class="form-control" 
                               placeholder="Enter your registered email">
                    </div>
                    <button id="submitForgot" class="btn btn-warning w-full">
                        <i class="mdi mdi-email-send"></i>
                        <span>Send Reset Link</span>
                    </button>
                </div>

                <div id="loginError" class="alert alert-danger hidden mt-4"></div>
                <div id="signupSuccess" class="alert alert-success hidden mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-bold">
                    <i class="mdi mdi-plus-circle mr-2 text-primary"></i>
                    Add New Project
                </h3>
                <button class="modal-close btn btn-outline btn-sm">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="projectName" class="form-label">Project Name *</label>
                    <input type="text" id="projectName" class="form-control" 
                           placeholder="Enter project name" maxlength="200">
                </div>
                <div class="form-group">
                    <label for="projectDescription" class="form-label">Description</label>
                    <textarea id="projectDescription" class="form-control" 
                              placeholder="Detailed project description..." rows="4"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="projectStatus" class="form-label">Status</label>
                        <select id="projectStatus" class="form-control">
                            <option value="planning">Planning</option>
                            <option value="development" selected>Development</option>
                            <option value="testing">Testing</option>
                            <option value="production">Production</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="projectProgress" class="form-label">Progress (%)</label>
                        <input type="number" id="projectProgress" class="form-control" 
                               min="0" max="100" value="0">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="projectCategory" class="form-label">Category</label>
                        <select id="projectCategory" class="form-control">
                            <option value="clinical_research">Clinical Research</option>
                            <option value="quality_improvement">Quality Improvement</option>
                            <option value="technology">Technology</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="projectPriority" class="form-label">Priority</label>
                        <select id="projectPriority" class="form-control">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="projectVisibility" class="form-label">Visibility</label>
                    <select id="projectVisibility" class="form-control">
                        <option value="public">Public (All users)</option>
                        <option value="private">Private (Team only)</option>
                        <option value="admin_only">Admin Only</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="projectOwner" class="form-label">Project Owner</label>
                    <input type="text" id="projectOwner" class="form-control" 
                           placeholder="Name of lead clinician">
                </div>
                <button id="saveProjectBtn" class="btn btn-primary w-full">
                    <i class="mdi mdi-content-save"></i>
                    <span>Create Project</span>
                </button>
                <div id="projectError" class="alert alert-danger hidden mt-4"></div>
                <div id="projectSuccess" class="alert alert-success hidden mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-bold">
                    <i class="mdi mdi-pencil mr-2 text-primary"></i>
                    Edit Project
                </h3>
                <button class="modal-close btn btn-outline btn-sm">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProjectId">
                
                <div class="form-group">
                    <label for="editProjectName" class="form-label">Project Name *</label>
                    <input type="text" id="editProjectName" class="form-control" 
                           placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label for="editProjectDescription" class="form-label">Description</label>
                    <textarea id="editProjectDescription" class="form-control" 
                              placeholder="Project description" rows="4"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="editProjectStatus" class="form-label">Status</label>
                        <select id="editProjectStatus" class="form-control">
                            <option value="planning">Planning</option>
                            <option value="development">Development</option>
                            <option value="testing">Testing</option>
                            <option value="production">Production</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editProjectProgress" class="form-label">Progress (%)</label>
                        <input type="number" id="editProjectProgress" class="form-control" 
                               min="0" max="100" value="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editProjectOwner" class="form-label">Project Owner</label>
                    <input type="text" id="editProjectOwner" class="form-control" 
                           placeholder="Name of lead clinician">
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button id="updateProjectBtn" class="btn btn-primary flex-1">
                        <i class="mdi mdi-content-save"></i>
                        <span>Update Project</span>
                    </button>
                    <button id="deleteProjectBtn" class="btn btn-danger flex-1">
                        <i class="mdi mdi-delete"></i>
                        <span>Delete Project</span>
                    </button>
                </div>
                <div id="editProjectError" class="alert alert-danger hidden mt-4"></div>
                <div id="editProjectSuccess" class="alert alert-success hidden mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Add Tool Modal -->
    <div id="addToolModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-bold">
                    <i class="mdi mdi-toolbox mr-2 text-primary"></i>
                    Add New Tool
                </h3>
                <button class="modal-close btn btn-outline btn-sm">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="toolName" class="form-label">Tool Name *</label>
                    <input type="text" id="toolName" class="form-control" 
                           placeholder="Enter tool name" maxlength="200">
                </div>
                <div class="form-group">
                    <label for="toolDescription" class="form-label">Description</label>
                    <textarea id="toolDescription" class="form-control" 
                              placeholder="Detailed tool description..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="toolUrl" class="form-label">URL *</label>
                    <input type="url" id="toolUrl" class="form-control" 
                           placeholder="https://tool.example.com">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="toolStatus" class="form-label">Status</label>
                        <select id="toolStatus" class="form-control">
                            <option value="operational">Operational</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="deprecated">Deprecated</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="toolCategory" class="form-label">Category</label>
                        <select id="toolCategory" class="form-control">
                            <option value="clinical">Clinical Tools</option>
                            <option value="research">Research Tools</option>
                            <option value="administrative">Administrative</option>
                        </select>
                    </div>
                </div>
                
                <button id="saveToolBtn" class="btn btn-primary w-full">
                    <i class="mdi mdi-content-save"></i>
                    <span>Save Tool</span>
                </button>
                <div id="toolError" class="alert alert-danger hidden mt-4"></div>
                <div id="toolSuccess" class="alert alert-success hidden mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Manage Users Modal -->
    <div id="manageUsersModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="text-lg font-bold">
                    <i class="mdi mdi-account-multiple mr-2 text-primary"></i>
                    User Management
                </h3>
                <button class="modal-close btn btn-outline btn-sm">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="mb-6">
                    <button id="addUserBtn" class="btn btn-success">
                        <i class="mdi mdi-account-plus"></i>
                        <span>Add New User</span>
                    </button>
                </div>
                
                <div class="form-group">
                    <input type="text" id="userSearch" class="form-control" 
                           placeholder="Search users by name, username, or role...">
                </div>
                
                <div class="overflow-auto max-h-96 border rounded-lg">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userFormModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-bold" id="userFormTitle">
                    <i class="mdi mdi-account-plus mr-2 text-primary"></i>
                    Add New User
                </h3>
                <button class="modal-close btn btn-outline btn-sm">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                
                <div class="form-group">
                    <label for="userFullName" class="form-label">Full Name *</label>
                    <input type="text" id="userFullName" class="form-control" 
                           placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label for="userUsername" class="form-label">Username *</label>
                    <input type="text" id="userUsername" class="form-control" 
                           placeholder="Enter username (lowercase, no spaces)">
                </div>
                <div class="form-group">
                    <label for="userEmail" class="form-label">Email Address</label>
                    <input type="email" id="userEmail" class="form-control" 
                           placeholder="email@hospital.com">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="userRole" class="form-label">Role *</label>
                        <select id="userRole" class="form-control">
                            <option value="admin">Administrator</option>
                            <option value="doctor">Doctor/Clinician</option>
                            <option value="researcher">Researcher</option>
                            <option value="guest">Guest</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userDepartment" class="form-label">Department</label>
                        <select id="userDepartment" class="form-control">
                            <option value="pulmonology">Pulmonology</option>
                            <option value="cardiology">Cardiology</option>
                            <option value="neurology">Neurology</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="userPassword" class="form-label">Password *</label>
                    <div class="flex gap-2">
                        <input type="text" id="userPassword" class="form-control" 
                               placeholder="Auto-generated password" readonly>
                        <button type="button" id="generatePasswordBtn" class="btn btn-outline">
                            <i class="mdi mdi-refresh"></i>
                            <span>Generate</span>
                        </button>
                    </div>
                </div>
                
                <button id="saveUserBtn" class="btn btn-primary w-full">
                    <i class="mdi mdi-content-save"></i>
                    <span id="saveUserBtnText">Create User</span>
                </button>
                <div id="userError" class="alert alert-danger hidden mt-4"></div>
                <div id="userSuccess" class="alert alert-success hidden mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Sync Projects Modal -->
    <div id="syncProjectsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="text-lg font-bold">
                    <i class="mdi mdi-sync mr-2 text-primary"></i>
                    Sync with ThoraxLab
                </h3>
                <button class="modal-close btn btn-outline btn-sm">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="syncDirection" class="form-label">Sync Direction</label>
                        <select id="syncDirection" class="form-control">
                            <option value="import">Import from ThoraxLab</option>
                            <option value="export">Export to ThoraxLab</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="syncProjectSelect" class="form-label">Project</label>
                        <select id="syncProjectSelect" class="form-control">
                            <option value="">-- Select Project --</option>
                        </select>
                    </div>
                </div>
                
                <button id="startSyncBtn" class="btn btn-primary w-full mt-6">
                    <i class="mdi mdi-sync"></i>
                    <span id="startSyncText">Start Sync</span>
                </button>
                <div id="syncError" class="alert alert-danger hidden mt-4"></div>
                <div id="syncSuccess" class="alert alert-success hidden mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Comments Modal -->
    <div id="commentsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="text-lg font-bold" id="commentsModalTitle">
                    <i class="mdi mdi-comment-multiple mr-2 text-primary"></i>
                    Project Comments
                </h3>
                <button class="modal-close btn btn-outline btn-sm">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="commentFormSection" class="hidden">
                    <div class="form-group">
                        <label for="commentText" class="form-label">Add a comment</label>
                        <textarea id="commentText" class="form-control" 
                                  placeholder="Share your thoughts, feedback, or questions..." rows="3"
                                  maxlength="1000"></textarea>
                    </div>
                    
                    <div id="guestEmailField" class="form-group hidden">
                        <label for="guestEmail" class="form-label">
                            <i class="mdi mdi-email"></i>
                            <span>Your Email *</span>
                        </label>
                        <input type="email" id="guestEmail" class="form-control" 
                               placeholder="email@example.com">
                    </div>
                    
                    <button id="submitCommentBtn" class="btn btn-primary w-full">
                        <i class="mdi mdi-send"></i>
                        <span>Post Comment</span>
                    </button>
                    <div id="commentError" class="alert alert-danger hidden mt-4"></div>
                    <div id="commentSuccess" class="alert alert-success hidden mt-4"></div>
                </div>
                
                <div id="commentsList" class="mt-6 space-y-4 max-h-96 overflow-y-auto">
                    <!-- Comments loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Moderate Comments Modal -->
    <div id="moderateCommentsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="text-lg font-bold">
                    <i class="mdi mdi-comment-processing mr-2 text-primary"></i>
                    Moderate Comments
                </h3>
                <button class="modal-close btn btn-outline btn-sm">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="moderationSearch" class="form-control" 
                           placeholder="Search comments...">
                </div>
                
                <div id="moderationList" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Pending comments loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Export Modal -->
    <div id="pdfExportModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-bold">
                    <i class="mdi mdi-file-pdf mr-2 text-primary"></i>
                    Export Project to PDF
                </h3>
                <button class="modal-close btn btn-outline btn-sm">
                    <i class="mdi mdi-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="pdfProjectSelect" class="form-label">Select Project</label>
                    <select id="pdfProjectSelect" class="form-control">
                        <option value="">-- Choose a project --</option>
                    </select>
                </div>
                
                <button id="generatePDFBtn" class="btn btn-danger w-full mt-6">
                    <i class="mdi mdi-file-pdf-box"></i>
                    <span>Generate & Download PDF</span>
                </button>
                <div id="pdfError" class="alert alert-danger hidden mt-4"></div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ===== CONFIGURATION =====
        const SUPABASE_URL = 'https://bledpouekiytppuhxeqq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_zdlIM8UbOrRIFpmYLJOmWQ_4QqNi_5C';

        // ===== SUPABASE INIT =====
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== STATE MANAGEMENT =====
        let currentUser = null;
        let authToken = localStorage.getItem('traci_auth_token');
        let dashboardData = {
            projects: [],
            tools: [],
            users: [],
            filteredProjects: [],
            lastUpdated: new Date()
        };
        let currentProjectComments = null;
        let commentCounts = {};
        let pendingComments = [];

        // ===== TOAST SYSTEM =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-lg shadow-lg mb-2 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'} text-white`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="mdi mdi-${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'information'}"></i>
                    <span>${message}</span>
                </div>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // ===== PASSWORD UTILITIES =====
        function generatePassword(length = 12) {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < length; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return password;
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ===== AUTHENTICATION =====
        async function loginUser(email, password) {
            try {
                const hashedPassword = await hashPassword(password);
                
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('email', email.toLowerCase().trim())
                    .single();
                
                if (error || !data) {
                    throw new Error('Invalid email or password');
                }
                
                if (data.encrypted_password !== hashedPassword) {
                    throw new Error('Invalid email or password');
                }
                
                currentUser = {
                    id: data.id,
                    username: data.username || data.email.split('@')[0],
                    full_name: data.full_name || 'User',
                    role: data.role || 'guest',
                    department: data.department || '',
                    email: data.email
                };
                
                authToken = btoa(JSON.stringify(currentUser));
                localStorage.setItem('traci_auth_token', authToken);
                
                showToast('Login successful!', 'success');
                return true;
                
            } catch (error) {
                showToast(error.message, 'error');
                return false;
            }
        }

        async function signUpUser(userData) {
            try {
                if (userData.password !== userData.confirmPassword) {
                    throw new Error('Passwords do not match');
                }
                
                if (userData.password.length < 8) {
                    throw new Error('Password must be at least 8 characters');
                }
                
                const hashedPassword = await hashPassword(userData.password);
                
                const newUser = {
                    username: userData.username.toLowerCase(),
                    full_name: userData.full_name,
                    email: userData.email,
                    role: userData.role,
                    department: userData.department,
                    encrypted_password: hashedPassword,
                    status: 'pending',
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabaseClient
                    .from('users')
                    .insert([newUser])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('Account created! Pending admin approval.', 'success');
                return { success: true, data };
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        async function sendPasswordReset(email) {
            try {
                // Simulate sending reset email
                showToast('Reset link would be sent to ' + email, 'info');
                return { success: true };
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        function logoutUser() {
            currentUser = null;
            authToken = null;
            localStorage.removeItem('traci_auth_token');
            updateAuthUI();
            showLoginRequired();
            showToast('Logged out successfully', 'info');
        }

        // ===== DATABASE FUNCTIONS =====
        async function fetchProjects() {
            try {
                let query = supabaseClient
                    .from('projects')
                    .select('*');
                
                if (currentUser) {
                    if (currentUser.role === 'guest') {
                        query = query.eq('visibility', 'public');
                    } else if (currentUser.role === 'doctor' || currentUser.role === 'researcher') {
                        query = query.in('visibility', ['public', 'private']);
                    }
                }
                
                const { data, error } = await query
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                return data || [];
            } catch (error) {
                console.error('Error fetching projects:', error);
                return [];
            }
        }

        async function addProject(projectData) {
            try {
                const projectToInsert = {
                    name: projectData.name,
                    description: projectData.description,
                    status: projectData.status,
                    progress: projectData.progress,
                    category: projectData.category,
                    priority: projectData.priority,
                    visibility: projectData.visibility,
                    owner: projectData.owner,
                    edit_code: Math.floor(10000 + Math.random() * 90000).toString(),
                    created_at: new Date().toISOString(),
                    last_updated: new Date().toISOString()
                };
                
                const { data, error } = await supabaseClient
                    .from('projects')
                    .insert([projectToInsert])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('Project created successfully!', 'success');
                return { success: true, data };
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        async function updateProject(projectId, projectData) {
            try {
                const { data, error } = await supabaseClient
                    .from('projects')
                    .update({
                        name: projectData.name,
                        description: projectData.description,
                        status: projectData.status,
                        progress: projectData.progress,
                        owner: projectData.owner,
                        last_updated: new Date().toISOString()
                    })
                    .eq('id', projectId)
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('Project updated successfully!', 'success');
                return { success: true, data };
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        async function deleteProject(projectId) {
            try {
                const { error } = await supabaseClient
                    .from('projects')
                    .delete()
                    .eq('id', projectId);
                
                if (error) throw error;
                
                showToast('Project deleted successfully!', 'success');
                return { success: true };
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        async function fetchTools() {
            try {
                const { data, error } = await supabaseClient
                    .from('tools')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error fetching tools:', error);
                return [];
            }
        }

        async function addTool(toolData) {
            try {
                const toolToInsert = {
                    name: toolData.name,
                    description: toolData.description,
                    url: toolData.url,
                    status: toolData.status,
                    category: toolData.category,
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabaseClient
                    .from('tools')
                    .insert([toolToInsert])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('Tool added successfully!', 'success');
                return { success: true, data };
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        async function fetchUsers() {
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error fetching users:', error);
                return [];
            }
        }

        async function createUser(userData) {
            try {
                const hashedPassword = await hashPassword(userData.password);
                
                const userToInsert = {
                    username: userData.username.toLowerCase(),
                    full_name: userData.full_name,
                    email: userData.email,
                    role: userData.role,
                    department: userData.department,
                    encrypted_password: hashedPassword,
                    status: 'active',
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabaseClient
                    .from('users')
                    .insert([userToInsert])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('User created successfully!', 'success');
                return { success: true, data, password: userData.password };
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        async function fetchCommentCounts() {
            try {
                const { data, error } = await supabaseClient
                    .from('audit_logs')
                    .select('project_id')
                    .eq('action', 'comment_added');
                
                if (error) throw error;
                
                const counts = {};
                if (data) {
                    data.forEach(log => {
                        if (log.project_id) {
                            counts[log.project_id] = (counts[log.project_id] || 0) + 1;
                        }
                    });
                }
                return counts;
            } catch (error) {
                console.error('Error fetching comment counts:', error);
                return {};
            }
        }

        // ===== UI MANAGEMENT =====
        function updateAuthUI() {
            const guestView = document.getElementById('guestView');
            const userView = document.getElementById('userView');
            const loginRequiredSection = document.getElementById('loginRequiredSection');
            const statsContainer = document.getElementById('statsContainer');
            const adminControls = document.getElementById('adminControls');
            const contentGrid = document.getElementById('contentGrid');
            const guestWelcome = document.getElementById('guestWelcome');
            const statusPanel = document.getElementById('statusPanel');
            const filterControls = document.getElementById('filterControls');
            const usersCard = document.getElementById('usersCard');
            const syncCard = document.getElementById('syncCard');
            
            if (currentUser) {
                guestView.classList.add('hidden');
                userView.classList.remove('hidden');
                loginRequiredSection.classList.add('hidden');
                
                const avatar = document.getElementById('userAvatar');
                const name = currentUser.full_name || currentUser.username;
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                avatar.textContent = initials;
                
                document.getElementById('currentUsername').textContent = name;
                document.getElementById('currentUserRole').textContent = currentUser.role;
                
                statusPanel.classList.remove('hidden');
                statsContainer.classList.remove('hidden');
                contentGrid.classList.remove('hidden');
                filterControls.classList.remove('hidden');
                
                if (currentUser.role === 'guest') {
                    guestWelcome.classList.remove('hidden');
                    adminControls.classList.add('hidden');
                    usersCard.classList.add('hidden');
                    syncCard.classList.add('hidden');
                } else {
                    guestWelcome.classList.add('hidden');
                    
                    if (currentUser.role === 'admin') {
                        adminControls.classList.remove('hidden');
                        usersCard.classList.remove('hidden');
                        syncCard.classList.remove('hidden');
                    } else {
                        adminControls.classList.add('hidden');
                        usersCard.classList.add('hidden');
                        syncCard.classList.add('hidden');
                    }
                }
                
                initDashboard();
                
            } else {
                guestView.classList.remove('hidden');
                userView.classList.add('hidden');
                adminControls.classList.add('hidden');
                guestWelcome.classList.add('hidden');
                statusPanel.classList.add('hidden');
                filterControls.classList.add('hidden');
                showLoginRequired();
            }
        }

        function showLoginRequired() {
            document.getElementById('loginRequiredSection').classList.remove('hidden');
            document.getElementById('statsContainer').classList.add('hidden');
            document.getElementById('adminControls').classList.add('hidden');
            document.getElementById('contentGrid').classList.add('hidden');
            document.getElementById('guestWelcome').classList.add('hidden');
            document.getElementById('filterControls').classList.add('hidden');
        }

        // ===== MODAL MANAGEMENT =====
        function showModal(modalName) {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
            
            const modal = document.getElementById(modalName);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function hideAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
            document.body.style.overflow = 'auto';
            clearFormMessages();
        }

        function clearFormMessages() {
            document.querySelectorAll('.alert').forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });
        }

        // ===== DASHBOARD FUNCTIONS =====
        async function initDashboard() {
            showSkeletonLoading();
            
            try {
                const [projects, tools, users, commentCountsData] = await Promise.all([
                    fetchProjects(),
                    fetchTools(),
                    fetchUsers(),
                    fetchCommentCounts()
                ]);
                
                dashboardData.projects = projects;
                dashboardData.tools = tools;
                dashboardData.users = users;
                dashboardData.filteredProjects = [...projects];
                commentCounts = commentCountsData;
                
                updateStats();
                renderDashboard();
                updateTimestamp();
                
                // Hide skeletons
                setTimeout(() => {
                    document.querySelectorAll('.skeleton').forEach(el => {
                        el.style.display = 'none';
                    });
                }, 800);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Failed to load dashboard data', 'error');
            }
        }

        function showSkeletonLoading() {
            const toolsGrid = document.getElementById('toolsGrid');
            const projectsList = document.getElementById('projectsList');
            
            toolsGrid.innerHTML = `
                <div class="space-y-4">
                    ${Array(3).fill().map(() => `
                        <div class="skeleton p-4 rounded-lg">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text" style="width: 75%;"></div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            projectsList.innerHTML = `
                <div class="space-y-4">
                    ${Array(3).fill().map(() => `
                        <div class="skeleton p-4 rounded-lg">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text" style="width: 75%;"></div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateStats() {
            const toolsCount = dashboardData.tools.length;
            const projectsCount = dashboardData.projects.length;
            const usersCount = dashboardData.users.filter(u => u.status === 'active').length;
            
            let totalComments = 0;
            Object.values(commentCounts).forEach(count => {
                totalComments += count;
            });
            
            const syncedProjects = dashboardData.projects.filter(p => 
                p.description && p.description.includes('[Imported from ThoraxLab]')
            ).length;
            
            document.getElementById('toolsCount').textContent = toolsCount;
            document.getElementById('projectsCount').textContent = projectsCount;
            document.getElementById('commentsCount').textContent = totalComments;
            document.getElementById('usersCount').textContent = usersCount;
            document.getElementById('syncCount').textContent = syncedProjects;
            
            document.getElementById('projectsCountBadge').innerHTML = `
                <i class="mdi mdi-counter mr-1"></i> ${projectsCount} projects
            `;
        }

        function renderDashboard() {
            renderTools();
            renderProjects();
        }

        function renderTools() {
            const toolsGrid = document.getElementById('toolsGrid');
            
            if (dashboardData.tools.length === 0) {
                toolsGrid.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="mdi mdi-toolbox-outline text-4xl mb-4"></i>
                        <p>No tools available</p>
                    </div>
                `;
                return;
            }
            
            let toolsHTML = '';
            
            dashboardData.tools.forEach(tool => {
                const statusClass = `badge ${tool.status === 'operational' ? 'badge-success' : 
                                   tool.status === 'maintenance' ? 'badge-warning' : 'badge-outline'}`;
                
                toolsHTML += `
                    <div class="card hover:shadow-md transition-all duration-300">
                        <div class="card-body">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-primary to-primary-dark flex items-center justify-center text-white flex-shrink-0">
                                    <i class="mdi mdi-toolbox text-xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between gap-2 mb-2">
                                        <h3 class="font-bold text-gray-900 truncate">${tool.name}</h3>
                                        <span class="${statusClass}">${tool.status}</span>
                                    </div>
                                    <p class="text-gray-600 text-sm mb-4">${tool.description || 'No description available'}</p>
                                    <div class="flex items-center justify-between">
                                        <a href="${tool.url}" target="_blank" class="btn btn-outline btn-sm">
                                            <i class="mdi mdi-open-in-new"></i>
                                            Access Tool
                                        </a>
                                        <span class="text-xs font-medium text-gray-500">
                                            ${tool.category || 'General'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            toolsGrid.innerHTML = toolsHTML;
        }

        function renderProjects() {
            const projectsList = document.getElementById('projectsList');
            const filteredProjects = dashboardData.filteredProjects;
            
            if (filteredProjects.length === 0) {
                projectsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="mdi mdi-flask-outline text-4xl mb-4"></i>
                        <p>No projects found</p>
                    </div>
                `;
                return;
            }
            
            let projectsHTML = '';
            
            filteredProjects.forEach(project => {
                const commentCount = commentCounts[project.id] || 0;
                const priorityClass = project.priority === 'critical' ? 'badge-danger' :
                                   project.priority === 'high' ? 'badge-warning' :
                                   project.priority === 'medium' ? 'badge-outline' : 'badge-outline';
                
                projectsHTML += `
                    <div class="card hover:shadow-md transition-all duration-300" data-project-id="${project.id}">
                        <div class="card-body">
                            <!-- Header -->
                            <div class="flex items-start justify-between gap-4 mb-4">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="font-bold text-gray-900 truncate">${project.name}</h3>
                                        ${project.visibility === 'private' ? 
                                            '<span class="badge badge-outline">Private</span>' : ''}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="badge ${priorityClass}">${project.priority}</span>
                                        <span class="badge badge-outline">${project.status}</span>
                                        ${commentCount > 0 ? 
                                            `<span class="badge badge-outline">
                                                <i class="mdi mdi-comment"></i> ${commentCount}
                                            </span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <p class="text-gray-600 text-sm mb-4">${project.description || 'No description available'}</p>
                            
                            <!-- Progress -->
                            <div class="mb-4">
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="font-medium text-gray-700">Progress</span>
                                    <span class="font-bold text-primary">${project.progress || 0}%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                                </div>
                            </div>
                            
                            <!-- Feedback Channels -->
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-sm font-medium text-gray-700">Share Feedback:</span>
                                <div class="flex gap-2">
                                    <a href="https://wa.me/?text=Project: ${encodeURIComponent(project.name)}" 
                                       class="channel-btn whatsapp" target="_blank" title="WhatsApp">
                                        <i class="mdi mdi-whatsapp"></i>
                                    </a>
                                    <a href="mailto:?subject=Project: ${encodeURIComponent(project.name)}" 
                                       class="channel-btn email" title="Email">
                                        <i class="mdi mdi-email"></i>
                                    </a>
                                    <button class="channel-btn github" title="GitHub" onclick="showToast('GitHub integration coming soon', 'info')">
                                        <i class="mdi mdi-github"></i>
                                    </button>
                                    <button class="channel-btn discord" title="Discord" onclick="showToast('Discord integration coming soon', 'info')">
                                        <i class="mdi mdi-discord"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex flex-wrap gap-2">
                                ${currentUser && currentUser.role === 'admin' ? `
                                    <button class="btn btn-outline btn-sm flex-1" onclick="editProject('${project.id}')">
                                        <i class="mdi mdi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-outline btn-sm flex-1" onclick="showComments('${project.id}')">
                                        <i class="mdi mdi-comment"></i> Comments
                                    </button>
                                    <button class="btn btn-outline btn-sm flex-1" onclick="exportProject('${project.id}')">
                                        <i class="mdi mdi-file-pdf"></i> PDF
                                    </button>
                                ` : currentUser && currentUser.role === 'doctor' ? `
                                    <button class="btn btn-outline btn-sm flex-1" onclick="editProjectWithCode('${project.id}')">
                                        <i class="mdi mdi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-outline btn-sm flex-1" onclick="showComments('${project.id}')">
                                        <i class="mdi mdi-comment"></i> Comments
                                    </button>
                                ` : `
                                    <button class="btn btn-outline btn-sm flex-1" onclick="showComments('${project.id}')">
                                        <i class="mdi mdi-comment"></i> Comments
                                    </button>
                                    <button class="btn btn-outline btn-sm flex-1" onclick="upvoteProject('${project.id}')">
                                        <i class="mdi mdi-thumb-up"></i> Upvote
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            projectsList.innerHTML = projectsHTML;
        }

        // ===== HELPER FUNCTIONS =====
        function updateTimestamp() {
            if (!currentUser) return;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
            
            document.getElementById('lastUpdatedTime').textContent = timeString;
            dashboardData.lastUpdated = now;
        }

        // ===== FILTER FUNCTIONS =====
        function filterProjects(filterType) {
            document.querySelectorAll('.tab[data-filter]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            switch (filterType) {
                case 'all':
                    dashboardData.filteredProjects = [...dashboardData.projects];
                    break;
                case 'needs_review':
                    dashboardData.filteredProjects = dashboardData.projects.filter(p => 
                        p.needs_feedback
                    );
                    break;
                case 'proposals':
                    dashboardData.filteredProjects = dashboardData.projects.filter(p => 
                        p.review_status === 'pending'
                    );
                    break;
                case 'imported':
                    dashboardData.filteredProjects = dashboardData.projects.filter(p => 
                        p.description && p.description.includes('[Imported from ThoraxLab]')
                    );
                    break;
                case 'published':
                    dashboardData.filteredProjects = dashboardData.projects.filter(p => 
                        !(p.description && p.description.includes('[Imported from ThoraxLab]'))
                    );
                    break;
                case 'private':
                    dashboardData.filteredProjects = dashboardData.projects.filter(p => 
                        p.visibility === 'private'
                    );
                    break;
                case 'public':
                    dashboardData.filteredProjects = dashboardData.projects.filter(p => 
                        p.visibility === 'public'
                    );
                    break;
                case 'most_commented':
                    dashboardData.filteredProjects = [...dashboardData.projects].sort((a, b) => {
                        return (commentCounts[b.id] || 0) - (commentCounts[a.id] || 0);
                    });
                    break;
            }
            
            renderProjects();
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            // Load stored user
            if (authToken) {
                try {
                    currentUser = JSON.parse(atob(authToken));
                } catch (e) {
                    localStorage.removeItem('traci_auth_token');
                }
            }
            
            updateAuthUI();
            
            // Setup tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    document.getElementById(tabId + 'Form').classList.add('active');
                    clearFormMessages();
                });
            });
            
            // Login
            document.getElementById('loginBtn').addEventListener('click', () => showModal('loginModal'));
            document.getElementById('loginRequiredBtn').addEventListener('click', () => showModal('loginModal'));
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
            
            // Guest buttons
            document.getElementById('guestContactBtn').addEventListener('click', () => {
                window.open('mailto:pneumology.innovation@hospital.com?subject=TRAci Platform Inquiry');
            });
            
            document.getElementById('guestLearnBtn').addEventListener('click', () => {
                showToast('TRAci Platform: Clinical innovation management system', 'info');
            });
            
            // Quick actions
            document.getElementById('quickAddProject').addEventListener('click', () => {
                if (currentUser && currentUser.role === 'admin') {
                    showModal('addProjectModal');
                } else {
                    showToast('Admin access required', 'warning');
                }
            });
            
            document.getElementById('quickSync').addEventListener('click', () => {
                if (currentUser && currentUser.role === 'admin') {
                    showModal('syncProjectsModal');
                } else {
                    showToast('Admin access required', 'warning');
                }
            });
            
            document.getElementById('quickExport').addEventListener('click', () => {
                showModal('pdfExportModal');
            });
            
            // Modal close
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', hideAllModals);
            });
            
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) hideAllModals();
                });
            });
            
            // Login form
            document.getElementById('submitLogin').addEventListener('click', async function() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                
                if (!email || !password) {
                    showToast('Please enter both email and password', 'warning');
                    return;
                }
                
                this.innerHTML = '<span class="loading-spinner"></span> Signing In...';
                this.disabled = true;
                
                const success = await loginUser(email, password);
                
                this.innerHTML = '<i class="mdi mdi-login"></i> Sign In';
                this.disabled = false;
                
                if (success) {
                    hideAllModals();
                    updateAuthUI();
                }
            });
            
            // Signup form
            document.getElementById('submitSignup').addEventListener('click', async function() {
                const userData = {
                    full_name: document.getElementById('signupFullName').value.trim(),
                    email: document.getElementById('signupEmail').value.trim(),
                    username: document.getElementById('signupUsername').value.trim(),
                    department: document.getElementById('signupDepartment').value,
                    role: document.getElementById('signupRole').value,
                    password: document.getElementById('signupPassword').value,
                    confirmPassword: document.getElementById('signupConfirmPassword').value
                };
                
                this.innerHTML = '<span class="loading-spinner"></span> Creating...';
                this.disabled = true;
                
                const result = await signUpUser(userData);
                
                this.innerHTML = '<i class="mdi mdi-account-plus"></i> Create Account';
                this.disabled = false;
                
                if (result.success) {
                    document.getElementById('signupSuccess').textContent = 'Account created! Pending admin approval.';
                    document.getElementById('signupSuccess').classList.remove('hidden');
                    
                    setTimeout(() => {
                        document.querySelector('.tab[data-tab="login"]').click();
                    }, 3000);
                }
            });
            
            // Forgot password
            document.getElementById('submitForgot').addEventListener('click', async function() {
                const email = document.getElementById('forgotEmail').value.trim();
                
                if (!email) {
                    showToast('Please enter your email', 'warning');
                    return;
                }
                
                this.innerHTML = '<span class="loading-spinner"></span> Sending...';
                this.disabled = true;
                
                await sendPasswordReset(email);
                
                this.innerHTML = '<i class="mdi mdi-email-send"></i> Send Reset Link';
                this.disabled = false;
            });
            
            // Admin buttons
            document.getElementById('addProjectBtn').addEventListener('click', () => showModal('addProjectModal'));
            document.getElementById('addToolBtn').addEventListener('click', () => showModal('addToolModal'));
            document.getElementById('manageUsersBtn').addEventListener('click', () => {
                loadUsersTable();
                showModal('manageUsersModal');
            });
            document.getElementById('syncProjectsBtn').addEventListener('click', () => showModal('syncProjectsModal'));
            document.getElementById('viewCodesBtn').addEventListener('click', () => showToast('Edit codes feature', 'info'));
            document.getElementById('moderateCommentsBtn').addEventListener('click', () => showModal('moderateCommentsModal'));
            
            // Filter controls
            document.querySelectorAll('.tab[data-filter]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const filterType = this.dataset.filter;
                    filterProjects(filterType);
                });
            });
            
            // Add Project
            document.getElementById('saveProjectBtn').addEventListener('click', async function() {
                const projectData = {
                    name: document.getElementById('projectName').value.trim(),
                    description: document.getElementById('projectDescription').value.trim(),
                    status: document.getElementById('projectStatus').value,
                    progress: parseInt(document.getElementById('projectProgress').value) || 0,
                    category: document.getElementById('projectCategory').value,
                    priority: document.getElementById('projectPriority').value,
                    visibility: document.getElementById('projectVisibility').value,
                    owner: document.getElementById('projectOwner').value.trim()
                };
                
                if (!projectData.name) {
                    showToast('Project name is required', 'warning');
                    return;
                }
                
                this.innerHTML = '<span class="loading-spinner"></span> Creating...';
                this.disabled = true;
                
                const result = await addProject(projectData);
                
                this.innerHTML = '<i class="mdi mdi-content-save"></i> Create Project';
                this.disabled = false;
                
                if (result.success) {
                    hideAllModals();
                    await initDashboard();
                }
            });
            
            // Add User
            document.getElementById('addUserBtn').addEventListener('click', () => {
                document.getElementById('userFormTitle').textContent = 'Add New User';
                document.getElementById('saveUserBtnText').textContent = 'Create User';
                document.getElementById('editUserId').value = '';
                document.getElementById('userFullName').value = '';
                document.getElementById('userUsername').value = '';
                document.getElementById('userEmail').value = '';
                document.getElementById('userRole').value = 'doctor';
                document.getElementById('userDepartment').value = 'pulmonology';
                document.getElementById('userPassword').value = generatePassword();
                showModal('userFormModal');
            });
            
            document.getElementById('generatePasswordBtn').addEventListener('click', () => {
                document.getElementById('userPassword').value = generatePassword();
            });
            
            document.getElementById('saveUserBtn').addEventListener('click', async function() {
                const userData = {
                    full_name: document.getElementById('userFullName').value.trim(),
                    username: document.getElementById('userUsername').value.trim().toLowerCase(),
                    email: document.getElementById('userEmail').value.trim(),
                    role: document.getElementById('userRole').value,
                    department: document.getElementById('userDepartment').value,
                    password: document.getElementById('userPassword').value
                };
                
                if (!userData.full_name || !userData.username || !userData.password) {
                    showToast('Full name, username, and password are required', 'warning');
                    return;
                }
                
                this.innerHTML = '<span class="loading-spinner"></span> Saving...';
                this.disabled = true;
                
                const result = await createUser(userData);
                
                this.innerHTML = '<i class="mdi mdi-content-save"></i> Create User';
                this.disabled = false;
                
                if (result.success) {
                    hideAllModals();
                    loadUsersTable();
                }
            });
            
            // Refresh link
            document.getElementById('refreshLink').addEventListener('click', async function(e) {
                e.preventDefault();
                if (!currentUser) return;
                
                this.innerHTML = '<span class="loading-spinner"></span> Refreshing...';
                await initDashboard();
                this.innerHTML = '<i class="mdi mdi-refresh"></i> Refresh Data';
                
                showToast('Data refreshed', 'success');
            });
            
            // Auto-refresh
            setInterval(async () => {
                if (currentUser) {
                    await initDashboard();
                }
            }, 10 * 60 * 1000);
        });

        // ===== USERS TABLE =====
        async function loadUsersTable() {
            try {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                if (dashboardData.users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-500">
                                No users found
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                dashboardData.users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="font-medium">${user.full_name || user.email}</div>
                            <div class="text-xs text-gray-500">${user.department || ''}</div>
                        </td>
                        <td>
                            <code class="text-sm bg-gray-100 px-2 py-1 rounded">${user.username}</code>
                        </td>
                        <td>
                            <span class="badge ${user.role === 'admin' ? 'badge-danger' : user.role === 'doctor' ? 'badge-primary' : 'badge-outline'}">
                                ${user.role}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${user.status === 'active' ? 'badge-success' : 'badge-outline'}">
                                ${user.status}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="editUser('${user.id}')">
                                <i class="mdi mdi-pencil"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading users table:', error);
            }
        }

        // ===== GLOBAL FUNCTIONS =====
        window.editProject = function(projectId) {
            const project = dashboardData.projects.find(p => p.id === projectId);
            if (project) {
                document.getElementById('editProjectId').value = project.id;
                document.getElementById('editProjectName').value = project.name;
                document.getElementById('editProjectDescription').value = project.description || '';
                document.getElementById('editProjectStatus').value = project.status;
                document.getElementById('editProjectProgress').value = project.progress || 0;
                document.getElementById('editProjectOwner').value = project.owner || '';
                showModal('editProjectModal');
            }
        };
        
        window.editProjectWithCode = function(projectId) {
            showToast('Edit code required for doctors', 'info');
        };
        
        window.showComments = function(projectId) {
            showToast('Comments feature', 'info');
        };
        
        window.exportProject = function(projectId) {
            showModal('pdfExportModal');
        };
        
        window.upvoteProject = function(projectId) {
            showToast('Project upvoted!', 'success');
        };
        
        window.editUser = function(userId) {
            showToast('Edit user feature', 'info');
        };
    </script>
</body>
</html>
